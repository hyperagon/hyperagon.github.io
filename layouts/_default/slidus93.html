<!--
Copyright (c) 2026 Hyperagon

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
-->
<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>Slidus 9.3</title><style>:root{--bg-color:#1e1e24;--text-color:#e0e0e0;--accent-color:#4a90e2;--accent-hover:#357abd;--danger-color:#e74c3c;--border-color:#444450;--toolbar-width:280px;--control-color:#e74c3c;--panel-bg:#2a2a32}body,html{margin:0;padding:0;width:100%;height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background-color:var(--bg-color);color:var(--text-color);user-select:none;-webkit-user-select:none;touch-action:none}body.enable-scroll-zoom{overflow:hidden;height:100%;touch-action:auto}body.enable-scroll-zoom::-webkit-scrollbar{display:none}body.enable-scroll-zoom{-ms-overflow-style:none;scrollbar-width:none}#app{position:relative;width:100%;height:100%}#bg-layer{position:absolute;top:0;left:0;width:100%;height:100%;background-color:var(--bg-color);background-size:contain;background-position:center;background-repeat:no-repeat;z-index:0;pointer-events:none;transform-origin:0 0}body.drag-over #bg-layer{opacity:.2}body.drag-over::after{content:"Drop Image/SVG to Set Background";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.9);color:#fff;padding:20px 40px;border-radius:12px;font-size:1.2rem;font-weight:700;pointer-events:none;z-index:100;border:2px solid var(--accent-color)}#canvas{display:block;width:100%;height:100%;z-index:1;position:absolute;top:0;left:0;overflow:visible;touch-action:none;cursor:default}body.mode-select #canvas{cursor:default}body.mode-select.panning #canvas{cursor:grabbing}body.mode-select .path-element{cursor:pointer;pointer-events:stroke}body.mode-draw .path-element{pointer-events:none}.handle-group{pointer-events:none}.handle-group>*{pointer-events:auto}.handle-node{fill:#fff;stroke:var(--accent-color);stroke-width:2px;cursor:pointer;vector-effect:non-scaling-stroke}.handle-node:hover{fill:var(--accent-color);stroke:#fff}.snap-indicator{display:none;pointer-events:none}.snap-indicator circle{stroke:var(--accent-color);stroke-width:2px;fill:rgba(74,144,226,0.2);vector-effect:non-scaling-stroke}.handle-control{pointer-events:auto}.handle-control-bg{fill:var(--bg-color);stroke:var(--control-color);stroke-width:2px;vector-effect:non-scaling-stroke}.handle-control-bg:hover{stroke:#fff}.handle-control-inner{fill:var(--control-color);stroke:none;pointer-events:none}.handle-control-line{stroke:var(--control-color);stroke-width:1;opacity:.6;pointer-events:none;vector-effect:non-scaling-stroke}.control-handle-group{pointer-events:stroke}.control-handle-group:hover .handle-control-line{stroke-width:3;opacity:1}.handle-closing-line{stroke:var(--accent-color);stroke-width:2;stroke-dasharray:6,4;opacity:.8;pointer-events:stroke;cursor:move;vector-effect:non-scaling-stroke}.path-mover-group{cursor:grab;pointer-events:auto}.path-mover-group:active{cursor:grabbing}.cross-line-outline{stroke:#000000;stroke-width:5;stroke-linecap:round;pointer-events:none;vector-effect:non-scaling-stroke}.cross-line{stroke:var(--text-color);stroke-width:3;stroke-linecap:round;pointer-events:none;vector-effect:non-scaling-stroke}.cross-hitbox{fill:transparent;stroke:transparent}.path-mover-group:hover .cross-line{stroke:var(--accent-color);stroke-width:4}.rotation-handle-group{pointer-events:auto}.rotation-handle-group:active{cursor:grabbing}.rotation-x-line{stroke:var(--text-color);stroke-width:2;stroke-linecap:round;pointer-events:none;vector-effect:non-scaling-stroke}.rotation-circle{fill:var(--bg-color);stroke:var(--text-color);stroke-width:2;pointer-events:none;vector-effect:non-scaling-stroke}.rotation-hitbox{fill:transparent;stroke:transparent;cursor:grab}.rotation-handle-group:hover .rotation-x-line{stroke:var(--accent-color)}.rotation-handle-group:hover .rotation-circle{stroke:var(--accent-color)}.rotation-pivot-center{stroke:var(--text-color);pointer-events:none}#selection-rect{fill:none;stroke:#4a90e2;stroke-width:1;stroke-dasharray:4,4;pointer-events:none;display:none;vector-effect:non-scaling-stroke}.toolbar{position:absolute;top:20px;left:20px;width:var(--toolbar-width);background-color:var(--panel-bg);padding:16px;border-radius:8px;display:flex;flex-direction:column;gap:16px;border:1px solid var(--border-color);z-index:10;transition:transform .2s,opacity .2s}.toolbar.toolbar-right{left:auto;right:20px}.toolbar.minimized{opacity:0;pointer-events:none;transform:translateY(-10px)}.close-btn{position:absolute;top:10px;right:10px;background:0 0;border:none;color:#666;cursor:pointer;padding:4px;border-radius:4px}.close-btn:hover{color:#fff;background:rgba(255,255,255,.1)}.help-btn{position:absolute;top:10px;right:60px;background:0 0;border:none;color:#666;cursor:pointer;padding:4px;border-radius:4px;font-weight:700;font-family:sans-serif;font-size:14px}.help-btn:hover{color:#fff;background:rgba(255,255,255,.1)}.redo-btn,.undo-btn{position:absolute;top:10px;background:0 0;border:none;color:#666;cursor:pointer;padding:4px;border-radius:4px;display:flex;align-items:center;justify-content:center}.redo-btn:hover,.undo-btn:hover{color:#fff;background:rgba(255,255,255,.1)}.undo-btn{right:75px}.redo-btn{right:35px}.toolbar-group{display:flex;flex-direction:column;gap:8px}.toolbar-label{font-size:.75rem;text-transform:uppercase;letter-spacing:1px;color:#888;font-weight:600;display:flex;justify-content:space-between}.side-by-side{display:flex;gap:10px;align-items:flex-start}.side-by-side>div{flex:1;display:flex;flex-direction:column;gap:4px}.side-by-side>div:nth-child(2){flex:0 0 auto}.side-by-side>div label{font-size:.75rem;color:#888}.button-row{display:flex;gap:8px;position:relative}button{flex:1;padding:10px 12px;border:none;border-radius:4px;background-color:#3e3e4a;color:var(--text-color);cursor:pointer;font-size:.9rem;display:flex;align-items:center;justify-content:center;gap:6px;transition:background .2s}button:hover{background-color:#50505e}button.active{background-color:var(--accent-color);color:#fff;font-weight:700}button.danger{background-color:rgba(231,76,60,.15);color:var(--danger-color);border:1px solid rgba(231,76,60,.3)}button.danger:hover{background-color:var(--danger-color);color:#fff}button.export-btn{background-color:#27ae60;color:#fff;font-weight:600}button.export-btn:hover{background-color:#219150}button.import-btn{background-color:#3e3e4a}button.import-btn:hover{background-color:var(--accent-color);color:#fff}.icon-btn{flex:0 0 40px;padding:10px 0;background-color:#3e3e4a}.icon-btn:hover{background-color:var(--accent-color);color:#fff}.snap-btn{flex:0 0 40px;padding:10px 0;background-color:#3e3e4a;min-width:40px;position:relative}.snap-btn.active{background-color:var(--accent-color);color:#fff;font-weight:700}.snap-btn.pressed{transform:translateY(2px)}.color-picker-btn{flex:0 0 40px;margin-top:20px;padding:10px 0;background-color:#3e3e4a;min-width:40px}.color-picker-btn:hover{background-color:var(--accent-color);color:#fff}.color-picker-btn.active{background-color:var(--accent-color);color:#fff}.color-input-highlight{border:2px solid #000!important}.color-input-selected{border:2px solid #fff!important}.dropdown-menu{position:absolute;top:-115px;right:80px;background-color:var(--panel-bg);border:1px solid var(--border-color);border-radius:6px;display:none;flex-direction:column;z-index:50;overflow:hidden;min-width:100px}.dropdown-menu.show{display:flex;animation:fadeIn .15s ease}.dropdown-menu button{width:100%;padding:8px 12px;font-size:.85rem;justify-content:flex-start;background-color:transparent;border-radius:0;border-bottom:1px solid var(--border-color)}.dropdown-menu button:last-child{border-bottom:none}.dropdown-menu button:hover{background-color:var(--accent-color);color:#fff}.toolbar.toolbar-right .dropdown-menu{right:auto;left:80px}@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}input[type=color]{width:100%;height:36px;border:none;background:0 0;cursor:pointer;padding:0;border-radius:4px}input[type=range]{width:100%;cursor:pointer;accent-color:var(--accent-color)}.value-display{color:var(--accent-color);font-weight:400}.status-text{font-size:.8rem;color:#aaa;margin-top:-8px;line-height:1.4;border-top:1px solid var(--border-color);background:rgba(0,0,0,.2);padding:8px;border-radius:4px}#help-panel{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:400px;max-width:90%;background-color:var(--panel-bg);border:1px solid var(--border-color);border-radius:8px;padding:20px;z-index:200;display:none}#help-panel.visible{display:block;animation:popIn .2s cubic-bezier(.175,.885,.32,1.275)}@keyframes popIn{from{opacity:0;transform:translate(-50%,-40%) scale(.95)}to{opacity:1;transform:translate(-50%,-50%) scale(1)}}#help-panel h2{margin-top:0;font-size:1.2rem;color:var(--text-color);border-bottom:1px solid var(--border-color);padding-bottom:10px;margin-bottom:15px}#help-content{font-size:.9rem;line-height:1.5;color:#ccc;max-height:60vh;overflow-y:auto}#help-content b{color:var(--text-color)}#help-content span[style*='color:#e74c3c'],#help-content span[style*='color:var(--accent-color)']{font-weight:700}#close-help{margin-top:20px;width:100%;padding:10px;background-color:var(--accent-color);color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:600}#close-help:hover{background-color:var(--accent-hover)}#zoom-controls{display:none;flex-direction:column;gap:8px;padding:8px;background:rgba(0,0,0,.2);animation:slideDown .2s ease-out}@keyframes slideDown{from{opacity:0;transform:translateY(-5px)}to{opacity:1;transform:translateY(0)}}.zoom-header{display:flex;justify-content:space-between;font-size:.75rem;color:#ccc;font-weight:600}#fab{position:absolute;top:20px;left:20px;width:50px;height:50px;border-radius:50%;background-color:var(--panel-bg);border:1px solid var(--accent-color);color:var(--accent-color);display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:5;pointer-events:none;opacity:0;transform:scale(.8);transition:transform .2s,opacity .2s}#fab.visible{pointer-events:auto;opacity:1;transform:scale(1)}#fab:hover{background-color:var(--accent-color);color:#fff}#fab.fab-right{left:auto;right:20px}#fab svg{width:24px;height:24px;fill:currentColor}#color-canvas{display:none}#btn-order-path{flex:0 0 40px;padding:10px 0;min-width:40px}#pan-controls{position:absolute;bottom:20px;right:20px;z-index:15;display:none;flex-direction:column;align-items:center;gap:4px;width:auto;height:auto;background:0 0}body.mode-select #pan-controls{display:flex}#pan-controls.pan-left{right:auto;left:20px}.pan-row{display:flex;gap:4px}.pan-btn{width:40px;height:40px;border-radius:50%;background-color:var(--panel-bg);border:1px solid var(--border-color);color:var(--text-color);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .2s,transform .1s;user-select:none}.pan-btn:hover{background-color:var(--accent-color);color:#fff}.pan-btn:active{transform:scale(.95);background-color:var(--accent-hover)}.pan-btn svg{width:20px;height:20px;fill:currentColor}.rotation-ghost{opacity:.3;pointer-events:none;stroke-dasharray:4 2}</style></head><body class="mode-select"><input type="file" id="file-input" accept=".svg,image/*" style="display:none"><canvas id="color-canvas"></canvas><div id="app"><div id="bg-layer"></div><div id="fab" title="Open Toolbar"></div><div id="pan-controls"><button class="pan-btn" data-dir="up" title="Pan Up"><svg viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg></button><div class="pan-row"><button class="pan-btn" data-dir="left" title="Pan Left"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg></button> <button class="pan-btn" data-dir="right" title="Pan Right"><svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></button></div><button class="pan-btn" data-dir="down" title="Pan Down"><svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/></svg></button></div><nav class="toolbar" id="toolbar"><button class="undo-btn" id="btn-undo" title="Undo"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg></button> <button class="help-btn" id="btn-help" title="Help">?</button> <button class="redo-btn" id="btn-redo" title="Redo"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18.4 10.6C16.55 8.99 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z"/></svg></button> <button class="close-btn" id="btn-close-toolbar" title="Minimize Toolbar"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button><div class="toolbar-group"><div class="toolbar-label">Tools</div><div class="button-row"><button id="btn-draw"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg> Draw</button> <button id="btn-select" class="active"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M7 2l12 11.2-5.8.5 3.3 7.3-2.2.9-3.2-7.4-4.4 4.6z"/></svg> Select</button></div></div><div class="toolbar-group"><div class="side-by-side"><div><label for="stroke-color">Stroke</label> <input type="color" id="stroke-color" value="#4a90e2"></div><div><button id="btn-color-picker" class="color-picker-btn" title="Pick Color from Reference"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.71 5.63l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-3.12 3.12-1.93-1.91-1.41 1.41 1.42 1.42L3 16.25V21h4.75l8.92-8.92 1.42 1.42 1.41-1.41-1.92-1.92 3.12-3.12c.4-.4.4-1.03.01-1.42zM6.92 19L5 17.08l8.06-8.06 1.92 1.92L6.92 19z"/></svg></button></div><div><label for="fill-color">Fill</label> <input type="color" id="fill-color" value="#ffffff"></div></div></div><div class="toolbar-group"><div class="side-by-side"><div><label for="stroke-opacity">Stroke Opacity</label> <input type="range" id="stroke-opacity" min="0" max="1" step="0.1" value="1"></div><div><button id="btn-snap" class="snap-btn active pressed" title="Toggle Snap"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l-5.5 9h11z M12 22l5.5-9h-11z M3.5 9l5.5 9v-11z M20.5 9l-5.5 9v-11z"/></svg></button></div><div><label for="fill-opacity">Fill Opacity</label> <input type="range" id="fill-opacity" min="0" max="1" step="0.1" value="0"></div></div></div><div class="toolbar-group"><div class="toolbar-label"><span>Stroke Width</span> <span id="width-val" class="value-display">4px</span></div><input type="range" id="width-slider" min="1" max="100" value="4"></div><div class="toolbar-group"><div class="toolbar-label">Actions</div><div class="button-row"><button id="btn-close-shape"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12h16"></path><path d="M12 4v16"></path><circle cx="12" cy="12" r="10"></circle></svg> Close / Merge</button> <button id="btn-trace-color" title="Trace color area from reference image"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z"/><circle cx="12" cy="12" r="3"/></svg> Trace</button></div><div class="button-row"><button id="btn-import" class="import-btn" title="Import Image or SVG"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg> Import</button> <button id="btn-zoom-ui" class="icon-btn" title="Zoom Tool"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg></button> <button id="btn-export" class="export-btn" title="Export as SVG"><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/></svg> Export</button></div><div id="zoom-controls"><div class="zoom-header"><span>Canvas Zoom</span> <span id="zoom-ui-val">100%</span></div><input type="range" id="zoom-ui-slider" min="0.1" max="10.0" step="0.1" value="1"></div><div class="button-row"><button id="btn-clear-ref" title="Clear Background Image">Clear Ref.</button><div style="position:relative"><button id="btn-order-path" title="Reorder Path Layer"><svg width="16" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></button><div id="order-menu" class="dropdown-menu"><button data-action="top">Top (Front)</button> <button data-action="pull">Pull (Forward)</button> <button data-action="push">Push (Backward)</button> <button data-action="bottom">Bottom (Back)</button></div></div><button id="btn-delete-selected" class="danger" style="display:none">Delete</button> <button id="btn-clear" class="danger">Clear All</button></div></div><div class="status-text" id="status-text">Ready.</div></nav><div id="help-panel"><h2>Instructions</h2><div id="help-content"><b>Pan:</b> Hold <b>Right Mouse Button</b> or use 2 Fingers or buttons.<br><b>Zoom:</b> Press +/- or i/o, spread/pinch Fingers.<br><b>Select Mode:</b> Click path to select it, Shift+Click to select/deselect from group.<br><b>Movement:</b> Drag the <b>Cross</b> over selected paths.<br><b>Rotation:</b> Drag the <b>Circled X</b> over selected paths.<br>Re-select to reset selected paths pivot.<br>Hold Ctrl (or Cmd) and drag a <b>Circled X</b> to move the pivot.<br><b>White Squares</b> = <span style="color:var(--accent-color)">Anchor</span>.<br><b>Red Circles</b> = <span style="color:#e74c3c">Control Handles</span>.<br>Drag <span style="color:#e74c3c">Control Handles</span> to curve paths.<br>Hold Ctrl (or Cmd) to snap <span style="color:#e74c3c">Control Handles</span> or <b>Circled X</b> to multiples of 5.<br>Hold Ctrl (or Cmd) to and Click an Anchor to delete it.<br><b>D</b> or <b>Ctrl+D</b> duplicates the selected paths in place.<br>Press <b>Delete</b> or <b>Backspace</b> to delete selected paths.<br>Press <b>H</b> or <b>V</b> to flip selected paths horizontally or vertically, respectfully.<br><b>Double-click</b> or <b>Ctrl+Click</b> an <span style="color:var(--accent-color)">Anchor</span> to delete it.<br><b>Double-click</b> path to add an <span style="color:var(--accent-color)">Anchor</span> there.<br><b>Snap:</b> As long as snapping is enabled dragging <span style="color:var(--accent-color)">Anchor</span> or drawing snaps to the nearest <span style="color:var(--accent-color)">Anchor</span>/path.<br><b>Close:</b> Select a path and either click <b>Close / Merge</b> or drag its start to its end. (this adds <span style="color:#e74c3c">Control Handles</span>)<br><b>Merge:</b> Select multiple paths and click <b>Close / Merge</b> to unify them into a single one.<br><b>Trace:</b> Select a color in the reference to make a path containing it.<br></div><button id="close-help">Close</button></div><svg id="canvas"><defs></defs><g id="viewport"><g id="layer-paths"></g><g id="layer-paths-active"></g><g id="layer-selection-box"><rect id="selection-rect" x="0" y="0" width="0" height="0"></rect></g><g id="layer-handles"></g><g id="layer-snap-indicator" class="snap-indicator"><circle id="snap-ring" r="12" fill="none" stroke="#e74c3c" stroke-width="2" stroke-dasharray="4 2" opacity="0.9"></circle><circle id="snap-center" r="5" fill="#fff" stroke="#e74c3c" stroke-width="2"></circle></g></g></svg></div><script>"use strict";const AppState={mode:"select",isDrawing:!1,isDraggingHandle:!1,isDraggingPath:!1,isDraggingSegment:!1,isRotating:!1,isRotatingGroup:!1,rotatingPathIndex:null,rotationStartAngle:0,rotationPivot:null,rotationApplied:0,rotationHandleVector:null,isMovingPivot:!1,groupPivot:null,isSnapping:!1,snapEnabled:!0,snapEnabled:!0,isPanning:!1,currentPathIndex:-1,selectedPathIndices:[],activeHandleIndex:null,activeSegmentIndex:null,dragStartMouse:{x:0,y:0},panStartMouse:{x:0,y:0},paths:[],rawPoints:[],styles:{strokeColor:"#4a90e2",fillColor:"#ffffff",strokeOpacity:1,fillOpacity:0,width:4,drawThreshold:2,autoClose:!1,baseSnapThreshold:12,simplificationTolerance:1.5},toolbarState:{isLeft:!0,isToolbarOpen:!0,bufferDistance:40},snapTarget:null,view:{x:0,y:0,zoom:1},lastMouse:{x:0,y:0},dragStartControlLength:0,colorPickerActive:!1,selectedColorInput:null,referenceImage:null,referenceImageData:null,isBoxSelecting:!1,boxStart:null,clipboard:null,rotationGhostElements:[]},History={undoStack:[],redoStack:[],limit:50},UI={app:document.getElementById("app"),bgLayer:document.getElementById("bg-layer"),canvas:document.getElementById("canvas"),viewport:document.getElementById("viewport"),layerPaths:document.getElementById("layer-paths"),layerPathsActive:document.getElementById("layer-paths-active"),layerHandles:document.getElementById("layer-handles"),layerSnap:document.getElementById("layer-snap-indicator"),snapRing:document.getElementById("snap-ring"),snapCenter:document.getElementById("snap-center"),selectionRect:document.getElementById("selection-rect"),toolbar:document.getElementById("toolbar"),fab:document.getElementById("fab"),panControls:document.getElementById("pan-controls"),btnDraw:document.getElementById("btn-draw"),btnSelect:document.getElementById("btn-select"),btnSnap:document.getElementById("btn-snap"),btnCloseShape:document.getElementById("btn-close-shape"),btnExport:document.getElementById("btn-export"),btnImport:document.getElementById("btn-import"),fileInput:document.getElementById("file-input"),btnDelete:document.getElementById("btn-delete-selected"),btnClear:document.getElementById("btn-clear"),btnClearRef:document.getElementById("btn-clear-ref"),btnCloseToolbar:document.getElementById("btn-close-toolbar"),btnOrderPath:document.getElementById("btn-order-path"),orderMenu:document.getElementById("order-menu"),btnZoomUI:document.getElementById("btn-zoom-ui"),zoomControls:document.getElementById("zoom-controls"),zoomSlider:document.getElementById("zoom-ui-slider"),zoomVal:document.getElementById("zoom-ui-val"),strokeColor:document.getElementById("stroke-color"),fillColor:document.getElementById("fill-color"),strokeOpacity:document.getElementById("stroke-opacity"),fillOpacity:document.getElementById("fill-opacity"),widthSlider:document.getElementById("width-slider"),widthVal:document.getElementById("width-val"),statusText:document.getElementById("status-text"),body:document.body,btnHelp:document.getElementById("btn-help"),btnUndo:document.getElementById("btn-undo"),btnRedo:document.getElementById("btn-redo"),helpPanel:document.getElementById("help-panel"),closeHelp:document.getElementById("close-help"),btnColorPicker:document.getElementById("btn-color-picker"),colorCanvas:document.getElementById("color-canvas"),btnTraceColor:document.getElementById("btn-trace-color")},Icons={draw:'<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>',select:'<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M7 2l12 11.2-5.8.5 3.3 7.3-2.2.9-3.2-7.4-4.4 4.6z"/></svg>',menu:'<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>'};function saveState(){const t=JSON.parse(JSON.stringify(AppState.paths));History.undoStack.push(t),History.undoStack.length>History.limit&&History.undoStack.shift(),History.redoStack=[]}function undo(){if(AppState.isDrawing)return void cancelDrawing();if(0===History.undoStack.length)return;History.redoStack.push(JSON.parse(JSON.stringify(AppState.paths)));const t=History.undoStack.pop();AppState.paths=t,AppState.selectedPathIndices=AppState.selectedPathIndices.filter(t=>t<AppState.paths.length),rebuildCanvas()}function redo(){if(AppState.isDrawing)return;if(0===History.redoStack.length)return;History.undoStack.push(JSON.parse(JSON.stringify(AppState.paths)));const t=History.redoStack.pop();AppState.paths=t,AppState.selectedPathIndices=AppState.selectedPathIndices.filter(t=>t<AppState.paths.length),rebuildCanvas()}function cancelDrawing(){AppState.isDrawing=!1,AppState.isSnapping=!1,AppState.snapTarget=null,UI.layerSnap.style.display="none",AppState.rawPoints=[];const t=UI.layerPaths.lastElementChild||UI.layerPathsActive.lastElementChild;t&&t.remove(),AppState.currentPathIndex=-1}function rebuildCanvas(){UI.layerPaths.innerHTML="",UI.layerPathsActive.innerHTML="",UI.layerHandles.innerHTML="",AppState.paths.forEach((t,e)=>{const a=document.createElementNS("http://www.w3.org/2000/svg","path");a.setAttribute("class","path-element"),a.setAttribute("stroke",t.strokeColor),a.setAttribute("stroke-width",t.width),a.setAttribute("stroke-opacity",void 0!==t.strokeOpacity?t.strokeOpacity:1),a.setAttribute("fill",t.fillColor),a.setAttribute("fill-opacity",void 0!==t.fillOpacity?t.fillOpacity:0),a.setAttribute("stroke-linecap","round"),a.setAttribute("stroke-linejoin","round"),a.dataset.index=e,a.addEventListener("dblclick",t=>handlePathDoubleClick(t,e)),UI.layerPaths.appendChild(a),updatePathD(e)}),renderSelectionHandles()}function getSVGPoint(t,e){const a=UI.canvas.createSVGPoint();return a.x=t,a.y=e,a.matrixTransform(UI.viewport.getScreenCTM().inverse())}function setStatus(t){UI.statusText.innerHTML=t}function checkToolbarProximity(t){if("draw"!==AppState.mode)return;const e=AppState.toolbarState.isToolbarOpen?UI.toolbar:UI.fab;if(!AppState.toolbarState.isToolbarOpen&&!UI.fab.classList.contains("visible"))return;const a=e.getBoundingClientRect(),n=AppState.toolbarState.bufferDistance;AppState.toolbarState.isLeft?t<a.right+n&&moveToolbarTo("right"):t>a.left-n&&moveToolbarTo("left")}function moveToolbarTo(t){"right"===t?(AppState.toolbarState.isLeft=!1,UI.toolbar.classList.remove("toolbar-left"),UI.toolbar.classList.add("toolbar-right"),UI.fab.classList.remove("fab-left"),UI.fab.classList.add("fab-right"),UI.panControls.classList.add("pan-left")):(AppState.toolbarState.isLeft=!0,UI.toolbar.classList.remove("toolbar-right"),UI.toolbar.classList.add("toolbar-left"),UI.fab.classList.remove("fab-right"),UI.fab.classList.add("fab-left"),UI.panControls.classList.remove("pan-left"))}function toggleToolbar(){"select"===AppState.mode?setMode("draw"):(AppState.toolbarState.isToolbarOpen=!AppState.toolbarState.isToolbarOpen,UI.toolbar.classList.toggle("minimized",!AppState.toolbarState.isToolbarOpen),UI.fab.classList.toggle("visible",!AppState.toolbarState.isToolbarOpen))}function updateFabIcon(){"draw"===AppState.mode?(UI.fab.innerHTML=Icons.draw,UI.fab.title="Draw Mode - Click to Open Toolbar"):(UI.fab.innerHTML=Icons.select,UI.fab.title="Select Mode - Click to Open Toolbar")}function updateCloseShapeUI(){if(1===AppState.selectedPathIndices.length){const t=AppState.selectedPathIndices[0],e=AppState.paths[t];UI.btnCloseShape.classList.toggle("active",e.closed)}else UI.btnCloseShape.classList.toggle("active",AppState.styles.autoClose)}function toggleOrderMenu(){UI.orderMenu.classList.toggle("show")}function closeOrderMenu(){UI.orderMenu.classList.remove("show")}function reorderPath(t){if(0===AppState.selectedPathIndices.length)return closeOrderMenu(),void setStatus("Select a path first to reorder.");saveState();const e=[...AppState.selectedPathIndices].sort((t,e)=>t-e),a=e.map(t=>AppState.paths[t]);if("top"===t)AppState.paths=AppState.paths.filter(t=>!a.includes(t)),AppState.paths.push(...a);else if("bottom"===t)AppState.paths=AppState.paths.filter(t=>!a.includes(t)),AppState.paths.unshift(...a);else if("push"===t)for(let t=e.length-1;t>=0;t--){const a=e[t];if(a>0){const t=AppState.paths[a];AppState.paths[a]=AppState.paths[a-1],AppState.paths[a-1]=t}}else if("pull"===t)for(let t=0;t<e.length;t++){const a=e[t];if(a<AppState.paths.length-1){const t=AppState.paths[a];AppState.paths[a]=AppState.paths[a+1],AppState.paths[a+1]=t}}rebuildCanvas();const n=[];AppState.paths.forEach((t,e)=>{a.includes(t)&&n.push(e)}),AppState.selectedPathIndices=n,updateSelectionVisuals(),closeOrderMenu(),setStatus(`Paths moved to ${t}.`)}function updateViewportTransform(){UI.viewport.setAttribute("transform",`translate(${AppState.view.x}, ${AppState.view.y}) scale(${AppState.view.zoom})`),UI.bgLayer.style.transform=`translate(${AppState.view.x}px, ${AppState.view.y}px) scale(${AppState.view.zoom})`,"flex"===UI.zoomControls.style.display&&(UI.zoomSlider.value=AppState.view.zoom,UI.zoomVal.textContent=Math.round(100*AppState.view.zoom)+"%"),AppState.selectedPathIndices.length>0&&renderSelectionHandles()}function zoom(t,e,a){void 0===e&&(e=AppState.lastMouse.x),void 0===a&&(a=AppState.lastMouse.y);const n=UI.canvas.createSVGPoint();n.x=e,n.y=a;const o=n.matrixTransform(UI.viewport.getScreenCTM().inverse()),s=Math.max(.1,Math.min(10,AppState.view.zoom*t));AppState.view.x=e-o.x*s,AppState.view.y=a-o.y*s,AppState.view.zoom=s,updateViewportTransform()}function toggleSelection(t,e){if(-1===t)return AppState.selectedPathIndices=[],AppState.groupPivot=null,void updateSelectionVisuals();if(e){const e=AppState.selectedPathIndices.indexOf(t);e>-1?AppState.selectedPathIndices.splice(e,1):AppState.selectedPathIndices.push(t),AppState.groupPivot=null}else AppState.selectedPathIndices=[t],AppState.groupPivot=null;if(1===AppState.selectedPathIndices.length){const t=AppState.paths[AppState.selectedPathIndices[0]];if(t&&t.points&&t.points.length>0){const e=t.points,a=Math.min(...e.map(t=>t.p.x)),n=Math.min(...e.map(t=>t.p.y)),o=Math.max(...e.map(t=>t.p.x)),s=Math.max(...e.map(t=>t.p.y));t.rotationPivot={x:(a+o)/2,y:(n+s)/2}}}updateSelectionVisuals()}function zoomCentered(t){const e=window.innerWidth/2,a=window.innerHeight/2,n=UI.canvas.createSVGPoint();n.x=e,n.y=a;const o=n.matrixTransform(UI.viewport.getScreenCTM().inverse()),s=Math.max(.1,Math.min(10,parseFloat(t)));AppState.view.x=e-o.x*s,AppState.view.y=a-o.y*s,AppState.view.zoom=s,updateViewportTransform()}function resetView(){AppState.view.x=0,AppState.view.y=0,AppState.view.zoom=1,updateViewportTransform(),setStatus("View reset to center.")}function cubicBezier(t,e,a,n,o){const s=1-o;return{x:Math.pow(s,3)*t.x+3*Math.pow(s,2)*o*e.x+3*s*Math.pow(o,2)*a.x+Math.pow(o,3)*n.x,y:Math.pow(s,3)*t.y+3*Math.pow(s,2)*o*e.y+3*s*Math.pow(o,2)*a.y+Math.pow(o,3)*n.y}}function getBezierSegmentDistance(t,e,a,n,o){let s=1/0;for(let i=0;i<=1;i+=.05){const r=cubicBezier(t,e,a,n,i),p=Math.hypot(r.x-o.x,r.y-o.y);p<s&&(s=p)}return s}function simplifyPath(t,e,a=1){if(t.length<=2)return t;const n=e/a,o=Math.max(.5,.5*n);let s=[t[0]];for(let e=1;e<t.length;e++){Math.hypot(t[e].x-t[e-1].x,t[e].y-t[e-1].y)>o&&s.push(t[e])}s[s.length-1]!==t[t.length-1]&&s.push(t[t.length-1]);return ramerDouglasPeucker(s,n)}function ramerDouglasPeucker(t,e){if(t.length<=2)return t;let a=0,n=0,o=t.length-1;for(let e=1;e<o;e++){const s=pointLineDistance(t[e],t[0],t[o]);s>a&&(n=e,a=s)}return a>e?ramerDouglasPeucker(t.slice(0,n+1),e).slice(0,-1).concat(ramerDouglasPeucker(t.slice(n,o+1),e)):[t[0],t[o]]}function pointLineDistance(t,e,a){let n=e.x,o=e.y,s=a.x-n,i=a.y-o;if(0!==s||0!==i){const e=((t.x-n)*s+(t.y-o)*i)/(s*s+i*i);e>1?(n=a.x,o=a.y):e>0&&(n+=s*e,o+=i*e)}return Math.hypot(t.x-n,t.y-o)}function smoothPoints(t,e=2){if(t.length<3)return t;let a=t.map(t=>({x:t.x,y:t.y}));for(let t=0;t<e;t++){const t=[];for(let e=0;e<a.length;e++){const n=a[(e-1+a.length)%a.length],o=a[e],s=a[(e+1)%a.length];t.push({x:(n.x+o.x+s.x)/3,y:(n.y+o.y+s.y)/3})}a=t}return a}function calculateControlPoints(t){const e=t.map(t=>({p:{...t},cIn:{...t},cOut:{...t}})),a=t.length;if(a<2)return e;const n=[];for(let e=0;e<a-1;e++){const a=t[e+1].x-t[e].x,o=t[e+1].y-t[e].y,s=Math.hypot(a,o);n.push({x:s>0?a/s:0,y:s>0?o/s:0,len:s})}for(let o=0;o<a;o++){const s=t[o];if(o>0&&o<a-1){const a=n[o-1],i=n[o],r=-a.x*i.x-a.y*i.y;if(Math.acos(Math.max(-1,Math.min(1,r)))>2.2){const t=a.len/3,n=i.len/3;e[o].cIn={x:s.x-a.x*t,y:s.y-a.y*t},e[o].cOut={x:s.x+i.x*n,y:s.y+i.y*n}}else{const n=t[o-1],r=t[o+1],p=.4,l=r.x-n.x,c=r.y-n.y;let d=s.x+l*p,u=s.y+c*p,h=s.x-l*p,g=s.y-c*p;const y=i.len,S=Math.hypot(d-s.x,u-s.y);if(S>y&&S>0){const t=y/S;d=s.x+(d-s.x)*t,u=s.y+(u-s.y)*t}const A=a.len,x=Math.hypot(h-s.x,g-s.y);if(x>A&&x>0){const t=A/x;h=s.x+(h-s.x)*t,g=s.y+(g-s.y)*t}e[o].cOut={x:d,y:u},e[o].cIn={x:h,y:g}}}}if(e[0].cIn={...e[0].p},a>1){const a=n[0].len/3;e[0].cOut={x:t[0].x+n[0].x*a,y:t[0].y+n[0].y*a}}if(e[a-1].cOut={...e[a-1].p},a>1){const o=n[a-2].len/3;e[a-1].cIn={x:t[a-1].x-n[a-2].x*o,y:t[a-1].y-n[a-2].y*o}}return e}function getNearestSegmentIndex(t,e){const a=t.points;let n=1/0,o=-1;for(let t=0;t<a.length-1;t++){const s=a[t],i=a[t+1],r=getBezierSegmentDistance(s.p,s.cOut,i.cIn,i.p,e);r<=n&&(n=r,o=t)}if(t.closed){const t=a[a.length-1],s=a[0],i=getBezierSegmentDistance(t.p,t.cOut,s.cIn,s.p,e);i<=n&&(n=i,o=a.length-1)}return{index:o,dist:n}}function getTFromPoint(t,e,a,n,o){let s=.5,i=1/0;for(let r=0;r<=1;r+=.05){const p=cubicBezier(t,e,a,n,r),l=Math.hypot(p.x-o.x,p.y-o.y);l<i&&(i=l,s=r)}return{t:s,dist:i}}function splitBezierCurve(t,e,a,n,o){const s=1-o,i={x:s*t.x+o*e.x,y:s*t.y+o*e.y},r=s*e.x+o*a.x,p=s*e.y+o*a.y,l={x:s*a.x+o*n.x,y:s*a.y+o*n.y},c={x:s*i.x+o*r,y:s*i.y+o*p},d={x:s*r+o*l.x,y:s*p+o*l.y},u={x:s*c.x+o*d.x,y:s*c.y+o*d.y};return{leftNode:{p:t,cOut:i,cIn:{x:t.x,y:t.y}},splitNode:{p:u,cIn:c,cOut:d},rightNode:{p:n,cIn:l}}}function startDrawing(t,e){if(AppState.isDrawing=!0,AppState.rawPoints=[],AppState.snapEnabled){const a=getSnapThresholdInWorldCoords(),n=findSnapTarget(t,e,-1,-1,a);if(n){t=n.x,e=n.y,AppState.snapTarget=n,UI.layerSnap.style.display="block";const o=a,s=5/AppState.view.zoom;UI.snapRing.setAttribute("cx",t),UI.snapRing.setAttribute("cy",e),UI.snapRing.setAttribute("r",o),UI.snapCenter.setAttribute("cx",t),UI.snapCenter.setAttribute("cy",e),UI.snapCenter.setAttribute("r",s)}}AppState.rawPoints.push({x:t,y:e});const a=document.createElementNS("http://www.w3.org/2000/svg","path");a.setAttribute("class","path-element"),a.setAttribute("stroke",AppState.styles.strokeColor),a.setAttribute("fill",AppState.styles.fillColor),a.setAttribute("stroke-width",AppState.styles.width),a.setAttribute("stroke-opacity",AppState.styles.strokeOpacity),a.setAttribute("fill-opacity",AppState.styles.fillOpacity),a.setAttribute("stroke-linecap","round"),a.setAttribute("stroke-linejoin","round"),a.dataset.index=AppState.paths.length,UI.layerPaths.appendChild(a),a.setAttribute("d",`M ${t.toFixed(1)} ${e.toFixed(1)}`)}function drawMove(t,e){if(!AppState.isDrawing)return;let a=null;if(AppState.snapEnabled){const n=getSnapThresholdInWorldCoords();if(a=findSnapTarget(t,e,-1,-1,n),AppState.rawPoints.length>2){const o=AppState.rawPoints[0];Math.hypot(t-o.x,e-o.y)<n&&(a={x:o.x,y:o.y,type:"anchor"})}}let n=t,o=e;if(a){n=a.x,o=a.y,AppState.snapTarget=a,UI.layerSnap.style.display="block";const t=getSnapThresholdInWorldCoords(),e=5/AppState.view.zoom;UI.snapRing.setAttribute("cx",n),UI.snapRing.setAttribute("cy",o),UI.snapRing.setAttribute("r",t),UI.snapCenter.setAttribute("cx",n),UI.snapCenter.setAttribute("cy",o),UI.snapCenter.setAttribute("r",e)}else AppState.snapTarget=null,UI.layerSnap.style.display="none";const s=AppState.rawPoints[AppState.rawPoints.length-1];Math.hypot(n-s.x,o-s.y)>AppState.styles.drawThreshold/AppState.view.zoom?AppState.rawPoints.push({x:n,y:o}):a&&(AppState.rawPoints[AppState.rawPoints.length-1]={x:n,y:o});const i=AppState.rawPoints.reduce((t,e,a)=>t+(0===a?`M ${e.x.toFixed(1)} ${e.y.toFixed(1)}`:` L ${e.x.toFixed(1)} ${e.y.toFixed(1)}`),""),r=UI.layerPaths.lastElementChild||UI.layerPathsActive.lastElementChild;r&&r.setAttribute("d",i)}function stopDrawing(){if(AppState.isDrawing){if(AppState.isDrawing=!1,UI.layerSnap.style.display="none",AppState.snapTarget&&AppState.rawPoints.length>0){if(AppState.rawPoints[AppState.rawPoints.length-1]={x:AppState.snapTarget.x,y:AppState.snapTarget.y},AppState.rawPoints.length>2){const t=AppState.rawPoints[0],e=AppState.rawPoints[AppState.rawPoints.length-1];Math.hypot(t.x-e.x,t.y-e.y)<1&&(AppState.styles.autoClose=!0)}AppState.snapTarget=null}if(AppState.rawPoints.length>=1){let t=simplifyPath(AppState.rawPoints,AppState.styles.simplificationTolerance,AppState.view.zoom);if(1===t.length&&t.push({x:t[0].x,y:t[0].y}),t.length>=2){const e=calculateControlPoints(t),a={strokeColor:AppState.styles.strokeColor,fillColor:AppState.styles.fillColor,strokeOpacity:AppState.styles.strokeOpacity,fillOpacity:AppState.styles.fillOpacity,width:parseInt(AppState.styles.width),points:e,closed:AppState.styles.autoClose};AppState.paths.push(a),AppState.currentPathIndex=AppState.paths.length-1;let n=UI.layerPaths.querySelector(`path[data-index="${AppState.currentPathIndex}"]`);n||(n=UI.layerPathsActive.querySelector(`path[data-index="${AppState.currentPathIndex}"]`)),n&&n.addEventListener("dblclick",t=>handlePathDoubleClick(t,AppState.currentPathIndex)),updatePathD(AppState.currentPathIndex),AppState.selectedPathIndices=[],updateSelectionVisuals(),saveState()}else{const t=UI.layerPaths.lastElementChild||UI.layerPathsActive.lastElementChild;t&&t.remove()}}else{const t=UI.layerPaths.lastElementChild||UI.layerPathsActive.lastElementChild;t&&t.remove()}AppState.rawPoints=[]}}function updatePathD(t){const e=AppState.paths[t];if(!e||!e.points)return;const a=e.points;if(0===a.length)return;let n=`M ${a[0].p.x.toFixed(1)} ${a[0].p.y.toFixed(1)}`;for(let t=0;t<a.length-1;t++){const e=a[t],o=a[t+1];n+=` C ${e.cOut.x.toFixed(1)} ${e.cOut.y.toFixed(1)}, ${o.cIn.x.toFixed(1)} ${o.cIn.y.toFixed(1)}, ${o.p.x.toFixed(1)} ${o.p.y.toFixed(1)}`}if(e.closed){const t=a[0],e=a[a.length-1];n+=` C ${e.cOut.x.toFixed(1)} ${e.cOut.y.toFixed(1)}, ${t.cIn.x.toFixed(1)} ${t.cIn.y.toFixed(1)}, ${t.p.x.toFixed(1)} ${t.p.y.toFixed(1)} Z`}let o=UI.layerPaths.querySelector(`path[data-index="${t}"]`);o||(o=UI.layerPathsActive.querySelector(`path[data-index="${t}"]`)),o&&o.setAttribute("d",n)}function renderGroupTransformHandles(){const t=getSelectionBoundingBox();if(!t)return;const e=t.x,a=t.y,n=AppState.groupPivot||{x:t.cx,y:t.cy},o=25/AppState.view.zoom,s=document.createElementNS("http://www.w3.org/2000/svg","g");s.setAttribute("transform",`translate(${e-o}, ${a-o})`),s.setAttribute("class","path-mover-group");const i=10/AppState.view.zoom,r=document.createElementNS("http://www.w3.org/2000/svg","line");r.setAttribute("x1",-i),r.setAttribute("y1",0),r.setAttribute("x2",i),r.setAttribute("y2",0),r.setAttribute("class","cross-line-outline");const p=document.createElementNS("http://www.w3.org/2000/svg","line");p.setAttribute("x1",0),p.setAttribute("y1",-i),p.setAttribute("x2",0),p.setAttribute("y2",i),p.setAttribute("class","cross-line-outline");const l=document.createElementNS("http://www.w3.org/2000/svg","line");l.setAttribute("x1",-i),l.setAttribute("y1",0),l.setAttribute("x2",i),l.setAttribute("y2",0),l.setAttribute("class","cross-line");const c=document.createElementNS("http://www.w3.org/2000/svg","line");c.setAttribute("x1",0),c.setAttribute("y1",-i),c.setAttribute("x2",0),c.setAttribute("y2",i),c.setAttribute("class","cross-line");const d=document.createElementNS("http://www.w3.org/2000/svg","rect");d.setAttribute("x",-i),d.setAttribute("y",-i),d.setAttribute("width",2*i),d.setAttribute("height",2*i),d.setAttribute("class","cross-hitbox"),s.appendChild(r),s.appendChild(p),s.appendChild(l),s.appendChild(c),s.appendChild(d);const u=AppState.selectedPathIndices[0];s.addEventListener("mousedown",t=>{t.stopPropagation(),startDraggingPath(t,u)}),UI.layerHandles.appendChild(s);const h=e-o+40/AppState.view.zoom,g=a-o,y=document.createElementNS("http://www.w3.org/2000/svg","line");y.setAttribute("x1",h),y.setAttribute("y1",g),y.setAttribute("x2",n.x),y.setAttribute("y2",n.y),y.setAttribute("class","rotation-pivot-indicator"),UI.layerHandles.appendChild(y);const S=document.createElementNS("http://www.w3.org/2000/svg","circle");S.setAttribute("cx",n.x),S.setAttribute("cy",n.y),S.setAttribute("r",4/AppState.view.zoom),S.setAttribute("class","rotation-pivot-center"),UI.layerHandles.appendChild(S);const A=document.createElementNS("http://www.w3.org/2000/svg","g");A.setAttribute("transform",`translate(${h}, ${g})`),A.setAttribute("class","rotation-handle-group"),A.setAttribute("id","rot-handle-group"),A.dataset.isGroup="true";const x=8/AppState.view.zoom,m=document.createElementNS("http://www.w3.org/2000/svg","circle");m.setAttribute("cx",0),m.setAttribute("cy",0),m.setAttribute("r",1.5*x),m.setAttribute("class","rotation-circle");const I=document.createElementNS("http://www.w3.org/2000/svg","line");I.setAttribute("x1",-x),I.setAttribute("y1",-x),I.setAttribute("x2",x),I.setAttribute("y2",x),I.setAttribute("class","rotation-x-line");const b=document.createElementNS("http://www.w3.org/2000/svg","line");b.setAttribute("x1",x),b.setAttribute("y1",-x),b.setAttribute("x2",-x),b.setAttribute("y2",x),b.setAttribute("class","rotation-x-line");const v=document.createElementNS("http://www.w3.org/2000/svg","circle");v.setAttribute("cx",0),v.setAttribute("cy",0),v.setAttribute("r",2*x),v.setAttribute("class","rotation-hitbox"),A.appendChild(m),A.appendChild(I),A.appendChild(b),A.appendChild(v),A.addEventListener("mousedown",t=>{t.stopPropagation(),startRotatingGroup(t)}),UI.layerHandles.appendChild(A)}function startRotatingGroup(t){if("select"!==AppState.mode)return;if(t.preventDefault(),t.stopPropagation(),t.ctrlKey||t.metaKey)return AppState.isMovingPivot=!0,AppState.isRotating=!1,AppState.isRotatingGroup=!1,AppState.rotatingPathIndex=null,void setStatus("Moving Group Rotation Pivot...");AppState.isRotating=!0,AppState.isRotatingGroup=!0,AppState.rotatingPathIndex=null;const e=getSelectionBoundingBox();AppState.rotationPivot=AppState.groupPivot||{x:e.cx,y:e.cy};const a=getSVGPoint(t.clientX,t.clientY);AppState.rotationStartAngle=Math.atan2(a.y-AppState.rotationPivot.y,a.x-AppState.rotationPivot.x),AppState.rotationApplied=0,clearHandles(),AppState.rotationGhostElements=[],AppState.selectedPathIndices.forEach(t=>{const e=UI.layerPaths.querySelector(`path[data-index="${t}"]`);if(e){const t=e.cloneNode(!0);t.removeAttribute("data-index"),t.classList.add("rotation-ghost"),UI.layerPathsActive.appendChild(t),AppState.rotationGhostElements.push(t)}}),saveState(),setStatus("Rotating Group...")}function renderHandlesForPath(t){const e=AppState.paths[t],a=e.points,n=document.createElementNS("http://www.w3.org/2000/svg","g"),o=document.createElementNS("http://www.w3.org/2000/svg","g");o.setAttribute("class","handle-group");const s=(t,e)=>Math.hypot(t.x-e.x,t.y-e.y)>.5;if(a.forEach((i,r)=>{const p=r<a.length-1||e.closed,l=r>0||e.closed,c=p&&s(i.cOut,i.p),d=l&&s(i.cIn,i.p);if(c){const t=document.createElementNS("http://www.w3.org/2000/svg","line");t.setAttribute("x1",i.p.x),t.setAttribute("y1",i.p.y),t.setAttribute("x2",i.cOut.x),t.setAttribute("y2",i.cOut.y),t.setAttribute("class","handle-control-line"),n.appendChild(t)}if(d){const e=document.createElementNS("http://www.w3.org/2000/svg","g");e.setAttribute("class","control-handle-group");const a=document.createElementNS("http://www.w3.org/2000/svg","line");a.setAttribute("x1",i.p.x),a.setAttribute("y1",i.p.y),a.setAttribute("x2",i.cIn.x),a.setAttribute("y2",i.cIn.y),a.setAttribute("class","handle-control-line"),e.appendChild(a),createHandle(e,i.cIn,"control",r,t,"cIn"),UI.layerHandles.appendChild(e)}c&&createHandle(o,i.cOut,"control",r,t,"cOut"),d&&createHandle(o,i.cIn,"control",r,t,"cIn")}),e.closed&&a.length>2){const e=a[0],o=a[a.length-1];if(Math.hypot(o.cOut.x-o.p.x,o.cOut.y-o.p.y)<1&&Math.hypot(e.cIn.x-e.p.x,e.cIn.y-e.p.y)<1){const a=document.createElementNS("http://www.w3.org/2000/svg","line");a.setAttribute("x1",o.p.x),a.setAttribute("y1",o.p.y),a.setAttribute("x2",e.p.x),a.setAttribute("y2",e.p.y),a.setAttribute("class","handle-closing-line"),a.dataset.index=t,n.appendChild(a)}}UI.layerHandles.appendChild(n),UI.layerHandles.appendChild(o);const i=document.createElementNS("http://www.w3.org/2000/svg","g");i.setAttribute("class","handle-group"),a.forEach((e,a)=>{createHandle(i,e.p,"anchor",a,t)}),UI.layerHandles.appendChild(i);const r=Math.min(...a.map(t=>t.p.x)),p=Math.min(...a.map(t=>t.p.y)),l=Math.max(...a.map(t=>t.p.x)),c=Math.max(...a.map(t=>t.p.y)),d=25/AppState.view.zoom,u=document.createElementNS("http://www.w3.org/2000/svg","g");u.setAttribute("transform",`translate(${r-d}, ${p-d})`),u.setAttribute("class","path-mover-group");const h=10/AppState.view.zoom,g=document.createElementNS("http://www.w3.org/2000/svg","line");g.setAttribute("x1",-h),g.setAttribute("y1",0),g.setAttribute("x2",h),g.setAttribute("y2",0),g.setAttribute("class","cross-line-outline");const y=document.createElementNS("http://www.w3.org/2000/svg","line");y.setAttribute("x1",0),y.setAttribute("y1",-h),y.setAttribute("x2",0),y.setAttribute("y2",h),y.setAttribute("class","cross-line-outline");const S=document.createElementNS("http://www.w3.org/2000/svg","line");S.setAttribute("x1",-h),S.setAttribute("y1",0),S.setAttribute("x2",h),S.setAttribute("y2",0),S.setAttribute("class","cross-line");const A=document.createElementNS("http://www.w3.org/2000/svg","line");A.setAttribute("x1",0),A.setAttribute("y1",-h),A.setAttribute("x2",0),A.setAttribute("y2",h),A.setAttribute("class","cross-line");const x=document.createElementNS("http://www.w3.org/2000/svg","rect");x.setAttribute("x",-h),x.setAttribute("y",-h),x.setAttribute("width",2*h),x.setAttribute("height",2*h),x.setAttribute("class","cross-hitbox"),u.appendChild(g),u.appendChild(y),u.appendChild(S),u.appendChild(A),u.appendChild(x),u.addEventListener("mousedown",e=>{e.stopPropagation(),startDraggingPath(e,t)}),UI.layerHandles.appendChild(u);const m=r-d+40/AppState.view.zoom,I=p-d;void 0===e.rotationPivot&&(e.rotationPivot={x:(r+l)/2,y:(p+c)/2});const b=document.createElementNS("http://www.w3.org/2000/svg","line");b.setAttribute("x1",m),b.setAttribute("y1",I),b.setAttribute("x2",e.rotationPivot.x),b.setAttribute("y2",e.rotationPivot.y),b.setAttribute("class","rotation-pivot-indicator"),UI.layerHandles.appendChild(b);const v=document.createElementNS("http://www.w3.org/2000/svg","circle");v.setAttribute("cx",e.rotationPivot.x),v.setAttribute("cy",e.rotationPivot.y),v.setAttribute("r",4/AppState.view.zoom),v.setAttribute("class","rotation-pivot-center"),UI.layerHandles.appendChild(v);const f=document.createElementNS("http://www.w3.org/2000/svg","g");f.setAttribute("transform",`translate(${m}, ${I})`),f.setAttribute("class","rotation-handle-group"),f.setAttribute("id",`rot-handle-${t}`),f.dataset.pathIndex=t;const w=8/AppState.view.zoom,P=document.createElementNS("http://www.w3.org/2000/svg","circle");P.setAttribute("cx",0),P.setAttribute("cy",0),P.setAttribute("r",1.5*w),P.setAttribute("class","rotation-circle");const U=document.createElementNS("http://www.w3.org/2000/svg","line");U.setAttribute("x1",-w),U.setAttribute("y1",-w),U.setAttribute("x2",w),U.setAttribute("y2",w),U.setAttribute("class","rotation-x-line");const C=document.createElementNS("http://www.w3.org/2000/svg","line");C.setAttribute("x1",w),C.setAttribute("y1",-w),C.setAttribute("x2",-w),C.setAttribute("y2",w),C.setAttribute("class","rotation-x-line");const E=document.createElementNS("http://www.w3.org/2000/svg","circle");E.setAttribute("cx",0),E.setAttribute("cy",0),E.setAttribute("r",2*w),E.setAttribute("class","rotation-hitbox"),f.appendChild(P),f.appendChild(U),f.appendChild(C),f.appendChild(E),f.addEventListener("mousedown",e=>{e.stopPropagation(),startRotatingPath(e,t)}),f.addEventListener("dblclick",e=>{e.stopPropagation(),resetRotationPivot(t)}),UI.layerHandles.appendChild(f)}function updateSelectionVisuals(){if(AppState.selectedPathIndices.length>0){const t=AppState.selectedPathIndices[0],e=AppState.paths[t];UI.widthSlider.value=e.width,UI.widthVal.textContent=e.width+"px",UI.strokeColor.value=e.strokeColor,UI.fillColor.value=e.fillColor,UI.strokeOpacity.value=void 0!==e.strokeOpacity?e.strokeOpacity:1,UI.fillOpacity.value=void 0!==e.fillOpacity?e.fillOpacity:0,UI.btnDelete.style.display="block",UI.btnClear.style.display="none",setStatus(`Selected ${AppState.selectedPathIndices.length} path(s). Zoom: ${(100*AppState.view.zoom).toFixed(0)}%`),updateCloseShapeUI()}else UI.widthSlider.value=AppState.styles.width,UI.widthVal.textContent=AppState.styles.width+"px",UI.strokeColor.value=AppState.styles.strokeColor,UI.fillColor.value=AppState.styles.fillColor,UI.strokeOpacity.value=AppState.styles.strokeOpacity,UI.fillOpacity.value=AppState.styles.fillOpacity,UI.btnDelete.style.display="none",UI.btnClear.style.display="block",setStatus("Select Mode. <b>Right Click</b> or <b>2 Fingers</b> to Pan."),updateCloseShapeUI();renderSelectionHandles()}function clearHandles(){UI.layerHandles.innerHTML=""}function renderSelectionHandles(){clearHandles(),0!==AppState.selectedPathIndices.length&&(1===AppState.selectedPathIndices.length?renderHandlesForPath(AppState.selectedPathIndices[0]):(AppState.selectedPathIndices.forEach(t=>{renderHandlesForPath(t,!0)}),renderGroupTransformHandles()))}document.addEventListener("click",t=>{UI.btnOrderPath.contains(t.target)||UI.orderMenu.contains(t.target)||closeOrderMenu()}),UI.btnOrderPath.addEventListener("click",t=>{t.stopPropagation(),toggleOrderMenu()}),UI.orderMenu.querySelectorAll("button").forEach(t=>{t.addEventListener("click",t=>{t.stopPropagation(),reorderPath(t.target.dataset.action)})});const HANDLE_SCREEN_SIZE=8,CONTROL_SCREEN_RADIUS=5,MIN_CANVAS_SIZE=2;function getHandleSize(){return 12/AppState.view.zoom}function getControlRadius(){return 6/AppState.view.zoom}function renderHandlesForPath(t,e=!1){const a=AppState.paths[t],n=a.points,o=document.createElementNS("http://www.w3.org/2000/svg","g"),s=document.createElementNS("http://www.w3.org/2000/svg","g");s.setAttribute("class","handle-group");const i=(t,e)=>Math.hypot(t.x-e.x,t.y-e.y)>.5;if(n.forEach((e,o)=>{const s=o<n.length-1||a.closed,r=o>0||a.closed,p=s&&i(e.cOut,e.p),l=r&&i(e.cIn,e.p);if(p){const a=document.createElementNS("http://www.w3.org/2000/svg","g");a.setAttribute("class","control-handle-group");const n=document.createElementNS("http://www.w3.org/2000/svg","line");n.setAttribute("x1",e.p.x),n.setAttribute("y1",e.p.y),n.setAttribute("x2",e.cOut.x),n.setAttribute("y2",e.cOut.y),n.setAttribute("class","handle-control-line"),a.appendChild(n),createHandle(a,e.cOut,"control",o,t,"cOut"),UI.layerHandles.appendChild(a)}if(l){const a=document.createElementNS("http://www.w3.org/2000/svg","g");a.setAttribute("class","control-handle-group");const n=document.createElementNS("http://www.w3.org/2000/svg","line");n.setAttribute("x1",e.p.x),n.setAttribute("y1",e.p.y),n.setAttribute("x2",e.cIn.x),n.setAttribute("y2",e.cIn.y),n.setAttribute("class","handle-control-line"),a.appendChild(n),createHandle(a,e.cIn,"control",o,t,"cIn"),UI.layerHandles.appendChild(a)}}),a.closed&&n.length>2){const e=n[0],a=n[n.length-1];if(Math.hypot(a.cOut.x-a.p.x,a.cOut.y-a.p.y)<1&&Math.hypot(e.cIn.x-e.p.x,e.cIn.y-e.p.y)<1){const n=document.createElementNS("http://www.w3.org/2000/svg","line");n.setAttribute("x1",a.p.x),n.setAttribute("y1",a.p.y),n.setAttribute("x2",e.p.x),n.setAttribute("y2",e.p.y),n.setAttribute("class","handle-closing-line"),n.dataset.index=t,o.appendChild(n)}}UI.layerHandles.appendChild(o),UI.layerHandles.appendChild(s);const r=document.createElementNS("http://www.w3.org/2000/svg","g");if(r.setAttribute("class","handle-group"),n.forEach((e,a)=>{createHandle(r,e.p,"anchor",a,t)}),UI.layerHandles.appendChild(r),e)return;const p=Math.min(...n.map(t=>t.p.x)),l=Math.min(...n.map(t=>t.p.y)),c=Math.max(...n.map(t=>t.p.x)),d=Math.max(...n.map(t=>t.p.y)),u=25/AppState.view.zoom,h=document.createElementNS("http://www.w3.org/2000/svg","g");h.setAttribute("transform",`translate(${p-u}, ${l-u})`),h.setAttribute("class","path-mover-group");const g=10/AppState.view.zoom,y=document.createElementNS("http://www.w3.org/2000/svg","line");y.setAttribute("x1",-g),y.setAttribute("y1",0),y.setAttribute("x2",g),y.setAttribute("y2",0),y.setAttribute("class","cross-line-outline");const S=document.createElementNS("http://www.w3.org/2000/svg","line");S.setAttribute("x1",0),S.setAttribute("y1",-g),S.setAttribute("x2",0),S.setAttribute("y2",g),S.setAttribute("class","cross-line-outline");const A=document.createElementNS("http://www.w3.org/2000/svg","line");A.setAttribute("x1",-g),A.setAttribute("y1",0),A.setAttribute("x2",g),A.setAttribute("y2",0),A.setAttribute("class","cross-line");const x=document.createElementNS("http://www.w3.org/2000/svg","line");x.setAttribute("x1",0),x.setAttribute("y1",-g),x.setAttribute("x2",0),x.setAttribute("y2",g),x.setAttribute("class","cross-line");const m=document.createElementNS("http://www.w3.org/2000/svg","rect");m.setAttribute("x",-g),m.setAttribute("y",-g),m.setAttribute("width",2*g),m.setAttribute("height",2*g),m.setAttribute("class","cross-hitbox"),h.appendChild(y),h.appendChild(S),h.appendChild(A),h.appendChild(x),h.appendChild(m),h.addEventListener("mousedown",e=>{e.stopPropagation(),startDraggingPath(e,t)}),UI.layerHandles.appendChild(h);const I=p-u+40/AppState.view.zoom,b=l-u;void 0===a.rotationPivot&&(a.rotationPivot={x:(p+c)/2,y:(l+d)/2});const v=document.createElementNS("http://www.w3.org/2000/svg","line");v.setAttribute("x1",I),v.setAttribute("y1",b),v.setAttribute("x2",a.rotationPivot.x),v.setAttribute("y2",a.rotationPivot.y),v.setAttribute("class","rotation-pivot-indicator"),UI.layerHandles.appendChild(v);const f=document.createElementNS("http://www.w3.org/2000/svg","circle");f.setAttribute("cx",a.rotationPivot.x),f.setAttribute("cy",a.rotationPivot.y),f.setAttribute("r",4/AppState.view.zoom),f.setAttribute("class","rotation-pivot-center"),UI.layerHandles.appendChild(f);const w=document.createElementNS("http://www.w3.org/2000/svg","g");w.setAttribute("transform",`translate(${I}, ${b})`),w.setAttribute("class","rotation-handle-group"),w.setAttribute("id",`rot-handle-${t}`),w.dataset.pathIndex=t;const P=8/AppState.view.zoom,U=document.createElementNS("http://www.w3.org/2000/svg","circle");U.setAttribute("cx",0),U.setAttribute("cy",0),U.setAttribute("r",1.5*P),U.setAttribute("class","rotation-circle");const C=document.createElementNS("http://www.w3.org/2000/svg","line");C.setAttribute("x1",-P),C.setAttribute("y1",-P),C.setAttribute("x2",P),C.setAttribute("y2",P),C.setAttribute("class","rotation-x-line");const E=document.createElementNS("http://www.w3.org/2000/svg","line");E.setAttribute("x1",P),E.setAttribute("y1",-P),E.setAttribute("x2",-P),E.setAttribute("y2",P),E.setAttribute("class","rotation-x-line");const M=document.createElementNS("http://www.w3.org/2000/svg","circle");M.setAttribute("cx",0),M.setAttribute("cy",0),M.setAttribute("r",2*P),M.setAttribute("class","rotation-hitbox"),w.appendChild(U),w.appendChild(C),w.appendChild(E),w.appendChild(M),w.addEventListener("mousedown",e=>{e.stopPropagation(),startRotatingPath(e,t)}),w.addEventListener("dblclick",e=>{e.stopPropagation(),resetRotationPivot(t)}),UI.layerHandles.appendChild(w)}function getShapeCenter(t){const e=t.points;let a=0,n=0;return e.forEach(t=>{a+=t.p.x,n+=t.p.y}),{x:a/e.length,y:n/e.length}}function resetRotationPivot(t){const e=AppState.paths[t],a=e.points,n=Math.min(...a.map(t=>t.p.x)),o=Math.min(...a.map(t=>t.p.y)),s=Math.max(...a.map(t=>t.p.x)),i=Math.max(...a.map(t=>t.p.y));e.rotationPivot={x:(n+s)/2,y:(o+i)/2},renderSelectionHandles(),setStatus("Rotation pivot reset to center.")}function startRotatingPath(t,e){if("select"!==AppState.mode)return;t.preventDefault(),t.stopPropagation(),AppState.selectedPathIndices.includes(e)||toggleSelection(e,!1);const a=getSVGPoint(t.clientX,t.clientY),n=AppState.paths[e];if(!n.rotationPivot){const t=n.points,e=Math.min(...t.map(t=>t.p.x)),a=Math.min(...t.map(t=>t.p.y)),o=Math.max(...t.map(t=>t.p.x)),s=Math.max(...t.map(t=>t.p.y));n.rotationPivot={x:(e+o)/2,y:(a+s)/2}}if(t.ctrlKey||t.metaKey)AppState.isMovingPivot=!0,AppState.isRotating=!1,AppState.rotatingPathIndex=e,saveState(),setStatus("Moving Rotation Pivot...");else{AppState.isRotating=!0,AppState.isMovingPivot=!1,AppState.rotatingPathIndex=e;const t=n.rotationPivot;AppState.rotationStartAngle=Math.atan2(a.y-t.y,a.x-t.x),AppState.rotationPivot=t,AppState.rotationApplied=0,clearHandles(),AppState.rotationGhostElements=[];const o=UI.layerPaths.querySelector(`path[data-index="${e}"]`);if(o){const t=o.cloneNode(!0);t.removeAttribute("data-index"),t.classList.add("rotation-ghost"),UI.layerPathsActive.appendChild(t),AppState.rotationGhostElements.push(t)}const s=document.getElementById(`rot-handle-${e}`);if(s){const e=s.getAttribute("transform").match(/translate\(([^,]+),\s*([^)]+)\)/);if(e){const a=parseFloat(e[1]),n=parseFloat(e[2]);AppState.rotationHandleVector={x:a-t.x,y:n-t.y}}}saveState(),setStatus("Rotating... (Hold Ctrl to snap to 5)")}}function processRotation(t,e,a){if(AppState.isRotatingGroup){const n=AppState.rotationPivot;let o=Math.atan2(a-n.y,e-n.x)-AppState.rotationStartAngle;if(t.ctrlKey||t.metaKey){const t=5*Math.PI/180;o=Math.round(o/t)*t}const s=o-AppState.rotationApplied;if(Math.abs(s)>1e-4){const t=Math.cos(s),e=Math.sin(s);AppState.selectedPathIndices.forEach(a=>{const o=AppState.paths[a];if(o.points.forEach(a=>{const o=a.p.x-n.x,s=a.p.y-n.y;a.p.x=n.x+o*t-s*e,a.p.y=n.y+o*e+s*t;const i=a.cIn.x-n.x,r=a.cIn.y-n.y;a.cIn.x=n.x+i*t-r*e,a.cIn.y=n.y+i*e+r*t;const p=a.cOut.x-n.x,l=a.cOut.y-n.y;a.cOut.x=n.x+p*t-l*e,a.cOut.y=n.y+p*e+l*t}),o.rotationPivot){const a=o.rotationPivot.x-n.x,s=o.rotationPivot.y-n.y;o.rotationPivot.x=n.x+a*t-s*e,o.rotationPivot.y=n.y+a*e+s*t}updatePathD(a)}),AppState.rotationApplied=o}return}const n=AppState.rotatingPathIndex,o=AppState.paths[n],s=AppState.rotationPivot;let i=Math.atan2(a-s.y,e-s.x)-AppState.rotationStartAngle;if(t.ctrlKey||t.metaKey){const t=5*Math.PI/180;i=Math.round(i/t)*t}const r=i-AppState.rotationApplied;if(Math.abs(r)>1e-4){const t=Math.cos(r),e=Math.sin(r);o.points.forEach(a=>{const n=a.p.x-s.x,o=a.p.y-s.y;a.p.x=s.x+n*t-o*e,a.p.y=s.y+n*e+o*t;const i=a.cIn.x-s.x,r=a.cIn.y-s.y;a.cIn.x=s.x+i*t-r*e,a.cIn.y=s.y+i*e+r*t;const p=a.cOut.x-s.x,l=a.cOut.y-s.y;a.cOut.x=s.x+p*t-l*e,a.cOut.y=s.y+p*e+l*t}),AppState.rotationApplied=i;const a=UI.layerHandles.querySelector(`.rotation-handle-group[data-path-index="${n}"]`);if(a&&AppState.rotationHandleVector){const t=AppState.rotationHandleVector.x,e=AppState.rotationHandleVector.y,n=s.x+t*Math.cos(i)-e*Math.sin(i),o=s.y+t*Math.sin(i)+e*Math.cos(i);a.setAttribute("transform",`translate(${n}, ${o})`)}updatePathD(n)}}function stopRotation(){AppState.isRotating&&(AppState.isRotating=!1,AppState.rotatingPathIndex=null,AppState.rotationGhostElements.length>0&&(AppState.rotationGhostElements.forEach(t=>t.remove()),AppState.rotationGhostElements=[]),renderSelectionHandles())}function createHandle(t,e,a,n,o,s=""){let i;const r="anchor"===a?getHandleSize():2*getControlRadius(),p=getControlRadius();if("anchor"===a)i=document.createElementNS("http://www.w3.org/2000/svg","rect"),i.setAttribute("x",e.x-r/2),i.setAttribute("y",e.y-r/2),i.setAttribute("width",r),i.setAttribute("height",r),i.setAttribute("class","handle-node"),i.addEventListener("dblclick",t=>{t.stopPropagation(),t.preventDefault(),deletePoint(n,o)}),i.addEventListener("mousedown",t=>{if(t.ctrlKey||t.metaKey)return t.stopPropagation(),t.preventDefault(),void deletePoint(n,o);t.stopPropagation(),startDraggingHandle(t,n,s,o)});else{const t=document.createElementNS("http://www.w3.org/2000/svg","g");t.setAttribute("class","handle-control");const a=document.createElementNS("http://www.w3.org/2000/svg","circle");a.setAttribute("cx",e.x),a.setAttribute("cy",e.y),a.setAttribute("r",p),a.setAttribute("class","handle-control-bg"),a.setAttribute("vector-effect","non-scaling-stroke"),t.appendChild(a);const r=document.createElementNS("http://www.w3.org/2000/svg","path");r.setAttribute("class","handle-control-inner");const l=AppState.paths[o].points[n].p;let c;c=e.x-l.x>=0?`M ${e.x} ${e.y-p} A ${p} ${p} 0 0 1 ${e.x} ${e.y+p} L ${e.x} ${e.y-p} Z`:`M ${e.x} ${e.y-p} A ${p} ${p} 0 0 0 ${e.x} ${e.y+p} L ${e.x} ${e.y-p} Z`,r.setAttribute("d",c),t.appendChild(r),t.addEventListener("mousedown",t=>{t.stopPropagation(),startDraggingHandle(t,n,s,o)}),i=t}t.appendChild(i)}function handlePathDoubleClick(t,e){if("select"!==AppState.mode)return;const a=getSVGPoint(t.clientX,t.clientY),n=AppState.paths[e],o=n.points;if(o.length<2)return;let s=1/0,i=-1,r=.5;for(let t=0;t<o.length-1;t++){const e=o[t],n=o[t+1],{t:p,dist:l}=getTFromPoint(e.p,e.cOut,n.cIn,n.p,a);l<s&&(s=l,i=t,r=p)}if(n.closed){const t=o[o.length-1],e=o[0],{t:n,dist:p}=getTFromPoint(t.p,t.cOut,e.cIn,e.p,a);p<s&&(s=p,i=o.length-1,r=n)}if(s<20&&-1!==i){saveState();const t=o[i],a=o[(i+1)%o.length],{leftNode:n,splitNode:s,rightNode:p}=splitBezierCurve(t.p,t.cOut,a.cIn,a.p,r);o[i].cOut=n.cOut,i===o.length-1?(o[0].cIn=p.cIn,o.push(s)):(o[i+1].cIn=p.cIn,o.splice(i+1,0,s)),updatePathD(e),renderSelectionHandles()}}function deletePoint(t,e){const a=AppState.paths[e];if(!a||a.points.length<=2)return;saveState();const n=a.points,o=n.length,s=a.closed,i=t>0?t-1:s?o-1:-1,r=t<o-1?t+1:s?0:-1,p=n[t],l=-1!==i?n[i]:null,c=-1!==r?n[r]:null;if(l&&c){const t=l.p,e=p.p,a=c.p,n={x:e.x-t.x,y:e.y-t.y},o={x:e.x-a.x,y:e.y-a.y},s=Math.hypot(n.x,n.y),i=Math.hypot(o.x,o.y);if(s>.01&&i>.01){const r={x:n.x/s,y:n.y/s},p={x:o.x/i,y:o.y/i},d=8/3,u=(e.x,t.x,a.x,e.y,t.y,a.y,{x:(8*e.x-t.x-a.x)/3,y:(8*e.y-t.y-a.y)/3}),h={x:u.x-t.x-a.x,y:u.y-t.y-a.y},g=r.x*p.y-r.y*p.x;let y=0,S=0;if(Math.abs(g)>1e-4){y=(h.x*p.y-h.y*p.x)/g,S=(r.x*h.y-r.y*h.x)/g;const t=2*(s+i);y=Math.max(0,Math.min(y,t)),S=Math.max(0,Math.min(S,t))}else y=s/3,S=i/3;l.cOut={x:t.x+r.x*y,y:t.y+r.y*y},c.cIn={x:a.x+p.x*S,y:a.y+p.y*S}}else l.cOut={...t},c.cIn={...a}}else l?l.cOut={...l.p}:c&&(c.cIn={...c.p});a.points.splice(t,1),updatePathD(e),renderSelectionHandles()}function startDraggingHandle(t,e,a,n){if("select"!==AppState.mode)return;t.preventDefault(),t.stopPropagation(),AppState.isDraggingHandle=!0,AppState.activeHandleIndex={index:e,subType:a,pathIndex:n};const o=getSVGPoint(t.clientX,t.clientY);if(AppState.dragStartMouse={x:o.x,y:o.y},""===a)AppState.snapTarget=null;else{const t=AppState.paths[n],o=t.points[e].p,s="cOut"===a?t.points[e].cOut:t.points[e].cIn;AppState.dragStartControlLength=Math.hypot(s.x-o.x,s.y-o.y)}}function startDraggingPath(t,e){if("select"!==AppState.mode)return;t.preventDefault(),AppState.selectedPathIndices.includes(e)||toggleSelection(e,t.shiftKey),AppState.isDraggingPath=!0;const a=getSVGPoint(t.clientX,t.clientY);AppState.dragStartMouse={x:a.x,y:a.y}}function startDraggingSegment(t,e){if("select"!==AppState.mode)return;t.preventDefault(),t.stopPropagation();const a=getSVGPoint(t.clientX,t.clientY),n=AppState.paths[e],{index:o,dist:s}=getNearestSegmentIndex(n,a);-1!==o&&s<20?(toggleSelection(e,t.shiftKey),AppState.isDraggingSegment=!0,AppState.activeSegmentIndex=o,AppState.activePathIndex=e,AppState.dragStartMouse={x:a.x,y:a.y}):toggleSelection(e,t.shiftKey)}function getSnapThresholdInWorldCoords(){const t=AppState.view.zoom,e=AppState.styles.baseSnapThreshold;if(t<1){return e/t+5}return e/t}function findSnapTarget(t,e,a,n,o){let s=null,i=o;return AppState.paths.forEach((o,r)=>{o.points.forEach((o,p)=>{if(r===a&&Math.abs(p-n)<=1)return;const l=Math.hypot(o.p.x-t,o.p.y-e);l<i&&(i=l,s={type:"anchor",x:o.p.x,y:o.p.y,pathIdx:r,ptIdx:p})})}),s||AppState.paths.forEach((r,p)=>{for(let l=0;l<r.points.length-1;l++){if(p===a&&Math.abs(l-n)<=1)continue;const c=r.points[l],d=r.points[l+1],u=Math.min(c.p.x,d.p.x)-o,h=Math.max(c.p.x,d.p.x)+o,g=Math.min(c.p.y,d.p.y)-o,y=Math.max(c.p.y,d.p.y)+o;if(t<u||t>h||e<g||e>y)continue;const{t:S,dist:A}=getTFromPoint(c.p,c.cOut,d.cIn,d.p,{x:t,y:e});if(A<i){i=A;const t=cubicBezier(c.p,c.cOut,d.cIn,d.p,S);s={type:"segment",x:t.x,y:t.y,pathIdx:p,segIdx:l,t:S}}}}),s}function processDrag(t,e,a){if(AppState.isMovingPivot){if(AppState.selectedPathIndices.length>1)AppState.groupPivot={x:e,y:a};else if(null!==AppState.rotatingPathIndex){const t=AppState.paths[AppState.rotatingPathIndex];t&&(t.rotationPivot={x:e,y:a})}const t=UI.layerHandles.querySelector(".rotation-pivot-indicator"),n=UI.layerHandles.querySelector(".rotation-pivot-center");return t&&(t.setAttribute("x2",e),t.setAttribute("y2",a)),void(n&&(n.setAttribute("cx",e),n.setAttribute("cy",a)))}if(AppState.isRotating)processRotation(t,e,a);else if(AppState.isDraggingHandle){const{index:t,subType:n,pathIndex:o}=AppState.activeHandleIndex,s=AppState.paths[o].points[t];let i=s.p;"cOut"===n&&(i=s.cOut),"cIn"===n&&(i=s.cIn);const r=e-AppState.dragStartMouse.x,p=a-AppState.dragStartMouse.y;let l=i.x+r,c=i.y+p;if(""===n&&AppState.snapEnabled){const n=getSnapThresholdInWorldCoords(),i=findSnapTarget(l,c,o,t,n);if(i){if(Math.hypot(e-i.x,a-i.y)<=n){l=i.x,c=i.y,AppState.isSnapping=!0,AppState.snapTarget=i,UI.layerSnap.style.display="block";const t=n,e=5/AppState.view.zoom;UI.snapRing.setAttribute("cx",l),UI.snapRing.setAttribute("cy",c),UI.snapRing.setAttribute("r",t),UI.snapCenter.setAttribute("cx",l),UI.snapCenter.setAttribute("cy",c),UI.snapCenter.setAttribute("r",e)}else AppState.isSnapping=!1,AppState.snapTarget=null,UI.layerSnap.style.display="none"}else AppState.isSnapping=!1,AppState.snapTarget=null,UI.layerSnap.style.display="none";const r=l-s.p.x,p=c-s.p.y;s.cIn.x+=r,s.cIn.y+=p,s.cOut.x+=r,s.cOut.y+=p}else UI.layerSnap.style.display="none";i.x=l,i.y=c,AppState.dragStartMouse={x:e,y:a},updatePathD(o),renderSelectionHandles()}else if(AppState.isDraggingPath){UI.layerSnap.style.display="none";const t=e-AppState.dragStartMouse.x,n=a-AppState.dragStartMouse.y;AppState.selectedPathIndices.forEach(e=>{const a=AppState.paths[e];a.points.forEach(e=>{e.p.x+=t,e.p.y+=n,e.cIn.x+=t,e.cIn.y+=n,e.cOut.x+=t,e.cOut.y+=n}),a.rotationPivot&&(a.rotationPivot.x+=t,a.rotationPivot.y+=n);UI.layerPaths.querySelector(`path[data-index="${e}"]`)&&updatePathD(e)}),AppState.dragStartMouse={x:e,y:a},renderSelectionHandles()}else if(AppState.isDraggingSegment){UI.layerSnap.style.display="none";const t=e-AppState.dragStartMouse.x,n=a-AppState.dragStartMouse.y,o=AppState.paths[AppState.activePathIndex],s=AppState.activeSegmentIndex;let i,r;s===o.points.length-1?(i=s,r=0):(i=s,r=s+1),o.points[i].cOut.x+=t,o.points[i].cOut.y+=n,o.points[r].cIn.x+=t,o.points[r].cIn.y+=n,AppState.dragStartMouse={x:e,y:a},updatePathD(AppState.activePathIndex),renderSelectionHandles()}}function stopDrag(){if(UI.layerSnap.style.display="none",AppState.isMovingPivot)return AppState.isMovingPivot=!1,AppState.rotatingPathIndex=null,renderSelectionHandles(),void setStatus("Rotation pivot placed.");if(AppState.isRotating)return stopRotation(),void saveState();if(AppState.isDraggingHandle||AppState.isDraggingPath||AppState.isDraggingSegment){if(AppState.selectedPathIndices.forEach(t=>updatePathD(t)),AppState.isDraggingHandle&&AppState.snapTarget){const{index:t,subType:e,pathIndex:a}=AppState.activeHandleIndex,n=AppState.snapTarget,o=AppState.paths[a];if(""===e){if(saveState(),"anchor"===n.type&&n.pathIdx===a){const e=o.points,a=0===t,s=t===e.length-1,i=0===n.ptIdx,r=n.ptIdx===e.length-1;if(!o.closed&&(a&&r||s&&i)){const t=e[0],n=e[e.length-1];a?(t.p.x=n.p.x,t.p.y=n.p.y):(n.p.x=t.p.x,n.p.y=t.p.y);const s=50,i=Math.atan2(n.cIn.y-n.p.y,n.cIn.x-n.p.x);n.cOut={x:n.p.x-Math.cos(i)*s,y:n.p.y-Math.sin(i)*s};const r=Math.atan2(t.cOut.y-t.p.y,t.cOut.x-t.p.x);t.cIn={x:t.p.x-Math.cos(r)*s,y:t.p.y-Math.sin(r)*s},o.closed=!0,setStatus("Shape closed."),updateCloseShapeUI()}}if("segment"===n.type){const e=AppState.paths[n.pathIdx],s=e.points[n.segIdx],i=e.points[n.segIdx+1],{leftNode:r,splitNode:p,rightNode:l}=splitBezierCurve(s.p,s.cOut,i.cIn,i.p,n.t);n.pathIdx===a?(n.segIdx<t&&t++,e.points[n.segIdx].cOut=r.cOut,e.points[n.segIdx+1].cIn=l.cIn,e.points.splice(n.segIdx+1,0,p),o.points[t].p.x=p.p.x,o.points[t].p.y=p.p.y,o.points[t].cIn.x=p.cIn.x,o.points[t].cIn.y=p.cIn.y):(e.points[n.segIdx].cOut=r.cOut,e.points[n.segIdx+1].cIn=l.cIn,e.points.splice(n.segIdx+1,0,p),o.points[t].p.x=p.p.x,o.points[t].p.y=p.p.y,o.points[t].cIn.x=p.cIn.x,o.points[t].cIn.y=p.cIn.y)}}}AppState.isDraggingHandle=!1,AppState.isDraggingPath=!1,AppState.isDraggingSegment=!1,AppState.activeHandleIndex=null,AppState.activeSegmentIndex=null,AppState.activePathIndex=null,AppState.isSnapping=!1,AppState.snapTarget=null,saveState()}}function activateColorPicker(){AppState.referenceImage?(AppState.colorPickerActive=!0,UI.btnColorPicker.classList.add("active"),UI.strokeColor.classList.add("color-input-highlight"),UI.fillColor.classList.add("color-input-highlight"),AppState.selectedColorInput=null,setStatus("Color picker active.")):setStatus("No reference image loaded.")}function deactivateColorPicker(){AppState.colorPickerActive=!1,UI.btnColorPicker.classList.remove("active"),UI.strokeColor.classList.remove("color-input-highlight","color-input-selected"),UI.fillColor.classList.remove("color-input-highlight","color-input-selected"),AppState.selectedColorInput=null,setStatus("Color picker deactivated.")}function selectColorInput(t){AppState.colorPickerActive&&(AppState.selectedColorInput&&AppState.selectedColorInput.classList.remove("color-input-selected"),AppState.selectedColorInput=t,t.classList.add("color-input-selected"),setStatus(`Selected ${"stroke-color"===t.id?"stroke":"fill"} color.`))}function pickColorFromReference(t,e){if(!AppState.colorPickerActive||!AppState.selectedColorInput||!AppState.referenceImage)return;const a=AppState.referenceImage,n=document.createElement("canvas"),o=n.getContext("2d");n.width=a.width,n.height=a.height,o.drawImage(a,0,0);const s=UI.bgLayer.getBoundingClientRect(),i=t-s.left,r=e-s.top,p=a.width/a.height;let l,c,d,u;p>s.width/s.height?(l=s.width,c=s.width/p,d=0,u=(s.height-c)/2):(c=s.height,l=s.height*p,d=(s.width-l)/2,u=0);const h=Math.floor((i-d)*(a.width/l)),g=Math.floor((r-u)*(a.height/c));if(h>=0&&h<a.width&&g>=0&&g<a.height){const t=o.getImageData(h,g,1,1).data,e="#"+((1<<24)+(t[0]<<16)+(t[1]<<8)+t[2]).toString(16).slice(1);AppState.selectedColorInput.value=e,"stroke-color"===AppState.selectedColorInput.id?updateStyleProperty("strokeColor",e):updateStyleProperty("fillColor",e),deactivateColorPicker(),setStatus(`Color ${e} picked.`)}}function reversePathPoints(t){t.points.reverse(),t.points.forEach(t=>{const e=t.cIn;t.cIn=t.cOut,t.cOut=e})}function traceColorAt(t,e){if(!AppState.referenceImage)return;const a=AppState.referenceImage,n=document.getElementById("color-canvas"),o=n.getContext("2d",{willReadFrequently:!0}),s=UI.bgLayer.getBoundingClientRect(),i=t-s.left,r=e-s.top,p=a.width/a.height;let l,c,d,u;p>s.width/s.height?(l=s.width,c=s.width/p,d=0,u=(s.height-c)/2):(c=s.height,l=s.height*p,d=(s.width-l)/2,u=0);let h=a.width,g=a.height;const y=Math.min(1,400/h,400/g);h=Math.floor(h*y),g=Math.floor(g*y),n.width=h,n.height=g,o.drawImage(a,0,0,h,g);const S=Math.floor((i-d)/l*h),A=Math.floor((r-u)/c*g);if(S<0||S>=h||A<0||A>=g)return;const x=o.getImageData(0,0,h,g).data,m=4*(A*h+S),I=x[m],b=x[m+1],v=x[m+2];if(0===x[m+3])return void setStatus("Cannot trace transparent area.");const f=new Uint8Array(h*g),w=new Int32Array(h*g*2);let P=0,U=0;const C=t=>{const e=x[t],a=x[t+1],n=x[t+2];return x[t+3]>15&&Math.abs(e-I)<=32&&Math.abs(a-b)<=32&&Math.abs(n-v)<=32};w[U++]=S,w[U++]=A,f[A*h+S]=1;let E=0;const M=h*g*.5;for(;P<U;){const t=w[P++],e=w[P++];if(E++,E>M)return void setStatus("Area too large, aborted.");if(t>0){const a=e*h+(t-1);0===f[a]&&C(4*a)&&(f[a]=1,w[U++]=t-1,w[U++]=e)}if(t<h-1){const a=e*h+(t+1);0===f[a]&&C(4*a)&&(f[a]=1,w[U++]=t+1,w[U++]=e)}if(e>0){const a=(e-1)*h+t;0===f[a]&&C(4*a)&&(f[a]=1,w[U++]=t,w[U++]=e-1)}if(e<g-1){const a=(e+1)*h+t;0===f[a]&&C(4*a)&&(f[a]=1,w[U++]=t,w[U++]=e+1)}}let k=-1,L=-1;for(let t=0;t<g;t++){for(let e=0;e<h;e++)if(1===f[t*h+e]){k=e,L=t;break}if(-1!==k)break}if(-1===k)return void setStatus("Could not identify shape.");const O=[];let D=k,H=L;const $=[0,1,1,1,0,-1,-1,-1],T=[-1,-1,0,1,1,1,0,-1];let N=6,z=0;do{if(O.push({x:D,y:H}),z++,z>h*g)break;let t=!1,e=(N+1)%8;for(let a=0;a<8;a++){let n=(e+a)%8,o=D+$[n],s=H+T[n];if(o>=0&&o<h&&s>=0&&s<g&&1===f[s*h+o]){D=o,H=s,N=(n+4)%8,t=!0;break}}if(!t)break}while(D!==k||H!==L);const R=ramerDouglasPeucker(O,4).map(t=>{const e=t.x/y,n=t.y/y,o=getSVGPoint(e/a.width*l+d+s.left,n/a.height*c+u+s.top);return{x:o.x,y:o.y}});if(R.length<3)return void setStatus("Trace failed (points < 3).");const B=calculateControlPoints(R),F={strokeColor:AppState.styles.strokeColor,fillColor:"none",strokeOpacity:1,fillOpacity:0,width:parseInt(AppState.styles.width)||2,points:B,closed:!0};saveState(),AppState.paths.push(F),AppState.selectedPathIndices=[AppState.paths.length-1],rebuildCanvas(),setStatus("Outline traced."),setMode("select")}function setMode(t){AppState.mode=t,updateFabIcon(),"draw"===t?(UI.body.className="mode-draw",UI.btnDraw.classList.add("active"),UI.btnSelect.classList.remove("active"),AppState.selectedPathIndices=[],updateSelectionVisuals(),setStatus("<b>Draw Mode:</b> Sketch freely."),UI.toolbar.classList.add("minimized"),UI.fab.classList.add("visible"),UI.fab.classList.remove("fab-right")):"trace"===t?(UI.body.className="mode-select",UI.btnDraw.classList.remove("active"),UI.btnSelect.classList.remove("active"),setStatus("<b>Trace Mode:</b> Click a color region.")):(stopDrawing(),UI.body.className="mode-select",UI.btnSelect.classList.add("active"),UI.btnDraw.classList.remove("active"),setStatus("Select Mode. <b>Right Click</b> or <b>2 Fingers</b> to Pan."),UI.toolbar.classList.remove("minimized"),UI.fab.classList.add("visible"),UI.fab.classList.add("fab-right"))}function clearBackground(){UI.bgLayer.style.backgroundImage="none",AppState.referenceImage=null,setStatus("Background cleared.")}function updateStyleProperty(t,e,a=!1){AppState.styles[t]=a?parseFloat(e):e,AppState.selectedPathIndices.length>0&&AppState.selectedPathIndices.forEach(a=>{AppState.paths[a][t]=AppState.styles[t];const n=UI.layerPaths.querySelector(`path[data-index="${a}"]`)||UI.layerPathsActive.querySelector(`path[data-index="${a}"]`);n&&("strokeColor"===t&&n.setAttribute("stroke",e),"fillColor"===t&&n.setAttribute("fill",e),"width"===t&&n.setAttribute("stroke-width",e),"strokeOpacity"===t&&n.setAttribute("stroke-opacity",e),"fillOpacity"===t&&n.setAttribute("fill-opacity",e))})}function deleteSelectedPaths(){if(0===AppState.selectedPathIndices.length)return;const t=[...AppState.selectedPathIndices].sort((t,e)=>e-t);saveState(),t.forEach(t=>{let e=UI.layerPaths.querySelector(`path[data-index="${t}"]`);e||(e=UI.layerPathsActive.querySelector(`path[data-index="${t}"]`)),e&&e.remove(),AppState.paths.splice(t,1)}),AppState.selectedPathIndices=[],clearHandles();Array.from(UI.layerPaths.children).concat(Array.from(UI.layerPathsActive.children)).forEach((t,e)=>t.dataset.index=e),updateSelectionVisuals()}function copySelectedPaths(){if(0===AppState.selectedPathIndices.length)return;const t=[...AppState.selectedPathIndices].sort((t,e)=>t-e);AppState.clipboard=t.map(t=>JSON.parse(JSON.stringify(AppState.paths[t])))}function getSelectionBoundingBox(){if(0===AppState.selectedPathIndices.length)return null;let t=1/0,e=1/0,a=-1/0,n=-1/0;return AppState.selectedPathIndices.forEach(o=>{const s=AppState.paths[o];s&&s.points&&s.points.forEach(o=>{t=Math.min(t,o.p.x),e=Math.min(e,o.p.y),a=Math.max(a,o.p.x),n=Math.max(n,o.p.y)})}),t===1/0?null:{x:t,y:e,width:a-t,height:n-e,cx:(t+a)/2,cy:(e+n)/2}}function flipSelectedPaths(t){if(0===AppState.selectedPathIndices.length)return;saveState();const e=getSelectionBoundingBox();if(!e)return;const a="horizontal"===t?e.cx:e.cy;AppState.selectedPathIndices.forEach(e=>{const n=AppState.paths[e];n.points.forEach(e=>{"horizontal"===t?(e.p.x=2*a-e.p.x,e.cIn.x=2*a-e.cIn.x,e.cOut.x=2*a-e.cOut.x):(e.p.y=2*a-e.p.y,e.cIn.y=2*a-e.cIn.y,e.cOut.y=2*a-e.cOut.y)}),n.rotationPivot&&("horizontal"===t?n.rotationPivot.x=2*a-n.rotationPivot.x:n.rotationPivot.y=2*a-n.rotationPivot.y),updatePathD(e)}),renderSelectionHandles(),setStatus(`Flipped ${t}ly.`)}function pasteClipboard(t={x:20,y:20}){if(!AppState.clipboard||0===AppState.clipboard.length)return;saveState();const e=[];AppState.clipboard.forEach(a=>{a.points.forEach(e=>{e.p.x+=t.x,e.p.y+=t.y,e.cIn.x+=t.x,e.cIn.y+=t.y,e.cOut.x+=t.x,e.cOut.y+=t.y}),a.rotationPivot&&(a.rotationPivot.x+=t.x,a.rotationPivot.y+=t.y),AppState.paths.push(a),e.push(AppState.paths.length-1)}),AppState.selectedPathIndices=e,rebuildCanvas(),updateSelectionVisuals(),setStatus(`Pasted ${e.length} shape(s).`)}function duplicateSelectedPaths(){0!==AppState.selectedPathIndices.length&&(copySelectedPaths(),pasteClipboard({x:0,y:0}))}function preventDefaults(t){t.preventDefault(),t.stopPropagation()}function handleFiles(t){const e=t[0];if(e.type.startsWith("image/")&&"image/svg+xml"!==e.type){const t=new FileReader;return t.readAsDataURL(e),void(t.onloadend=function(){const e=new Image;e.crossOrigin="Anonymous",e.onload=function(){AppState.referenceImage=e,UI.bgLayer.style.backgroundImage=`url('${t.result}')`,setStatus("Background set.")},e.src=t.result})}if("image/svg+xml"===e.type||e.name.endsWith(".svg")){if(0===AppState.paths.length){const t=new FileReader;t.readAsText(e),t.onloadend=function(){try{const e=new DOMParser,a=e.parseFromString(t.result,"image/svg+xml").querySelectorAll("path");if(a.length>0){saveState();let t=0;a.forEach(e=>{const a=e.getAttribute("d");if(!a)return;const n=parsePathDToPoints(a);if(n.length>0){const o={strokeColor:e.getAttribute("stroke")||"#ffffff",fillColor:e.getAttribute("fill")||"#000000",strokeOpacity:e.getAttribute("stroke-opacity")||1,fillOpacity:e.getAttribute("fill-opacity")||0,width:parseInt(e.getAttribute("stroke-width"))||4,points:n,closed:a.trim().endsWith("Z")};AppState.paths.push(o),t++}}),rebuildCanvas(),setStatus(`Imported ${t} paths.`)}}catch(t){console.error(t),setStatus("Error parsing SVG.")}}}else{const t=new FileReader;t.readAsDataURL(e),t.onloadend=function(){const e=new Image;e.crossOrigin="Anonymous",e.onload=function(){AppState.referenceImage=e,UI.bgLayer.style.backgroundImage=`url('${t.result}')`,setStatus("SVG set as background.")},e.src=t.result}}}}function parsePathDToPoints(t){const e=[],a=t.match(/[a-zA-Z][^a-zA-Z]*/g);if(!a)return[];let n=0,o=0,s=0,i=0;return a.forEach(t=>{const a=t[0],r=t.slice(1).trim().split(/[\s,]+/).map(Number).filter(t=>!isNaN(t));if("M"===a||"m"===a){let t=r[0],p=r[1];"m"===a&&(t+=n,p+=o),e.push({p:{x:t,y:p},cIn:{x:t,y:p},cOut:{x:t,y:p}}),n=t,o=p,s=t,i=p;for(let s=2;s<r.length;s+=2)t=r[s],p=r[s+1],"m"===a&&(t+=n,p+=o),e.push({p:{x:t,y:p},cIn:{x:t,y:p},cOut:{x:t,y:p}}),n=t,o=p}else if("L"===a||"l"===a)for(let t=0;t<r.length;t+=2){let s=r[t],i=r[t+1];"l"===a&&(s+=n,i+=o),e.push({p:{x:s,y:i},cIn:{x:s,y:i},cOut:{x:s,y:i}}),n=s,o=i}else if("C"===a||"c"===a)for(let t=0;t<r.length;t+=6){let s=r[t],i=r[t+1],p=r[t+2],l=r[t+3],c=r[t+4],d=r[t+5];"c"===a&&(s+=n,i+=o,p+=n,l+=o,c+=n,d+=o),e.length>0&&(e[e.length-1].cOut={x:s,y:i}),e.push({p:{x:c,y:d},cIn:{x:p,y:l},cOut:{x:c,y:d}}),n=c,o=d}else"Z"!==a&&"z"!==a||(n=s,o=i)}),e}UI.btnDraw.addEventListener("click",()=>setMode("draw")),UI.btnSelect.addEventListener("click",()=>setMode("select")),UI.btnCloseToolbar.addEventListener("click",toggleToolbar),UI.fab.addEventListener("click",()=>{setMode("draw"===AppState.mode?"select":"draw")}),UI.btnSnap.addEventListener("click",()=>{AppState.snapEnabled=!AppState.snapEnabled,UI.btnSnap.classList.toggle("active",AppState.snapEnabled),UI.btnSnap.classList.toggle("pressed",AppState.snapEnabled),setStatus(AppState.snapEnabled?"Snap enabled":"Snap disabled")}),UI.btnColorPicker.addEventListener("click",()=>{AppState.colorPickerActive?deactivateColorPicker():activateColorPicker()}),UI.strokeColor.addEventListener("mouseenter",()=>selectColorInput(UI.strokeColor)),UI.fillColor.addEventListener("mouseenter",()=>selectColorInput(UI.fillColor)),UI.strokeColor.addEventListener("click",()=>selectColorInput(UI.strokeColor)),UI.fillColor.addEventListener("click",()=>selectColorInput(UI.fillColor)),UI.btnHelp.addEventListener("click",t=>{t.stopPropagation(),UI.helpPanel.classList.add("visible")}),UI.btnUndo.addEventListener("click",t=>{t.stopPropagation(),undo()}),UI.btnRedo.addEventListener("click",t=>{t.stopPropagation(),redo()}),UI.closeHelp.addEventListener("click",t=>{t.stopPropagation(),UI.helpPanel.classList.remove("visible")}),document.addEventListener("click",t=>{!UI.helpPanel.classList.contains("visible")||UI.helpPanel.contains(t.target)||UI.btnHelp.contains(t.target)||UI.helpPanel.classList.remove("visible")}),document.addEventListener("click",t=>{!UI.helpPanel.classList.contains("visible")||UI.helpPanel.contains(t.target)||UI.btnHelp.contains(t.target)||UI.helpPanel.classList.remove("visible")}),UI.btnZoomUI.addEventListener("click",()=>{const t="flex"===UI.zoomControls.style.display;UI.zoomControls.style.display=t?"none":"flex",t||(UI.zoomSlider.value=AppState.view.zoom,UI.zoomVal.textContent=Math.round(100*AppState.view.zoom)+"%",setStatus("Use slider to zoom."))}),UI.zoomSlider.addEventListener("input",t=>{const e=t.target.value;UI.zoomVal.textContent=Math.round(100*e)+"%",zoomCentered(e)}),UI.btnImport.addEventListener("click",()=>UI.fileInput.click()),UI.fileInput.addEventListener("change",t=>{t.target.files.length>0&&(handleFiles(t.target.files),UI.fileInput.value="")}),UI.btnClearRef.addEventListener("click",clearBackground),UI.btnTraceColor.addEventListener("click",()=>{AppState.referenceImage?(setMode("trace"),setStatus("Trace Mode: Click on the reference image to trace a color region.")):setStatus("Import a reference image first.")}),UI.btnCloseShape.addEventListener("click",()=>{if(saveState(),AppState.selectedPathIndices.length>=2){const t=[...AppState.selectedPathIndices].sort((t,e)=>t-e);let e=t[0];const a=AppState.paths[e];for(let e=1;e<t.length;e++){const n=t[e],o=AppState.paths[n],s=a.points[0].p,i=a.points[a.points.length-1].p,r=o.points[0].p,p=o.points[o.points.length-1].p,l=Math.hypot(s.x-r.x,s.y-r.y),c=Math.hypot(s.x-p.x,s.y-p.y),d=Math.hypot(i.x-r.x,i.y-r.y),u=Math.hypot(i.x-p.x,i.y-p.y);let h=[...o.points],g=!1;const y=Math.min(l,c,d,u);y===d||(y===c?(reversePathPoints(a),g=!0):y===u?g=!0:y===l&&reversePathPoints(a)),g&&(h.reverse(),h.forEach(t=>{const e=t.cIn;t.cIn=t.cOut,t.cOut=e})),a.points=a.points.concat(h),a.closed=!1}for(let e=t.length-1;e>0;e--){const a=UI.layerPaths.querySelector(`path[data-index="${t[e]}"]`);a&&a.remove(),AppState.paths.splice(t[e],1)}return updatePathD(e),AppState.selectedPathIndices=[e],rebuildCanvas(),void setStatus(`Merged ${t.length} paths into one.`)}if(1===AppState.selectedPathIndices.length){const t=AppState.selectedPathIndices[0],e=AppState.paths[t];if(e.closed=!e.closed,e.closed){const t=e.points[0],a=e.points[e.points.length-1],n=Math.hypot(t.p.x-a.p.x,t.p.y-a.p.y),o=.25*n;if(n>0){const e=(t.p.x-a.p.x)/n,s=(t.p.y-a.p.y)/n;Math.hypot(a.cOut.x-a.p.x,a.cOut.y-a.p.y)<1&&(a.cOut.x=a.p.x+e*o,a.cOut.y=a.p.y+s*o),Math.hypot(t.cIn.x-t.p.x,t.cIn.y-t.p.y)<1&&(t.cIn.x=t.p.x-e*o,t.cIn.y=t.p.y-s*o)}setStatus("Shape closed. Fill remains at "+100*e.fillOpacity+"%.")}else{const t=e.points[0],a=e.points[e.points.length-1];t.cIn={...t.p},a.cOut={...a.p},setStatus("Shape opened.")}return updatePathD(t),renderSelectionHandles(),void updateCloseShapeUI()}AppState.styles.autoClose=!AppState.styles.autoClose,setStatus(AppState.styles.autoClose?"New shapes will auto-close.":"New shapes will stay open."),updateCloseShapeUI()}),window.addEventListener("mousemove",t=>{if(AppState.lastMouse.x=t.clientX,AppState.lastMouse.y=t.clientY,AppState.isPanning){const e=t.clientX-AppState.panStartMouse.x,a=t.clientY-AppState.panStartMouse.y;return AppState.view.x+=e,AppState.view.y+=a,AppState.panStartMouse={x:t.clientX,y:t.clientY},void updateViewportTransform()}const e=getSVGPoint(t.clientX,t.clientY);if("draw"!==AppState.mode||UI.toolbar.classList.contains("minimized")||checkToolbarProximity(t.clientX),"draw"===AppState.mode)AppState.isDrawing?drawMove(e.x,e.y):startDrawing(e.x,e.y);else if(AppState.isMovingPivot||AppState.isRotating||AppState.isDraggingHandle||AppState.isDraggingPath||AppState.isDraggingSegment)processDrag(t,e.x,e.y);else if(AppState.isBoxSelecting){const t=Math.min(AppState.boxStart.x,e.x),a=Math.min(AppState.boxStart.y,e.y),n=Math.abs(e.x-AppState.boxStart.x),o=Math.abs(e.y-AppState.boxStart.y);UI.selectionRect.setAttribute("x",t),UI.selectionRect.setAttribute("y",a),UI.selectionRect.setAttribute("width",n),UI.selectionRect.setAttribute("height",o)}}),window.addEventListener("wheel",t=>{if(t.ctrlKey||t.metaKey){t.preventDefault();zoom(t.deltaY<0?1.1:.9,t.clientX,t.clientY)}},{passive:!1}),UI.canvas.addEventListener("contextmenu",t=>t.preventDefault()),UI.app.addEventListener("mousedown",t=>{if(t.target.closest("#toolbar")||t.target.closest("#help-panel")||t.target.closest("#fab"))return;if("trace"===AppState.mode){if(2===t.button)return AppState.isPanning=!0,AppState.panStartMouse={x:t.clientX,y:t.clientY},void UI.body.classList.add("panning");if(0===t.button)return void traceColorAt(t.clientX,t.clientY)}if(2===t.button)return AppState.isPanning=!0,AppState.panStartMouse={x:t.clientX,y:t.clientY},void UI.body.classList.add("panning");if(2===t.button)return AppState.isPanning=!0,AppState.panStartMouse={x:t.clientX,y:t.clientY},void UI.body.classList.add("panning");if("draw"===AppState.mode)return void(AppState.colorPickerActive&&AppState.selectedColorInput&&pickColorFromReference(t.clientX,t.clientY));const e="rect"===t.target.tagName||"circle"===t.target.tagName,a=t.target.classList.contains("path-element"),n=t.target.classList.contains("handle-closing-line"),o=t.target.closest(".path-mover-group");if(t.target.closest(".rotation-handle-group"));else if(n){startDraggingSegment(t,parseInt(t.target.dataset.index))}else if(a){startDraggingSegment(t,parseInt(t.target.dataset.index))}else if(!e&&!o)if(AppState.colorPickerActive&&AppState.selectedColorInput)pickColorFromReference(t.clientX,t.clientY);else{t.shiftKey||toggleSelection(-1,!1),AppState.isBoxSelecting=!0;const e=getSVGPoint(t.clientX,t.clientY);AppState.boxStart=e,UI.selectionRect.setAttribute("x",e.x),UI.selectionRect.setAttribute("y",e.y),UI.selectionRect.setAttribute("width",0),UI.selectionRect.setAttribute("height",0),UI.selectionRect.style.display="block"}}),window.addEventListener("mouseup",()=>{if("draw"===AppState.mode?stopDrawing():stopDrag(),AppState.isPanning&&(AppState.isPanning=!1,UI.body.classList.remove("panning")),AppState.isBoxSelecting){AppState.isBoxSelecting=!1,UI.selectionRect.style.display="none";const t=parseFloat(UI.selectionRect.getAttribute("x")),e=parseFloat(UI.selectionRect.getAttribute("y")),a=parseFloat(UI.selectionRect.getAttribute("width")),n=parseFloat(UI.selectionRect.getAttribute("height"));(a>5||n>5)&&(AppState.paths.forEach((o,s)=>{const i=UI.layerPaths.querySelector(`path[data-index="${s}"]`)||UI.layerPathsActive.querySelector(`path[data-index="${s}"]`);if(i){const o=i.getBBox();t<o.x+o.width&&t+a>o.x&&e<o.y+o.height&&e+n>o.y&&(AppState.selectedPathIndices.includes(s)||AppState.selectedPathIndices.push(s))}}),AppState.selectedPathIndices.length>0&&updateSelectionVisuals())}}),UI.canvas.addEventListener("touchstart",t=>{if(2===t.touches.length){t.preventDefault(),AppState.isDrawing&&stopDrawing(),"draw"===AppState.mode&&setMode("select"),AppState.isPanning=!0;const e=(t.touches[0].clientX+t.touches[1].clientX)/2,a=(t.touches[0].clientY+t.touches[1].clientY)/2;AppState.panStartMouse={x:e,y:a},initialPinchDistance=Math.hypot(t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY),initialPinchZoom=AppState.view.zoom}else if(1===t.touches.length&&"draw"===AppState.mode){t.preventDefault();const e=t.touches[0],a=getSVGPoint(e.clientX,e.clientY);startDrawing(a.x,a.y)}},{passive:!1}),UI.canvas.addEventListener("touchmove",t=>{if(AppState.isPanning&&2===t.touches.length){t.preventDefault();const e=(t.touches[0].clientX+t.touches[1].clientY)/2,a=(t.touches[0].clientY+t.touches[1].clientY)/2,n=e-AppState.panStartMouse.x,o=a-AppState.panStartMouse.y;AppState.view.x+=n,AppState.view.y+=o;const s=Math.hypot(t.touches[0].clientX-t.touches[1].clientX,t.touches[0].clientY-t.touches[1].clientY);if(initialPinchDistance){const t=Math.max(.1,Math.min(5,initialPinchZoom*(s/initialPinchDistance))),n=t/AppState.view.zoom;AppState.view.x=e-(e-AppState.view.x)*n,AppState.view.y=a-(a-AppState.view.y)*n,AppState.view.zoom=t,initialPinchDistance=s,initialPinchZoom=t}AppState.panStartMouse={x:e,y:a},updateViewportTransform()}else if(AppState.isDrawing&&1===t.touches.length){t.preventDefault();const e=t.touches[0],a=getSVGPoint(e.clientX,e.clientY);drawMove(a.x,a.y)}},{passive:!1}),UI.canvas.addEventListener("touchend",t=>{AppState.isPanning&&t.touches.length<2&&(AppState.isPanning=!1,UI.body.classList.remove("panning"),initialPinchDistance=null),AppState.isDrawing&&stopDrawing()}),window.addEventListener("wheel",t=>{if(t.ctrlKey||t.metaKey){t.preventDefault();zoom(t.deltaY<0?1.1:.9,t.clientX,t.clientY)}},{passive:!1}),window.addEventListener("keydown",t=>{const e=t.key.toLowerCase();if(!t.ctrlKey&&!t.metaKey||"c"!==e)if(!t.ctrlKey&&!t.metaKey||"v"!==e){if("d"===e&&AppState.selectedPathIndices.length>0)return t.preventDefault(),void duplicateSelectedPaths();if((t.ctrlKey||t.metaKey)&&t.key.startsWith("Arrow")){const e=50;switch(t.key){case"ArrowLeft":AppState.view.x+=e;break;case"ArrowRight":AppState.view.x-=e;break;case"ArrowUp":AppState.view.y+=e;break;case"ArrowDown":AppState.view.y-=e}return t.preventDefault(),void updateViewportTransform()}if("+"!==e&&"="!==e&&"i"!==e)if("-"!==e&&"_"!==e&&"o"!==e)if(","!==e&&"0"!==e){if("Space"===t.code)return t.preventDefault(),void setMode("draw"===AppState.mode?"select":"draw");if("x"!==e)if((t.ctrlKey||t.metaKey)&&"z"===e)t.preventDefault(),undo();else if((t.ctrlKey||t.metaKey)&&"y"===e)t.preventDefault(),redo();else if("z"===e)undo();else if("y"===e)redo();else if("delete"===e||"backspace"===e)AppState.selectedPathIndices.length>0?deleteSelectedPaths():clearBackground();else{if("h"===e)return void flipSelectedPaths("horizontal");if("v"===e)return void flipSelectedPaths("vertical")}else toggleToolbar()}else resetView();else zoom(.8);else zoom(1.2)}else AppState.clipboard&&pasteClipboard();else AppState.selectedPathIndices.length>0&&(copySelectedPaths(),setStatus(`Copied ${AppState.selectedPathIndices.length} path(s).`))}),UI.widthSlider.addEventListener("input",t=>{const e=t.target.value;updateStyleProperty("width",e),UI.widthVal.textContent=e+"px"}),UI.widthSlider.addEventListener("change",()=>{AppState.selectedPathIndices.length>0&&saveState()}),UI.strokeColor.addEventListener("input",t=>updateStyleProperty("strokeColor",t.target.value)),UI.strokeColor.addEventListener("change",()=>{AppState.selectedPathIndices.length>0&&saveState()}),UI.fillColor.addEventListener("input",t=>updateStyleProperty("fillColor",t.target.value)),UI.fillColor.addEventListener("change",()=>{AppState.selectedPathIndices.length>0&&saveState()}),UI.strokeOpacity.addEventListener("input",t=>updateStyleProperty("strokeOpacity",t.target.value,!0)),UI.strokeOpacity.addEventListener("change",()=>{AppState.selectedPathIndices.length>0&&saveState()}),UI.fillOpacity.addEventListener("input",t=>updateStyleProperty("fillOpacity",t.target.value,!0)),UI.fillOpacity.addEventListener("change",()=>{AppState.selectedPathIndices.length>0&&saveState()}),UI.btnDelete.addEventListener("click",deleteSelectedPaths),UI.btnClear.addEventListener("click",()=>{saveState(),AppState.paths=[],AppState.selectedPathIndices=[],UI.layerPaths.innerHTML="",UI.layerPathsActive.innerHTML="",UI.layerHandles.innerHTML="",updateSelectionVisuals(),setStatus("Canvas cleared.")}),UI.btnExport.addEventListener("click",()=>{if(0===AppState.paths.length)return void setStatus("No paths to export.");const t=document.createElementNS("http://www.w3.org/2000/svg","svg");t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t.setAttribute("viewBox",`0 0 ${window.innerWidth} ${window.innerHeight}`),AppState.paths.forEach(e=>{const a=document.createElementNS("http://www.w3.org/2000/svg","path");a.setAttribute("stroke",e.strokeColor),a.setAttribute("stroke-width",e.width),a.setAttribute("stroke-opacity",void 0!==e.strokeOpacity?e.strokeOpacity:1),a.setAttribute("fill",e.fillColor),a.setAttribute("fill-opacity",void 0!==e.fillOpacity?e.fillOpacity:0),a.setAttribute("stroke-linecap","round"),a.setAttribute("stroke-linejoin","round");const n=e.points;let o=`M ${n[0].p.x.toFixed(1)} ${n[0].p.y.toFixed(1)}`;for(let t=0;t<n.length-1;t++){const e=n[t],a=n[t+1];o+=` C ${e.cOut.x.toFixed(1)} ${e.cOut.y.toFixed(1)}, ${a.cIn.x.toFixed(1)} ${a.cIn.y.toFixed(1)}, ${a.p.x.toFixed(1)} ${a.p.y.toFixed(1)}`}if(e.closed){const t=n[0],e=n[n.length-1];o+=` C ${e.cOut.x.toFixed(1)} ${e.cOut.y.toFixed(1)}, ${t.cIn.x.toFixed(1)} ${t.cIn.y.toFixed(1)}, ${t.p.x.toFixed(1)} ${t.p.y.toFixed(1)} Z`}a.setAttribute("d",o),t.appendChild(a)});let e=(new XMLSerializer).serializeToString(t);e.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)||(e=e.replace(/^<svg/,'<svg xmlns="http://www.w3.org/2000/svg"'));const a=new Blob([e],{type:"image/svg+xml;charset=utf-8"}),n=URL.createObjectURL(a),o=document.createElement("a");o.href=n,o.download=`slidus_${(new Date).toISOString()}.svg`,o.style.display="none",document.body.appendChild(o),o.click(),setTimeout(()=>{document.body.removeChild(o),URL.revokeObjectURL(n),setStatus("SVG exported.")},100)}),["dragenter","dragover","dragleave","drop"].forEach(t=>{UI.app.addEventListener(t,preventDefaults,!1),document.body.addEventListener(t,preventDefaults,!1)}),UI.app.addEventListener("dragenter",()=>document.body.classList.add("drag-over")),UI.app.addEventListener("dragleave",t=>{t.relatedTarget&&!UI.app.contains(t.relatedTarget)&&document.body.classList.remove("drag-over")}),UI.app.addEventListener("drop",t=>{document.body.classList.remove("drag-over");const e=t.dataTransfer.files;e.length>0&&handleFiles(e)});let panInterval=null;const panAmount=50;UI.panControls.querySelectorAll(".pan-btn").forEach(t=>{const e=e=>{e.preventDefault();const a=t.dataset.dir,n=()=>{"left"===a?AppState.view.x+=50:"right"===a?AppState.view.x-=50:"up"===a?AppState.view.y+=50:"down"===a&&(AppState.view.y-=50),updateViewportTransform()};n(),panInterval=setInterval(n,100)},a=()=>{clearInterval(panInterval)};t.addEventListener("mousedown",e),t.addEventListener("touchstart",e),window.addEventListener("mouseup",a),window.addEventListener("touchend",a),window.addEventListener("wheel",t=>{if(t.ctrlKey||t.metaKey){t.preventDefault();zoom(t.deltaY<0?1.1:.9,t.clientX,t.clientY)}},{passive:!1})}),setMode("select")</script></body></html>
