<!--
Copyright (c) 2026 Hyperagon

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
-->
<!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>Hexano 7.1</title><style type="text/css">body,html{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background-color:#1a1a1a;color:#e0e0e0;font-family:Courier,CourierNew,sans-serif;font-weight:700;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-touch-callout:none}.app-container{display:flex;flex-direction:column;width:100%;height:100%}.hexboard-container{flex-grow:1;display:flex;justify-content:center;align-items:center;overflow:hidden;position:relative;width:100%;height:100%}.hexboard{display:block;transform-origin:center center;transition:transform .3s ease}.control-bar{flex-shrink:0;z-index:10;display:block;position:relative;padding:10px 20px;background-color:#2a2a2a;border-bottom:1px solid #000;text-align:center}.control-bar button,.control-bar select{background:0 0;border:none;color:#e0e0e0;cursor:pointer;font-size:16px;margin:0 5px;vertical-align:middle}.control-bar select{background-color:#333;border:1px solid #555;padding:5px}.control-bar input[type=range]{width:100px;cursor:pointer;vertical-align:middle}#record-button{width:32px;height:32px;border:2px solid #e0e0e0;border-radius:50%;display:inline-block;position:relative;transition:border-color .2s,box-shadow .3s}#record-button.recording{border-color:#ff4136;animation:pulse 1.5s infinite}#record-indicator{width:18px;height:18px;background-color:#ff4136;border-radius:50%;position:absolute;top:50%;left:50%;margin-top:-9px;margin-left:-9px;transform:scale(0);transition:transform .2s ease-in-out}#record-button.recording #record-indicator{transform:scale(1)}#fullscreen-button,#instrument-button,#play-button{width:32px;height:32px;padding:0;display:inline-block;vertical-align:middle;position:relative}.icon{width:100%;height:100%;fill:currentColor}.instrument-selector{position:relative;display:inline-block}.instrument-dropdown{position:absolute;top:100%;left:0;background-color:#333;border:1px solid #555;border-radius:5px;padding:5px 0;margin-top:5px;min-width:150px;display:none;z-index:100}.instrument-dropdown.active{display:block}.instrument-option{padding:8px 15px;cursor:pointer;display:flex;align-items:center}.instrument-option:hover{background-color:#444}.instrument-option.selected{background-color:#4a4a4a}.instrument-option .icon{width:20px;height:20px;margin-right:10px}.overlay-panel{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:600px;height:400px;background-color:#333;border:2px solid #555;border-radius:10px;z-index:1000;display:none;box-shadow:0 5px 25px rgba(0,0,0,.8);flex-direction:column;padding:20px;box-sizing:border-box}.overlay-panel.active{display:flex}.overlay-panel .close-btn{position:absolute;top:10px;right:10px;width:30px;height:30px;background-color:#555;border:none;border-radius:50%;color:#e0e0e0;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}.overlay-panel .close-btn:hover{background-color:#666}.panel-header{text-align:center;margin-bottom:10px}.panel-header h2{margin:0;padding:0}.panel-content{flex-grow:1;overflow-y:auto;background-color:#222;border-radius:5px;padding:10px;margin-bottom:15px}.note-list-header{display:flex;padding:5px 10px;border-bottom:2px solid #555;font-weight:700;color:#e0e0e0}.note-item{display:flex;padding:5px 10px;border-bottom:1px solid #444;align-items:center}.note-item:last-child{border-bottom:none}.note-name{font-weight:700;flex:1;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.note-freq{color:#aaa;flex:1;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.note-time{color:#aaa;flex:1;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.note-duration{color:#aaa;flex:1;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.panel-buttons{display:grid;grid-template-columns:1fr 1fr;gap:10px}.panel-button{background-color:#444;border:1px solid #666;border-radius:5px;color:#e0e0e0;padding:8px 15px;cursor:pointer;transition:background-color .2s;flex:1;min-width:120px;display:flex;align-items:center;justify-content:center}.panel-button:hover{background-color:#555}.wave-selector{display:inline-flex;margin:0 5px;vertical-align:middle}.wave-option{width:60px;height:30px;background-color:#333;border:1px solid #555;margin:0 2px;cursor:pointer;position:relative;transition:all .2s}.wave-option:hover{background-color:#444}.wave-option.selected{background-color:#555;border-color:#777}.wave-option svg{width:100%;height:100%}.wave-option path{stroke:#e0e0e0;stroke-width:1.5;fill:none}.piano-svg{display:block}.hexagon{cursor:pointer;stroke:black;stroke-width:1px;transition:fill 50ms ease-in-out}.note-text{fill:white;stroke:black;stroke-width:1px;text-anchor:middle;font-size:200%;font-weight:700;pointer-events:none}.note-key{fill:black;stroke:black;stroke-width:1px;text-anchor:middle;font-size:120%;font-weight:400;pointer-events:none}.hexagon[data-note-name^="C"]:not([data-note-name*="#"]){fill:rgba(231,76,60,1)}.hexagon[data-note-name^="D"]:not([data-note-name*="#"]){fill:rgba(241,196,15,1)}.hexagon[data-note-name^="E"]{fill:rgba(46,204,113,1)}.hexagon[data-note-name^="F"]:not([data-note-name*="#"]){fill:rgba(52,152,219,1)}.hexagon[data-note-name^="G"]:not([data-note-name*="#"]){fill:rgba(155,89,182,1)}.hexagon[data-note-name^="A"]:not([data-note-name*="#"]){fill:rgba(230,126,34,1)}.hexagon[data-note-name^="B"]{fill:rgba(26,188,156,1)}.hexagon[data-note-name*="C#"]{fill:rgba(100,65,30,1)}.hexagon[data-note-name*="D#"]{fill:rgba(80,95,45,1)}.hexagon[data-note-name*="F#"]{fill:rgba(65,60,95,1)}.hexagon[data-note-name*="G#"]{fill:rgba(95,65,75,1)}.hexagon[data-note-name*="A#"]{fill:rgba(65,85,75,1)}.hexagon[data-note-name^="C"]:not([data-note-name*="#"]).active{fill:rgba(255,120,120,1)}.hexagon[data-note-name^="D"]:not([data-note-name*="#"]).active{fill:rgba(250,220,120,1)}.hexagon[data-note-name^="E"].active{fill:rgba(80,230,110,1)}.hexagon[data-note-name^="F"]:not([data-note-name*="#"]).active{fill:rgba(100,210,250,1)}.hexagon[data-note-name^="G"]:not([data-note-name*="#"]).active{fill:rgba(185,130,210,1)}.hexagon[data-note-name^="A"]:not([data-note-name*="#"]).active{fill:rgba(250,160,50,1)}.hexagon[data-note-name^="B"].active{fill:rgba(80,210,190,1)}.hexagon[data-note-name*="C#"].active{fill:rgba(140,95,50,1)}.hexagon[data-note-name*="D#"].active{fill:rgba(110,125,65,1)}.hexagon[data-note-name*="F#"].active{fill:rgba(85,80,115,1)}.hexagon[data-note-name*="G#"].active{fill:rgba(115,85,95,1)}.hexagon[data-note-name*="A#"].active{fill:rgba(85,105,95,1)}@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,65,54,.7)}70%{box-shadow:0 0 0 10px rgba(255,65,54,0)}100%{box-shadow:0 0 0 0 rgba(255,65,54,0)}}.progress-container{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:300px;background-color:#333;border:1px solid #555;border-radius:5px;padding:15px;z-index:2000;display:none;box-shadow:0 5px 25px rgba(0,0,0,.8)}.progress-container.active{display:block}.progress-bar{width:100%;height:10px;background-color:#222;border-radius:5px;margin-top:10px;overflow:hidden}.progress-fill{height:100%;background-color:#4caf50;background-color:#9bbc0f!important;width:0%;transition:width .3s}.progress-text{text-align:center;margin-bottom:5px}.gameboy-theme{background-color:#9bbc0f!important}.guitar-theme{background-color:#8b4513!important}.snes-theme{background-color:#5d4e37!important}.drums-theme{background-color:#3a3a3a!important}.bell-theme{background-color:#d4af37!important}.flute-theme{background-color:sienna!important}.violin-theme{background-color:#5d4037!important}.ukulele-theme{background-color:#deb887!important}.tuba-theme{background-color:#4e342e!important}.custom-theme{background-color:#2e8b57!important}@keyframes pulse-green{0%{box-shadow:0 0 0 0 rgba(46,204,113,.7)}70%{box-shadow:0 0 0 10px rgba(46,204,113,0)}100%{box-shadow:0 0 0 0 rgba(46,204,113,0)}}#record-button.generating{border-color:#2ecc71;animation:pulse-green 1s infinite}#gen-settings-panel{width:350px;height:auto;max-height:80%}.setting-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid #444}.setting-row:last-child{border-bottom:none;margin-bottom:0}.setting-label{font-size:14px;color:#e0e0e0;width:120px}.setting-control{flex-grow:1;text-align:right}.setting-control input[type=range],.setting-control select{background-color:#222;color:#e0e0e0;border:1px solid #555;padding:5px;border-radius:4px;width:100%;max-width:150px;box-sizing:border-box}.setting-value{font-size:12px;color:#aaa;margin-left:5px;min-width:30px;display:inline-block}.gen-btn-container{margin-top:20px;width:100%}.gen-btn{width:100%;padding:10px;background-color:#4caf50;color:#fff;border:none;border-radius:5px;font-size:16px;font-weight:700;cursor:pointer;transition:background-color .2s}.gen-btn:hover{background-color:#45a049}</style><script type="text/javascript">"use strict";var DEBUG=!1;document.addEventListener("DOMContentLoaded",function(){var e=document.querySelector(".hexboard-container"),t=document.querySelector(".hexboard"),n=document.getElementById("record-button"),a=document.getElementById("play-button"),o=document.getElementById("play-icon"),i=document.getElementById("stop-icon"),r=document.getElementById("instrument-button"),l=document.getElementById("instrument-dropdown"),c=(document.getElementById("wave-type"),document.getElementById("volume-slider")),u=document.getElementById("fullscreen-button"),s=document.getElementById("fullscreen-enter-icon"),d=document.getElementById("fullscreen-exit-icon"),m=document.getElementById("overlay-panel"),p=document.getElementById("panel-close-btn"),y=document.getElementById("panel-content"),v=document.getElementById("import-json-btn"),f=document.getElementById("import-audio-btn"),g=(document.getElementById("export-json-btn"),document.getElementById("export-audio-btn"),document.getElementById("file-input")),h=document.getElementById("audio-file-input"),E=document.getElementById("progress-container"),b=document.getElementById("progress-fill"),x=document.getElementById("progress-text"),q=null;(v=document.getElementById("import-json-btn")).addEventListener("click",function(){document.getElementById("file-input").click()}),(f=document.getElementById("import-audio-btn")).addEventListener("click",function(){document.getElementById("audio-file-input").click()}),document.getElementById("export-json-btn").addEventListener("click",function(){if(0===S.length)return void alert("No melody to export. Record a melody first.");var e={name:"Hexano Melody",date:(new Date).toISOString(),notes:S},t=JSON.stringify(e,null,2),n="data:application/json;charset=utf-8,"+encodeURIComponent(t),a=`hexano_${(new Date).toISOString()}.json`,o=document.createElement("a");o.setAttribute("href",n),o.setAttribute("download",a),o.click()}),document.getElementById("export-audio-btn").addEventListener("click",function(){if(0===S.length)return void alert("No melody to export. Record a melody first.");E.classList.add("active"),x.textContent="Rendering audio file...",b.style.width="10%",Me()});g=document.getElementById("file-input"),h=document.getElementById("audio-file-input"),E=document.getElementById("progress-container"),b=document.getElementById("progress-fill"),x=document.getElementById("progress-text");var T,C,w=window.AudioContext||window.webkitAudioContext,A={},B=!0,k=!1,G=!1,V=!1,S=[{note:"C5",freq:523.251,time:0,duration:300},{note:"D5",freq:587.33,time:400,duration:300},{note:"E5",freq:659.255,time:800,duration:300},{note:"F5",freq:698.456,time:1200,duration:300},{note:"A5",freq:880,time:1600,duration:600},{note:"G5",freq:783.991,time:2200,duration:600},{note:"A5",freq:880,time:3200,duration:600},{note:"G5",freq:783.991,time:3800,duration:300},{note:"F5",freq:698.456,time:4100,duration:300},{note:"E5",freq:659.255,time:4400,duration:600},{note:"G5",freq:783.991,time:5e3,duration:600},{note:"D5",freq:587.33,time:5600,duration:600}],R=[],I={},N={},L=null,F=!1,D=null,M=null,O=!1,z=null,U=function(e){return{name:e,type:"Instrument",activeNodes:A}},P={create:function(){var e=U("Default");return e.init=function(){},e.playNote=function(e,t){try{var n=T.currentTime;if(!C||C.context!==T){if(!T)return;(C=T.createGain()).gain.value=c?c.value:.5,C.connect(T.destination)}var a=T.createOscillator(),o=T.createGain(),i=document.querySelector(".wave-option.selected");a.type=i?i.getAttribute("data-wave-type"):"sine";var r=Math.round(1e3*t)/1e3;a.frequency.setValueAtTime(r,n),o.gain.setValueAtTime(0,n),o.gain.linearRampToValueAtTime(.15,n+.02),a.connect(o),o.connect(C),a.start(n),A[e]={oscillator:a,gainNode:o}}catch(e){console.error("Error playing note:",e)}},e.stopNote=function(e){var t=A[e];if(t)try{var n=T.currentTime,a=t.gainNode;a.gain.cancelScheduledValues(n),a.gain.setValueAtTime(a.gain.value,n),a.gain.linearRampToValueAtTime(0,n+.1),t.oscillator.stop(n+.1+.01),delete A[e]}catch(t){console.error("Error stopping note:",t),delete A[e]}},e.render=function(e,t,n,a,o){var i=e.createOscillator(),r=e.createGain(),l=document.querySelector(".wave-option.selected");i.type=l?l.getAttribute("data-wave-type"):"sine",i.frequency.value=t.freq;r.gain.setValueAtTime(0,n),r.gain.linearRampToValueAtTime(.7,n+.02),r.gain.setValueAtTime(.7,n+a),r.gain.linearRampToValueAtTime(0,n+a+.1),i.connect(r),r.connect(o),i.start(n),i.stop(n+a+.1)},e.cleanup=function(){},e}},Q={create:function(){var e=U("Gameboy");return e.init=function(){document.body.classList.add("gameboy-theme"),function(){document.querySelector(".wave-selector").style.display="none";var e=document.querySelector(".control-bar"),t=document.createElement("div");t.id="gameboy-controls",t.style.display="inline-flex",t.style.marginLeft="10px";var n=document.createElement("div");n.className="control-group",n.style.marginRight="10px";var a=document.createElement("label");a.textContent="Wave",a.style.marginBottom="5px",a.style.fontSize="0.8em";var o=document.createElement("select");o.id="gameboy-wave",o.style.width="120px";var i=document.createElement("option");i.value="square",i.textContent="Pulse (50%)",o.appendChild(i);var r=document.createElement("option");r.value="sawtooth",r.textContent="Pulse (25%)",o.appendChild(r);var l=document.createElement("option");l.value="triangle",l.textContent="Triangle",o.appendChild(l),n.appendChild(a),n.appendChild(o);var c=document.createElement("div");c.className="control-group",c.style.marginRight="10px";var u=document.createElement("label");u.textContent="Noise",u.style.marginBottom="5px",u.style.fontSize="0.8em";var s=document.createElement("select");s.id="gameboy-noise",s.style.width="120px";var d=document.createElement("option");d.value="white",d.textContent="White Noise",s.appendChild(d);var m=document.createElement("option");m.value="pink",m.textContent="Pink Noise",s.appendChild(m),c.appendChild(u),c.appendChild(s);var p=document.createElement("div");p.className="control-group",p.style.marginRight="10px";var y=document.createElement("label");y.textContent="Attack",y.id="gameboy-attack-label",y.style.marginBottom="5px",y.style.fontSize="0.8em";var v=document.createElement("input");v.type="range",v.id="gameboy-attack",v.min="0",v.max="0.5",v.step="0.01",v.value="0",v.style.width="100px",v.addEventListener("input",function(){document.getElementById("gameboy-attack-label").textContent="Attack"}),p.appendChild(y),p.appendChild(v);var f=document.createElement("div");f.className="control-group";var g=document.createElement("label");g.textContent="Release",g.id="gameboy-release-label",g.style.marginBottom="5px",g.style.fontSize="0.8em";var h=document.createElement("input");h.type="range",h.id="gameboy-release",h.min="0",h.max="1",h.step="0.01",h.value="0.3",h.style.width="100px",h.addEventListener("input",function(){document.getElementById("gameboy-release-label").textContent="Release"}),f.appendChild(g),f.appendChild(h),t.appendChild(n),t.appendChild(c),t.appendChild(p),t.appendChild(f),e.appendChild(t)}()},e.playNote=function(e,t){try{if(!C||C.context!==T){if(!T)return;(C=T.createGain()).gain.value=c?c.value:.5,C.connect(T.destination)}var n=T.currentTime,a="square",o="white",i=0,r=.3,l=document.getElementById("gameboy-wave"),u=document.getElementById("gameboy-noise"),s=document.getElementById("gameboy-attack"),d=document.getElementById("gameboy-release");l&&(a=l.value),u&&(o=u.value),s&&(i=parseFloat(s.value)),d&&(r=parseFloat(d.value));for(var m=T.createOscillator(),p=T.createGain(),y=T.createBufferSource(),v=T.createGain(),f=2*T.sampleRate,g=T.createBuffer(1,f,T.sampleRate),h=g.getChannelData(0),E=0;E<f;E++)h[E]="white"===o?2*Math.random()-1:(2*Math.random()-1)*(E/f);y.buffer=g,y.loop=!0,m.type=a;var b=Math.round(1e3*t)/1e3;m.frequency.setValueAtTime(b,n),v.gain.value=.005,m.connect(p),y.connect(v),p.connect(C),v.connect(C),p.gain.setValueAtTime(0,n),p.gain.linearRampToValueAtTime(.12,n+i),m.start(n),y.start(n),A[e]={oscillator:m,gainNode:p,noiseBuffer:y,noiseGain:v,releaseTime:r}}catch(e){console.error("Error playing Gameboy note:",e)}},e.stopNote=function(e){var t=A[e];if(t)try{var n=T.currentTime,a=t.releaseTime||.3;if(t.oscillator)try{t.oscillator.stop(n+a)}catch(e){}if(t.noiseBuffer)try{t.noiseBuffer.stop(n+.01)}catch(e){}t.gainNode&&(t.gainNode.gain.cancelScheduledValues(n),t.gainNode.gain.setValueAtTime(t.gainNode.gain.value,n),t.gainNode.gain.linearRampToValueAtTime(0,n+a)),t.noiseGain&&(t.noiseGain.gain.cancelScheduledValues(n),t.noiseGain.gain.setValueAtTime(t.noiseGain.gain.value,n),t.noiseGain.gain.linearRampToValueAtTime(0,n+.01)),delete A[e]}catch(t){console.error("Error stopping Gameboy note:",t),delete A[e]}},e.render=function(e,t,n,a,o){for(var i=document.getElementById("gameboy-wave"),r=document.getElementById("gameboy-noise"),l=document.getElementById("gameboy-attack"),c=document.getElementById("gameboy-release"),u=i?i.value:"square",s=r?r.value:"white",d=l?parseFloat(l.value):0,m=c?parseFloat(c.value):.3,p=e.createOscillator(),y=e.createGain(),v=e.createBufferSource(),f=e.createGain(),g=.5*e.sampleRate,h=e.createBuffer(1,g,e.sampleRate),E=h.getChannelData(0),b=0;b<g;b++)E[b]=(2*Math.random()-1)*("white"===s?1:b/g);v.buffer=h,p.type=u,p.frequency.value=t.freq,f.gain.value=.02,y.gain.setValueAtTime(0,n),y.gain.linearRampToValueAtTime(.7,n+d),y.gain.setValueAtTime(.7,n+a),y.gain.linearRampToValueAtTime(0,n+a+m),p.connect(y),v.connect(f),y.connect(o),f.connect(o),p.start(n),v.start(n),p.stop(n+a+m),v.stop(n+a+m)},e.cleanup=function(){document.body.classList.remove("gameboy-theme"),function(){var e=document.getElementById("gameboy-controls");e&&e.parentNode.removeChild(e);document.querySelector(".wave-selector").style.display="inline-flex"}()},e}},j={create:function(){var e=U("Guitar");return e.init=function(){document.body.classList.add("guitar-theme"),function(){document.querySelector(".wave-selector").style.display="none";var e=document.querySelector(".control-bar"),t=document.createElement("div");t.id="guitar-controls",t.style.display="inline-flex",t.style.marginLeft="10px";var n=document.createElement("div");n.className="control-group",n.style.marginRight="10px";var a=document.createElement("label");a.textContent="Type",a.style.marginBottom="5px",a.style.fontSize="0.8em";var o=document.createElement("select");o.id="guitar-type",o.style.width="120px";var i=document.createElement("option");i.value="acoustic",i.textContent="Acoustic",o.appendChild(i);var r=document.createElement("option");r.value="electric",r.textContent="Electric",o.appendChild(r);var l=document.createElement("option");l.value="bass",l.textContent="Bass",o.appendChild(l),n.appendChild(a),n.appendChild(o);var c=document.createElement("div");c.className="control-group",c.style.marginRight="10px";var u=document.createElement("label");u.textContent="Damping",u.id="guitar-damping-label",u.style.marginBottom="5px",u.style.fontSize="0.8em";var s=document.createElement("input");s.type="range",s.id="guitar-damping",s.min="0.9",s.max="0.999",s.step="0.001",s.value="0.995",s.style.width="100px",s.addEventListener("input",function(){document.getElementById("guitar-damping-label").textContent="Damping"}),c.appendChild(u),c.appendChild(s);var d=document.createElement("div");d.className="control-group";var m=document.createElement("label");m.textContent="Body",m.id="guitar-body-label",m.style.marginBottom="5px",m.style.fontSize="0.8em";var p=document.createElement("input");p.type="range",p.id="guitar-body",p.min="0",p.max="1",p.step="0.01",p.value="0.3",p.style.width="100px",p.addEventListener("input",function(){document.getElementById("guitar-body-label").textContent="Body"}),d.appendChild(m),d.appendChild(p),t.appendChild(n),t.appendChild(c),t.appendChild(d),e.appendChild(t)}()},e.playNote=function(e,t){try{if(!T)return;var n=T.currentTime;C&&C.context===T||((C=T.createGain()).gain.value=c?c.value:.5,C.connect(T.destination));for(var a=document.getElementById("guitar-type"),o=(document.getElementById("guitar-damping"),document.getElementById("guitar-body")),i=a?a.value:"acoustic",r=(o&&parseFloat(o.value),T.createOscillator()),l=T.createGain(),u=T.createOscillator(),s=T.createOscillator(),d=T.createGain(),m=T.createGain(),p=T.createBiquadFilter(),y=T.createBufferSource(),v=T.createBuffer(1,.05*T.sampleRate,T.sampleRate),f=v.getChannelData(0),g=T.createGain(),h=0;h<v.length;h++)f[h]=.2*(2*Math.random()-1);y.buffer=v;var E=Math.round(1e3*t)/1e3;r.type="sawtooth",r.frequency.setValueAtTime(E,n),u.type="sine",u.frequency.setValueAtTime(2*E,n),d.gain.value=.1,s.type="sine",s.frequency.setValueAtTime(3*E,n),m.gain.value=.08,"acoustic"===i?(p.type="lowpass",p.frequency.value=2.5*E,p.Q.value=1):"electric"===i?(p.type="lowpass",p.frequency.value=4*E,p.Q.value=2):"bass"===i&&(p.type="lowpass",p.frequency.value=1.5*E,p.Q.value=.8),r.connect(l),u.connect(d),s.connect(m),d.connect(l),m.connect(l),y.connect(g),g.connect(p),l.connect(p),p.connect(C),g.gain.setValueAtTime(.1,n),g.gain.exponentialRampToValueAtTime(.01,n+.05),l.gain.setValueAtTime(0,n),l.gain.linearRampToValueAtTime(.15,n+.01),r.start(n),u.start(n),s.start(n),y.start(n),A[e]={oscillator:r,gainNode:l,harmonic1:u,harmonic2:s,harmonicGain1:d,harmonicGain2:m,filter:p,pluckNoise:y,pluckGain:g}}catch(e){console.error("Error playing guitar note:",e)}},e.stopNote=function(e){var t=A[e];if(t)try{var n=T.currentTime,a=.3;t.oscillator&&t.oscillator.stop(n+a),t.harmonic1&&t.harmonic1.stop(n+a),t.harmonic2&&t.harmonic2.stop(n+a),t.pluckNoise&&t.pluckNoise.stop(n+.01),t.gainNode&&(t.gainNode.gain.cancelScheduledValues(n),t.gainNode.gain.setValueAtTime(t.gainNode.gain.value,n),t.gainNode.gain.exponentialRampToValueAtTime(.01,n+a)),t.harmonicGain1&&(t.harmonicGain1.gain.cancelScheduledValues(n),t.harmonicGain1.gain.setValueAtTime(t.harmonicGain1.gain.value,n),t.harmonicGain1.gain.linearRampToValueAtTime(0,n+a)),t.harmonicGain2&&(t.harmonicGain2.gain.cancelScheduledValues(n),t.harmonicGain2.gain.setValueAtTime(t.harmonicGain2.gain.value,n),t.harmonicGain2.gain.linearRampToValueAtTime(0,n+a)),t.pluckGain&&(t.pluckGain.gain.cancelScheduledValues(n),t.pluckGain.gain.setValueAtTime(t.pluckGain.gain.value,n),t.pluckGain.gain.linearRampToValueAtTime(0,n+.01)),delete A[e]}catch(t){console.error("Error stopping guitar note:",t),delete A[e]}},e.render=function(e,t,n,a,o){},e.cleanup=function(){document.body.classList.remove("guitar-theme"),function(){var e=document.getElementById("guitar-controls");e&&e.parentNode.removeChild(e);document.querySelector(".wave-selector").style.display="inline-flex"}()},e}},H={create:function(){var e=U("SNES");return e.init=function(){document.body.classList.add("snes-theme"),function(){document.querySelector(".wave-selector").style.display="none";var e=document.querySelector(".control-bar"),t=document.createElement("div");t.id="snes-controls",t.style.display="inline-flex",t.style.marginLeft="10px";var n=document.createElement("div");n.className="control-group",n.style.marginRight="10px";var a=document.createElement("label");a.textContent="Instrument",a.style.marginBottom="5px",a.style.fontSize="0.8em";var o=document.createElement("select");o.id="snes-instrument",o.style.width="120px";var i=document.createElement("option");i.value="piano",i.textContent="Piano",o.appendChild(i);var r=document.createElement("option");r.value="strings",r.textContent="Strings",o.appendChild(r);var l=document.createElement("option");l.value="brass",l.textContent="Brass",o.appendChild(l);var c=document.createElement("option");c.value="woodwind",c.textContent="Woodwind",o.appendChild(c);var u=document.createElement("option");u.value="percussion",u.textContent="Percussion",o.appendChild(u),n.appendChild(a),n.appendChild(o);var s=document.createElement("div");s.className="control-group",s.style.marginRight="10px";var d=document.createElement("label");d.textContent="Reverb",d.id="snes-reverb-label",d.style.marginBottom="5px",d.style.fontSize="0.8em";var m=document.createElement("input");m.type="range",m.id="snes-reverb",m.min="0",m.max="1",m.step="0.05",m.value="0.3",m.style.width="100px",m.addEventListener("input",function(){document.getElementById("snes-reverb-label").textContent="Reverb"}),s.appendChild(d),s.appendChild(m);var p=document.createElement("div");p.className="control-group",p.style.marginRight="10px";var y=document.createElement("label");y.textContent="Attack",y.id="snes-attack-label",y.style.marginBottom="5px",y.style.fontSize="0.8em";var v=document.createElement("input");v.type="range",v.id="snes-attack",v.min="0",v.max="0.5",v.step="0.01",v.value="0.05",v.style.width="100px",v.addEventListener("input",function(){document.getElementById("snes-attack-label").textContent="Attack"}),p.appendChild(y),p.appendChild(v);var f=document.createElement("div");f.className="control-group";var g=document.createElement("label");g.textContent="Release",g.id="snes-release-label",g.style.marginBottom="5px",g.style.fontSize="0.8em";var h=document.createElement("input");h.type="range",h.id="snes-release",h.min="0",h.max="2",h.step="0.05",h.value="0.5",h.style.width="100px",h.addEventListener("input",function(){document.getElementById("snes-release-label").textContent="Release"}),f.appendChild(g),f.appendChild(h),t.appendChild(n),t.appendChild(s),t.appendChild(p),t.appendChild(f),e.appendChild(t)}()},e.playNote=function(e,t){try{if(!C||C.context!==T){if(!T)return;(C=T.createGain()).gain.value=c?c.value:.5,C.connect(T.destination)}for(var n=T.currentTime,a=document.getElementById("snes-instrument"),o=document.getElementById("snes-reverb"),i=document.getElementById("snes-attack"),r=document.getElementById("snes-release"),l=a?a.value:"piano",u=o?parseFloat(o.value):.3,s=i?parseFloat(i.value):.05,d=r?parseFloat(r.value):.5,m=T.createOscillator(),p=T.createGain(),y=T.createOscillator(),v=T.createOscillator(),f=T.createGain(),g=T.createGain(),h=T.createBiquadFilter(),E=T.createBiquadFilter(),b=T.createConvolver(),x=T.createGain(),q=T.createGain(),w=T.sampleRate*u*2,B=T.createBuffer(2,w,T.sampleRate),k=0;k<2;k++)for(var G=B.getChannelData(k),V=0;V<w;V++)G[V]=(2*Math.random()-1)*Math.pow(1-V/w,2);b.buffer=B,"piano"===l?(m.type="triangle",y.type="sine",v.type="sine",y.frequency.value=2*t,v.frequency.value=3*t,f.gain.value=.2,g.gain.value=.1,h.type="lowpass",h.frequency.value=4*t,h.Q.value=1,E.type="highpass",E.frequency.value=.5*t,E.Q.value=.5):"strings"===l?(m.type="sawtooth",y.type="sawtooth",v.type="sine",y.frequency.value=2*t,v.frequency.value=3*t,f.gain.value=.3,g.gain.value=.2,h.type="lowpass",h.frequency.value=3*t,h.Q.value=.8,E.type="highpass",E.frequency.value=.4*t,E.Q.value=.5):"brass"===l?(m.type="square",y.type="square",v.type="sine",y.frequency.value=2*t,v.frequency.value=1.5*t,f.gain.value=.4,g.gain.value=.3,h.type="lowpass",h.frequency.value=2.5*t,h.Q.value=1.5,E.type="highpass",E.frequency.value=.6*t,E.Q.value=.7):"woodwind"===l?(m.type="triangle",y.type="sine",v.type="sine",y.frequency.value=2.5*t,v.frequency.value=3.5*t,f.gain.value=.25,g.gain.value=.15,h.type="lowpass",h.frequency.value=3.5*t,h.Q.value=1.2,E.type="highpass",E.frequency.value=.5*t,E.Q.value=.6):"percussion"===l&&(m.type="square",y.type="square",v.type="triangle",y.frequency.value=1.5*t,v.frequency.value=.5*t,f.gain.value=.3,g.gain.value=.2,h.type="bandpass",h.frequency.value=1.2*t,h.Q.value=2,E.type="highpass",E.frequency.value=.3*t,E.Q.value=.8);var S=Math.round(1e3*t)/1e3;m.frequency.setValueAtTime(S,n),x.gain.value=.5*u,q.gain.value=1-.3*u,m.connect(p),y.connect(f),v.connect(g),f.connect(p),g.connect(p),p.connect(h),h.connect(E),E.connect(q),E.connect(x),q.connect(C),x.connect(b),b.connect(C),p.gain.setValueAtTime(0,n),p.gain.linearRampToValueAtTime(.15,n+s),m.start(n),y.start(n),v.start(n),A[e]={oscillator:m,gainNode:p,harmonic1:y,harmonic2:v,harmonicGain1:f,harmonicGain2:g,filter:h,filter2:E,convolver:b,reverbGain:x,dryGain:q,releaseTime:d}}catch(e){console.error("Error playing SNES note:",e)}},e.stopNote=function(e){var t=A[e];if(t&&!t.isStopping){t.isStopping=!0;try{var n=T.currentTime,a=t.releaseTime||.5;t.oscillator&&t.oscillator.stop(n+a),t.harmonic1&&t.harmonic1.stop(n+a),t.harmonic2&&t.harmonic2.stop(n+a),t.gainNode&&(t.gainNode.gain.cancelScheduledValues(n),t.gainNode.gain.setValueAtTime(t.gainNode.gain.value,n),t.gainNode.gain.linearRampToValueAtTime(0,n+a)),t.harmonicGain1&&(t.harmonicGain1.gain.cancelScheduledValues(n),t.harmonicGain1.gain.setValueAtTime(t.harmonicGain1.gain.value,n),t.harmonicGain1.gain.linearRampToValueAtTime(0,n+a)),t.harmonicGain2&&(t.harmonicGain2.gain.cancelScheduledValues(n),t.harmonicGain2.gain.setValueAtTime(t.harmonicGain2.gain.value,n),t.harmonicGain2.gain.linearRampToValueAtTime(0,n+a)),t.reverbGain&&(t.reverbGain.gain.cancelScheduledValues(n),t.reverbGain.gain.setValueAtTime(t.reverbGain.gain.value,n),t.reverbGain.gain.linearRampToValueAtTime(0,n+a)),t.dryGain&&(t.dryGain.gain.cancelScheduledValues(n),t.dryGain.gain.setValueAtTime(t.dryGain.gain.value,n),t.dryGain.gain.linearRampToValueAtTime(0,n+a)),setTimeout(function(){A[e]&&A[e].isStopping&&(A[e]=null,qe(e))},1e3*a)}catch(t){console.error("Error stopping SNES note:",t),A[e]=null,qe(e)}}},e.render=function(e,t,n,a,o){var i=document.getElementById("snes-instrument"),r=document.getElementById("snes-attack"),l=document.getElementById("snes-release"),c=i?i.value:"piano",u=r?parseFloat(r.value):.05,s=l?parseFloat(l.value):.5,d=e.createOscillator(),m=e.createGain(),p=e.createBiquadFilter();"piano"===c?(d.type="triangle",p.type="lowpass",p.frequency.value=4*t.freq):"strings"===c?(d.type="sawtooth",p.type="lowpass",p.frequency.value=3*t.freq):(d.type="square",p.type="lowpass",p.frequency.value=2.5*t.freq),d.frequency.value=t.freq,m.gain.setValueAtTime(0,n),m.gain.linearRampToValueAtTime(.7,n+u),m.gain.setValueAtTime(.7,n+a),m.gain.linearRampToValueAtTime(0,n+a+s),d.connect(p),p.connect(m),m.connect(o),d.start(n),d.stop(n+a+s)},e.cleanup=function(){document.body.classList.remove("snes-theme"),function(){var e=document.getElementById("snes-controls");e&&e.parentNode.removeChild(e);document.querySelector(".wave-selector").style.display="inline-flex"}()},e}},W={create:function(){var e=U("Drums & Percussion"),t={};return e.init=function(){document.body.classList.add("drums-theme"),function(){document.querySelector(".wave-selector").style.display="none";var e=document.querySelector(".control-bar"),t=document.createElement("div");t.id="drums-controls",t.style.display="inline-flex",t.style.marginLeft="10px";var n=document.createElement("div");n.className="control-group",n.style.marginRight="10px";var a=document.createElement("label");a.textContent="Drum Type",a.style.marginBottom="5px",a.style.fontSize="0.8em";var o=document.createElement("select");o.id="drums-type",o.style.width="120px";var i=document.createElement("option");i.value="kick",i.textContent="Kick",o.appendChild(i);var r=document.createElement("option");r.value="snare",r.textContent="Snare",o.appendChild(r);var l=document.createElement("option");l.value="tom",l.textContent="Tom",o.appendChild(l);var c=document.createElement("option");c.value="hihat",c.textContent="Hi-Hat",o.appendChild(c);var u=document.createElement("option");u.value="cymbal",u.textContent="Cymbal",o.appendChild(u),n.appendChild(a),n.appendChild(o);var s=document.createElement("div");s.className="control-group",s.style.marginRight="10px";var d=document.createElement("label");d.textContent="Pitch",d.id="drums-pitch-label",d.style.marginBottom="5px",d.style.fontSize="0.8em";var m=document.createElement("input");m.type="range",m.id="drums-pitch",m.min="0.5",m.max="2",m.step="0.1",m.value="1",m.style.width="100px",m.addEventListener("input",function(){document.getElementById("drums-pitch-label").textContent="Pitch"}),s.appendChild(d),s.appendChild(m);var p=document.createElement("div");p.className="control-group";var y=document.createElement("label");y.textContent="Decay",y.id="drums-decay-label",y.style.marginBottom="5px",y.style.fontSize="0.8em";var v=document.createElement("input");v.type="range",v.id="drums-decay",v.min="0.1",v.max="2",v.step="0.1",v.value="0.5",v.style.width="100px",v.addEventListener("input",function(){document.getElementById("drums-decay-label").textContent="Decay"}),p.appendChild(y),p.appendChild(v),t.appendChild(n),t.appendChild(s),t.appendChild(p),e.appendChild(t)}()},e.playNote=function(e,n){try{if(!T)return;C&&C.context===T||((C=T.createGain()).gain.value=c?c.value:.5,C.connect(T.destination));var a=T.currentTime,o=.5,i=1,r=.5,l=document.getElementById("drums-type"),u=document.getElementById("drums-pitch"),s=document.getElementById("drums-decay"),d=l?l.value:"kick";u&&(i=parseFloat(u.value)),s&&(r=parseFloat(s.value));for(var m=T.createBufferSource(),p=T.createGain(),y=T.createBiquadFilter(),v=2*T.sampleRate,f=T.createBuffer(1,v,T.sampleRate),g=f.getChannelData(0),h=0;h<v;h++)g[h]=2*Math.random()-1;m.buffer=f,m.loop=!0;var E=T.createOscillator(),b=T.createGain();if("kick"===d)E.type="sine",E.frequency.setValueAtTime(n*i,a),E.frequency.exponentialRampToValueAtTime(.01,a+r),b.gain.setValueAtTime(o,a),b.gain.exponentialRampToValueAtTime(.01,a+r),E.connect(b),b.connect(C),E.start(a),E.stop(a+r),t[e]={oscillator:E,gainNode:b};else if("snare"===d)E.type="triangle",E.frequency.setValueAtTime(n*i,a),b.gain.setValueAtTime(.25,a),b.gain.exponentialRampToValueAtTime(.01,a+r),y.type="highpass",y.frequency.value=1e3+n/100,p.gain.setValueAtTime(.25,a),p.gain.exponentialRampToValueAtTime(.01,a+r),E.connect(b),m.connect(y),y.connect(p),b.connect(C),p.connect(C),E.start(a),m.start(a),t[e]={oscillator:E,gainNode:b,noiseBuffer:m,noiseGain:p};else if("tom"===d)E.type="square",E.frequency.setValueAtTime(n*i,a),E.frequency.exponentialRampToValueAtTime(.01,a+r),b.gain.setValueAtTime(o,a),b.gain.exponentialRampToValueAtTime(.01,a+r),E.connect(b),b.connect(C),E.start(a),E.stop(a+r),t[e]={oscillator:E,gainNode:b};else if("hihat"===d){const o=T.createBufferSource(),l=.5*T.sampleRate,c=T.createBuffer(1,l,T.sampleRate),u=c.getChannelData(0);for(let e=0;e<l;e++)u[e]=2*Math.random()-1;o.buffer=c;const s=T.createOscillator();s.type="square";const d=n*i;s.frequency.value=d;const m=T.createBiquadFilter();m.type="bandpass",m.frequency.value=d,m.Q.value=10;const p=T.createBiquadFilter();p.type="highpass",p.frequency.value=8e3;const y=T.createGain(),v=T.createGain(),f=T.createGain();y.gain.value=.3,v.gain.value=.2,f.gain.setValueAtTime(.25,a),f.gain.exponentialRampToValueAtTime(.01,a+.2*r),o.connect(p),p.connect(y),y.connect(f),s.connect(m),m.connect(v),v.connect(f),f.connect(C),o.start(a),s.start(a),o.stop(a+.3*r),s.stop(a+.3*r),t[e]={noiseSource:o,oscillator:s,gain:f}}else"cymbal"===d&&(y.type="highpass",y.frequency.value=3e3+n/15,p.gain.setValueAtTime(.2,a),p.gain.exponentialRampToValueAtTime(.01,a+2*r),m.connect(y),y.connect(p),p.connect(C),m.start(a),t[e]={noiseBuffer:m,noiseGain:p})}catch(e){console.error("Error playing drum note:",e)}},e.stopNote=function(e){var n=t[e];if(n)try{var a=T.currentTime,o=.05;if(n.oscillator)try{n.oscillator.stop(a+o)}catch(e){}if(n.noiseBuffer)try{n.noiseBuffer.stop(a+o)}catch(e){}if(n.noiseSource)try{n.noiseSource.stop(a+o)}catch(e){}n.gainNode&&(n.gainNode.gain.cancelScheduledValues(a),n.gainNode.gain.setValueAtTime(n.gainNode.gain.value,a),n.gainNode.gain.exponentialRampToValueAtTime(.01,a+o)),n.noiseGain&&(n.noiseGain.gain.cancelScheduledValues(a),n.noiseGain.gain.setValueAtTime(n.noiseGain.gain.value,a),n.noiseGain.gain.exponentialRampToValueAtTime(.01,a+o)),n.gain&&(n.gain.gain.cancelScheduledValues(a),n.gain.gain.setValueAtTime(n.gain.gain.value,a),n.gain.gain.exponentialRampToValueAtTime(.01,a+o)),delete t[e]}catch(n){console.error("Error stopping drum note:",n),delete t[e]}},e.render=function(e,t,n,a,o){for(var i=document.getElementById("drums-type"),r=document.getElementById("drums-pitch"),l=document.getElementById("drums-decay"),c=i?i.value:"kick",u=r?parseFloat(r.value):1,s=l?parseFloat(l.value):.5,d=2*e.sampleRate,m=e.createBuffer(1,d,e.sampleRate),p=m.getChannelData(0),y=0;y<d;y++)p[y]=2*Math.random()-1;if("kick"===c){var v=e.createOscillator(),f=e.createGain();v.type="sine",v.frequency.setValueAtTime(t.freq*u,n),v.frequency.exponentialRampToValueAtTime(.01,n+s),f.gain.setValueAtTime(.7,n),f.gain.exponentialRampToValueAtTime(.01,n+s),v.connect(f),f.connect(o),v.start(n),v.stop(n+s)}else if("snare"===c){v=e.createOscillator(),f=e.createGain();var g=e.createBufferSource(),h=e.createGain(),E=e.createBiquadFilter();g.buffer=m,v.type="triangle",v.frequency.value=t.freq*u,E.type="highpass",E.frequency.value=5e3,f.gain.setValueAtTime(.5,n),h.gain.setValueAtTime(.5,n),f.gain.exponentialRampToValueAtTime(.01,n+s),h.gain.exponentialRampToValueAtTime(.01,n+s),v.connect(f),g.connect(E),E.connect(h),f.connect(o),h.connect(o),v.start(n),g.start(n),v.stop(n+s),g.stop(n+s)}else if("hihat"===c||"cymbal"===c){v=e.createOscillator();(g=e.createBufferSource()).buffer=m;var b=e.createBiquadFilter();b.type="bandpass",b.frequency.value=t.freq*u,b.Q.value=10,(E=e.createBiquadFilter()).type="highpass",E.frequency.value="hihat"===c?8e3:3e3;f=e.createGain(),h=e.createGain();var x=e.createGain();f.gain.value="hihat"===c?.2:.3,h.gain.value="hihat"===c?.3:.4;var q="hihat"===c?.2*s:2*s;x.gain.setValueAtTime(.7,n),x.gain.exponentialRampToValueAtTime(.01,n+q),g.connect(E),E.connect(h),h.connect(x),v.connect(b),b.connect(f),f.connect(x),x.connect(o),v.start(n),g.start(n),v.stop(n+q),g.stop(n+q)}else{v=e.createOscillator(),f=e.createGain();v.type="square",v.frequency.setValueAtTime(t.freq*u,n),v.frequency.exponentialRampToValueAtTime(.01,n+s),f.gain.setValueAtTime(.7,n),f.gain.exponentialRampToValueAtTime(.01,n+s),v.connect(f),f.connect(o),v.start(n),v.stop(n+s)}},e.cleanup=function(){document.body.classList.remove("drums-theme"),function(){var e=document.getElementById("drums-controls");e&&e.parentNode.removeChild(e);document.querySelector(".wave-selector").style.display="inline-flex"}()},e}},J={create:function(){var e=U("Bell");return e.init=function(){document.body.classList.add("bell-theme"),function(){document.querySelector(".wave-selector").style.display="none";var e=document.querySelector(".control-bar"),t=document.createElement("div");t.id="bell-controls",t.style.display="inline-flex",t.style.marginLeft="10px";var n=document.createElement("div");n.className="control-group",n.style.marginRight="10px";var a=document.createElement("label");a.textContent="Decay",a.id="bell-decay-label",a.style.marginBottom="5px",a.style.fontSize="0.8em";var o=document.createElement("input");o.type="range",o.id="bell-decay",o.min="0.5",o.max="5.0",o.step="0.1",o.value="2.5",o.style.width="100px",n.appendChild(a),n.appendChild(o);var i=document.createElement("div");i.className="control-group";var r=document.createElement("label");r.textContent="Bright",r.id="bell-brightness-label",r.style.marginBottom="5px",r.style.fontSize="0.8em";var l=document.createElement("input");l.type="range",l.id="bell-brightness",l.min="0",l.max="1",l.step="0.1",l.value="0.5",l.style.width="100px",i.appendChild(r),i.appendChild(l),t.appendChild(n),t.appendChild(i),e.appendChild(t)}()},e.playNote=function(e,t){try{if(!T)return void console.error("Audio context not initialized");var n=T.currentTime;C&&C.context===T||((C=T.createGain()).gain.value=c?parseFloat(c.value):.5,C.connect(T.destination));var a=document.getElementById("bell-decay"),o=document.getElementById("bell-brightness"),i=a?parseFloat(a.value):2.5,r=o?parseFloat(o.value):.5,l=t,u=2.4*t,s=5.95*t,d=8.2*t,m=.3*r,p=.2*r,y=.1*r,v=T.createOscillator(),f=T.createOscillator(),g=T.createOscillator(),h=T.createOscillator(),E=T.createGain(),b=T.createGain(),x=T.createGain(),q=T.createGain(),w=T.createGain();w.gain.value=.8,v.frequency.value=l,f.frequency.value=u,g.frequency.value=s,h.frequency.value=d,v.type="sine",f.type="sine",g.type="sine",h.type="sine",E.gain.setValueAtTime(0,n),E.gain.linearRampToValueAtTime(.5,n+.01),E.gain.exponentialRampToValueAtTime(.001,n+i),b.gain.setValueAtTime(0,n),b.gain.linearRampToValueAtTime(m,n+.01),b.gain.exponentialRampToValueAtTime(.001,n+.8*i),x.gain.setValueAtTime(0,n),x.gain.linearRampToValueAtTime(p,n+.01),x.gain.exponentialRampToValueAtTime(.001,n+.6*i),q.gain.setValueAtTime(0,n),q.gain.linearRampToValueAtTime(y,n+.01),q.gain.exponentialRampToValueAtTime(.001,n+.4*i),v.connect(E),f.connect(b),g.connect(x),h.connect(q),E.connect(w),b.connect(w),x.connect(w),q.connect(w),w.connect(C),v.start(n),f.start(n),g.start(n),h.start(n),v.stop(n+i+.1),f.stop(n+i+.1),g.stop(n+i+.1),h.stop(n+i+.1),A[e]={masterGain:w,oscillators:[v,f,g,h]}}catch(e){console.error("Error playing bell note:",e)}},e.stopNote=function(e){var t=A[e];if(t)try{var n=T.currentTime;t.masterGain&&(t.masterGain.gain.cancelScheduledValues(n),t.masterGain.gain.setValueAtTime(t.masterGain.gain.value,n),t.masterGain.gain.linearRampToValueAtTime(0,n+.05)),t.oscillators&&t.oscillators.forEach(function(e){e.stop(n+.05)}),delete A[e]}catch(t){console.error("Error stopping bell note:",t),delete A[e]}},e.render=function(e,t,n,a,o){var i=document.getElementById("bell-decay"),r=document.getElementById("bell-brightness"),l=i?parseFloat(i.value):2.5,c=r?parseFloat(r.value):.5,u=t.freq,s=[{f:u,g:.5},{f:2.4*u,g:.3*c},{f:5.95*u,g:.2*c},{f:8.2*u,g:.1*c}],d=e.createGain();d.gain.value=.8,d.connect(o);for(var m=0;m<s.length;m++){var p=e.createOscillator(),y=e.createGain();p.type="sine",p.frequency.value=s[m].f,y.gain.setValueAtTime(0,n),y.gain.linearRampToValueAtTime(s[m].g,n+.01),y.gain.exponentialRampToValueAtTime(.001,n+l*(1-.1*m)),p.connect(y),y.connect(d),p.start(n),p.stop(n+l+.1)}},e.cleanup=function(){document.body.classList.remove("bell-theme"),function(){var e=document.getElementById("bell-controls");e&&e.parentNode.removeChild(e);document.querySelector(".wave-selector").style.display="inline-flex"}()},e}},K={create:function(){var e=U("Flute");return e.init=function(){document.body.classList.add("flute-theme"),function(){document.querySelector(".wave-selector").style.display="none";var e=document.querySelector(".control-bar"),t=document.createElement("div");t.id="flute-controls",t.style.display="inline-flex",t.style.marginLeft="10px";var n=document.createElement("div");n.className="control-group",n.style.marginRight="10px";var a=document.createElement("label");a.textContent="Breath",a.id="flute-breath-label",a.style.marginBottom="5px",a.style.fontSize="0.8em";var o=document.createElement("input");o.type="range",o.id="flute-breath",o.min="0",o.max="0.5",o.step="0.01",o.value="0.1",o.style.width="100px",o.addEventListener("input",function(){document.getElementById("flute-breath-label").textContent="Breath"}),n.appendChild(a),n.appendChild(o);var i=document.createElement("div");i.className="control-group";var r=document.createElement("label");r.textContent="Vibrato",r.id="flute-vibrato-label",r.style.marginBottom="5px",r.style.fontSize="0.8em";var l=document.createElement("input");l.type="range",l.id="flute-vibrato",l.min="0",l.max="10",l.step="0.5",l.value="5",l.style.width="100px",l.addEventListener("input",function(){document.getElementById("flute-vibrato-label").textContent="Vibrato"}),i.appendChild(r),i.appendChild(l),t.appendChild(n),t.appendChild(i),e.appendChild(t)}()},e.playNote=function(e,t){try{var n=T.currentTime;if(!C||C.context!==T){if(!T)return;(C=T.createGain()).gain.value=c?c.value:.5,C.connect(T.destination)}var a=document.getElementById("flute-breath"),o=document.getElementById("flute-vibrato"),i=a?parseFloat(a.value):.1,r=o?parseFloat(o.value):5,l=T.createOscillator();l.type="triangle",l.frequency.setValueAtTime(t,n);var u=null,s=null;r>0&&((u=T.createOscillator()).type="sine",u.frequency.value=r,(s=T.createGain()).gain.value=3,u.connect(s),s.connect(l.frequency),u.start(n));var d=null,m=null,p=null;if(i>0){d=T.createBufferSource();for(var y=2*T.sampleRate,v=T.createBuffer(1,y,T.sampleRate),f=v.getChannelData(0),g=0;g<y;g++)f[g]=2*Math.random()-1;d.buffer=v,d.loop=!0,(m=T.createBiquadFilter()).type="highpass",m.frequency.value=1e3,(p=T.createGain()).gain.setValueAtTime(i,n),p.gain.exponentialRampToValueAtTime(.001,n+.3),d.connect(m),m.connect(p),p.connect(C),d.start(n)}var h=T.createGain();h.gain.setValueAtTime(0,n),h.gain.linearRampToValueAtTime(.3,n+.1),h.gain.linearRampToValueAtTime(.25,n+.2),h.gain.linearRampToValueAtTime(.3,n+.4),l.connect(h),h.connect(C),l.start(n),A[e]={osc:l,mainGain:h,lfo:u,lfoGain:s,noiseNode:d}}catch(e){console.error("Error playing flute note:",e)}},e.stopNote=function(e){var t=A[e];if(t)try{var n=T.currentTime,a=.3;if(t.lfo&&t.lfo.stop(n+a),t.noiseNode)try{t.noiseNode.stop(n+a)}catch(e){}t.mainGain&&(t.mainGain.gain.cancelScheduledValues(n),t.mainGain.gain.setValueAtTime(t.mainGain.gain.value,n),t.mainGain.gain.exponentialRampToValueAtTime(.001,n+a),t.osc.stop(n+a)),delete A[e]}catch(t){console.error("Error stopping flute note:",t),delete A[e]}},e.render=function(e,t,n,a,o){var i=document.getElementById("flute-breath"),r=document.getElementById("flute-vibrato"),l=i?parseFloat(i.value):.1,c=r?parseFloat(r.value):5,u=t.freq,s=e.createOscillator();if(s.type="triangle",s.frequency.setValueAtTime(u,n),c>0){var d=e.createOscillator();d.type="sine",d.frequency.value=c;var m=e.createGain();m.gain.value=3,d.connect(m),m.connect(s.frequency),d.start(n),d.stop(n+a+.5)}if(l>0){for(var p=e.createBufferSource(),y=.5*e.sampleRate,v=e.createBuffer(1,y,e.sampleRate),f=v.getChannelData(0),g=0;g<y;g++)f[g]=2*Math.random()-1;p.buffer=v,p.loop=!0;var h=e.createBiquadFilter();h.type="highpass",h.frequency.value=1e3;var E=e.createGain();E.gain.setValueAtTime(l,n),E.gain.exponentialRampToValueAtTime(.001,n+.3),p.connect(h),h.connect(E),E.connect(o),p.start(n),p.stop(n+.5)}var b=e.createGain();b.gain.setValueAtTime(0,n),b.gain.linearRampToValueAtTime(.3,n+.1),b.gain.linearRampToValueAtTime(.25,n+.2),b.gain.linearRampToValueAtTime(.3,n+.4);b.gain.setValueAtTime(.3,n+a),b.gain.exponentialRampToValueAtTime(.001,n+a+.3),s.connect(b),b.connect(o),s.start(n),s.stop(n+a+.3)},e.cleanup=function(){document.body.classList.remove("flute-theme"),function(){var e=document.getElementById("flute-controls");e&&e.parentNode.removeChild(e);document.querySelector(".wave-selector").style.display="inline-flex"}()},e}},X={create:function(){var e=U("Violin");return e.init=function(){document.body.classList.add("violin-theme"),function(){document.querySelector(".wave-selector").style.display="none";var e=document.querySelector(".control-bar"),t=document.createElement("div");t.id="violin-controls",t.style.display="inline-flex",t.style.marginLeft="10px";var n=document.createElement("div");n.className="control-group",n.style.marginRight="10px";var a=document.createElement("label");a.textContent="Attack",a.id="violin-attack-label",a.style.marginBottom="5px",a.style.fontSize="0.8em";var o=document.createElement("input");o.type="range",o.id="violin-attack",o.min="0.05",o.max="0.5",o.step="0.01",o.value="0.2",o.style.width="100px",o.addEventListener("input",function(){document.getElementById("violin-attack-label").textContent="Attack"}),n.appendChild(a),n.appendChild(o);var i=document.createElement("div");i.className="control-group",i.style.marginRight="10px";var r=document.createElement("label");r.textContent="Vib Rate",r.id="violin-vibrato-label",r.style.marginBottom="5px",r.style.fontSize="0.8em";var l=document.createElement("input");l.type="range",l.id="violin-vibrato",l.min="0",l.max="12",l.step="0.5",l.value="6",l.style.width="100px",l.addEventListener("input",function(){document.getElementById("violin-vibrato-label").textContent="Vib Rate"}),i.appendChild(r),i.appendChild(l);var c=document.createElement("div");c.className="control-group";var u=document.createElement("label");u.textContent="Filter",u.id="violin-filter-label",u.style.marginBottom="5px",u.style.fontSize="0.8em";var s=document.createElement("input");s.type="range",s.id="violin-filter",s.min="500",s.max="5000",s.step="100",s.value="2500",s.style.width="100px",s.addEventListener("input",function(){document.getElementById("violin-filter-label").textContent="Filter"}),c.appendChild(u),c.appendChild(s),t.appendChild(n),t.appendChild(i),t.appendChild(c),e.appendChild(t)}()},e.playNote=function(e,t){try{var n=T.currentTime;if(!C||C.context!==T){if(!T)return;(C=T.createGain()).gain.value=c?c.value:.5,C.connect(T.destination)}var a=document.getElementById("violin-attack"),o=document.getElementById("violin-vibrato"),i=document.getElementById("violin-filter"),r=a?parseFloat(a.value):.2,l=o?parseFloat(o.value):6,u=i?parseFloat(i.value):2500,s=T.createOscillator();s.type="sawtooth",s.frequency.setValueAtTime(t,n),s.start(n);var d=null,m=null;l>0&&((d=T.createOscillator()).type="sine",d.frequency.value=l,(m=T.createGain()).gain.value=8,d.connect(m),m.connect(s.frequency),d.start(n));var p=T.createBiquadFilter();p.type="lowpass",p.frequency.value=u,p.Q.value=1;for(var y=T.createConvolver(),v=T.createGain(),f=T.createGain(),g=1.5*T.sampleRate,h=T.createBuffer(2,g,T.sampleRate),E=0;E<2;E++)for(var b=h.getChannelData(E),x=0;x<g;x++)b[x]=(2*Math.random()-1)*Math.pow(1-x/g,2);y.buffer=h,v.gain.value=.4,f.gain.value=.6,s.connect(p),p.connect(f),p.connect(v),f.connect(C),v.connect(y),y.connect(C);var q=T.createGain();q.gain.setValueAtTime(0,n),q.gain.linearRampToValueAtTime(.4,n+r),s.disconnect(),s.connect(q),q.connect(p),A[e]={osc:s,masterGain:q,lfo:d,lfoGain:m}}catch(e){console.error("Error playing violin note:",e);try{s&&s.stop()}catch(e){}}},e.stopNote=function(e){var t=A[e];if(t&&!t.isStopping){t.isStopping=!0;try{var n=T.currentTime,a=.4;try{t.lfo&&t.lfo.stop(n+a)}catch(e){}if(t.masterGain){t.masterGain.gain.cancelScheduledValues(n),t.masterGain.gain.setValueAtTime(t.masterGain.gain.value,n),t.masterGain.gain.exponentialRampToValueAtTime(.001,n+a);try{t.osc.stop(n+a)}catch(e){}}setTimeout(function(){A[e]&&A[e].isStopping&&(delete A[e],qe(e))},400)}catch(t){console.error("Error stopping violin note:",t),delete A[e],qe(e)}}},e.render=function(e,t,n,a,o){var i=document.getElementById("violin-attack"),r=document.getElementById("violin-vibrato"),l=document.getElementById("violin-filter"),c=i?parseFloat(i.value):.2,u=r?parseFloat(r.value):6,s=l?parseFloat(l.value):2500,d=t.freq,m=e.createOscillator();if(m.type="sawtooth",m.frequency.setValueAtTime(d,n),u>0){var p=e.createOscillator();p.type="sine",p.frequency.value=u;var y=e.createGain();y.gain.value=8,p.connect(y),y.connect(m.frequency),p.start(n),p.stop(n+a+.5)}var v=e.createBiquadFilter();v.type="lowpass",v.frequency.value=s,v.Q.value=1;for(var f=e.createConvolver(),g=e.createGain(),h=e.createGain(),E=1.5*e.sampleRate,b=e.createBuffer(2,E,e.sampleRate),x=0;x<2;x++)for(var q=b.getChannelData(x),T=0;T<E;T++)q[T]=(2*Math.random()-1)*Math.pow(1-T/E,2);f.buffer=b,g.gain.value=.4,h.gain.value=.6,m.connect(v),v.connect(h),v.connect(g),h.connect(o),g.connect(f),f.connect(o);var C=e.createGain();C.gain.setValueAtTime(0,n),C.gain.linearRampToValueAtTime(.4,n+c);C.gain.setValueAtTime(.4,n+a),C.gain.exponentialRampToValueAtTime(.001,n+a+.4),m.disconnect(),m.connect(C),C.connect(v),m.start(n),m.stop(n+a+.4)},e.cleanup=function(){document.body.classList.remove("violin-theme"),function(){var e=document.getElementById("violin-controls");e&&e.parentNode.removeChild(e);document.querySelector(".wave-selector").style.display="inline-flex"}()},e}},Y={create:function(){var e=U("Ukulele");return e.init=function(){document.body.classList.add("ukulele-theme"),function(){document.querySelector(".wave-selector").style.display="none";var e=document.querySelector(".control-bar"),t=document.createElement("div");t.id="ukulele-controls",t.style.display="inline-flex",t.style.marginLeft="10px";var n=document.createElement("div");n.className="control-group",n.style.marginRight="10px";var a=document.createElement("label");a.textContent="Decay",a.id="ukulele-decay-label",a.style.marginBottom="5px",a.style.fontSize="0.8em";var o=document.createElement("input");o.type="range",o.id="ukulele-decay",o.min="0.1",o.max="1.5",o.step="0.1",o.value="0.8",o.style.width="100px",o.addEventListener("input",function(){document.getElementById("ukulele-decay-label").textContent="Decay"}),n.appendChild(a),n.appendChild(o);var i=document.createElement("div");i.className="control-group";var r=document.createElement("label");r.textContent="Nylon",r.id="ukulele-nylon-label",r.style.marginBottom="5px",r.style.fontSize="0.8em";var l=document.createElement("input");l.type="range",l.id="ukulele-nylon",l.min="2",l.max="10",l.step="0.5",l.value="4",l.style.width="100px",l.addEventListener("input",function(){document.getElementById("ukulele-nylon-label").textContent="Nylon"}),i.appendChild(r),i.appendChild(l),t.appendChild(n),t.appendChild(i),e.appendChild(t)}()},e.playNote=function(e,t){try{var n=T.currentTime;if(!C||C.context!==T){if(!T)return;(C=T.createGain()).gain.value=c?c.value:.5,C.connect(T.destination)}var a=document.getElementById("ukulele-decay"),o=document.getElementById("ukulele-nylon"),i=a?parseFloat(a.value):.8,r=o?parseFloat(o.value):4,l=T.createOscillator();l.type="sawtooth",l.frequency.setValueAtTime(t,n),l.start(n);var u=T.createOscillator();u.type="sine",u.frequency.setValueAtTime(2.5*t,n),u.start(n);var s=T.createGain();s.gain.value=.1;var d=T.createBiquadFilter();d.type="lowpass",d.frequency.value=t*r,d.Q.value=1.5;for(var m=T.createBufferSource(),p=T.createBuffer(1,.05*T.sampleRate,T.sampleRate),y=p.getChannelData(0),v=0;v<p.length;v++)y[v]=.3*(2*Math.random()-1);m.buffer=p;var f=T.createGain();m.connect(f),f.connect(d),m.start(n),f.gain.setValueAtTime(.2,n),f.gain.exponentialRampToValueAtTime(.01,n+.05);var g=T.createGain();l.connect(g),u.connect(s),s.connect(g),g.connect(d),d.connect(C),g.gain.setValueAtTime(0,n),g.gain.linearRampToValueAtTime(.4,n+.02),g.gain.exponentialRampToValueAtTime(.001,n+i),A[e]={osc:l,harmonic1:u,masterGain:g,pluckNoise:m}}catch(e){console.error("Error playing ukulele note:",e)}},e.stopNote=function(e){var t=A[e];if(t&&!t.isStopping){t.isStopping=!0;try{var n=T.currentTime,a=.1;try{t.osc&&t.osc.stop(n+a),t.harmonic1&&t.harmonic1.stop(n+a)}catch(e){}if(t.pluckNoise)try{t.pluckNoise.stop(n+a)}catch(e){}t.masterGain&&(t.masterGain.gain.cancelScheduledValues(n),t.masterGain.gain.setValueAtTime(t.masterGain.gain.value,n),t.masterGain.gain.exponentialRampToValueAtTime(.001,n+a)),setTimeout(function(){A[e]===t&&(delete A[e],qe(e))},100)}catch(t){console.error("Error stopping ukulele note:",t),delete A[e],qe(e)}}},e.render=function(e,t,n,a,o){var i=document.getElementById("ukulele-decay"),r=document.getElementById("ukulele-nylon"),l=(i&&parseFloat(i.value),r?parseFloat(r.value):4),c=t.freq,u=e.createOscillator();u.type="sawtooth",u.frequency.value=c;var s=e.createOscillator();s.type="sine",s.frequency.value=2.5*c;var d=e.createGain();d.gain.value=.1;var m=e.createBiquadFilter();m.type="lowpass",m.frequency.value=c*l,m.Q.value=1.5;var p=e.createGain();u.connect(p),s.connect(d),d.connect(p),p.connect(m),m.connect(o);p.gain.setValueAtTime(0,n),p.gain.linearRampToValueAtTime(.4,n+.02),p.gain.setValueAtTime(.4,n+a),p.gain.exponentialRampToValueAtTime(.001,n+a+.1),u.start(n),s.start(n),u.stop(n+a+.1),s.stop(n+a+.1)},e.cleanup=function(){document.body.classList.remove("ukulele-theme"),function(){var e=document.getElementById("ukulele-controls");e&&e.parentNode.removeChild(e);document.querySelector(".wave-selector").style.display="inline-flex"}()},e}},$={create:function(){var e=U("Tuba");return e.init=function(){document.body.classList.add("tuba-theme"),function(){document.querySelector(".wave-selector").style.display="none";var e=document.querySelector(".control-bar"),t=document.createElement("div");t.id="tuba-controls",t.style.display="inline-flex",t.style.marginLeft="10px";var n=document.createElement("div");n.className="control-group",n.style.marginRight="10px";var a=document.createElement("label");a.textContent="Attack",a.id="tuba-attack-label",a.style.marginBottom="5px",a.style.fontSize="0.8em";var o=document.createElement("input");o.type="range",o.id="tuba-attack",o.min="0.05",o.max="0.5",o.step="0.01",o.value="0.2",o.style.width="100px",o.addEventListener("input",function(){document.getElementById("tuba-attack-label").textContent="Attack"}),n.appendChild(a),n.appendChild(o);var i=document.createElement("div");i.className="control-group",i.style.marginRight="10px";var r=document.createElement("label");r.textContent="Release",r.id="tuba-release-label",r.style.marginBottom="5px",r.style.fontSize="0.8em";var l=document.createElement("input");l.type="range",l.id="tuba-release",l.min="0.1",l.max="1.0",l.step="0.05",l.value="0.4",l.style.width="100px",l.addEventListener("input",function(){document.getElementById("tuba-release-label").textContent="Release"}),i.appendChild(r),i.appendChild(l);var c=document.createElement("div");c.className="control-group",c.style.marginRight="10px";var u=document.createElement("label");u.textContent="Bright",u.id="tuba-brilliance-label",u.style.marginBottom="5px",u.style.fontSize="0.8em";var s=document.createElement("input");s.type="range",s.id="tuba-brilliance",s.min="1",s.max="8",s.step="0.1",s.value="2.5",s.style.width="100px",s.addEventListener("input",function(){document.getElementById("tuba-brilliance-label").textContent="Bright"}),c.appendChild(u),c.appendChild(s);var d=document.createElement("div");d.className="control-group";var m=document.createElement("label");m.textContent="Vibrato",m.id="tuba-vibrato-label",m.style.marginBottom="5px",m.style.fontSize="0.8em";var p=document.createElement("input");p.type="range",p.id="tuba-vibrato",p.min="0",p.max="10",p.step="0.5",p.value="4",p.style.width="100px",p.addEventListener("input",function(){document.getElementById("tuba-vibrato-label").textContent="Vibrato"}),d.appendChild(m),d.appendChild(p),t.appendChild(n),t.appendChild(i),t.appendChild(c),t.appendChild(d),e.appendChild(t)}()},e.playNote=function(e,t){try{var n=T.currentTime;if(!C||C.context!==T){if(!T)return;(C=T.createGain()).gain.value=c?c.value:.5,C.connect(T.destination)}var a=document.getElementById("tuba-attack"),o=document.getElementById("tuba-release"),i=document.getElementById("tuba-brilliance"),r=document.getElementById("tuba-vibrato"),l=a?parseFloat(a.value):.2,u=o?parseFloat(o.value):.4,s=i?parseFloat(i.value):2.5,d=r?parseFloat(r.value):4,m=T.createOscillator();m.type="sawtooth",m.frequency.setValueAtTime(t,n),m.start(n);var p=T.createOscillator();p.type="sawtooth",p.frequency.setValueAtTime(1.005*t,n),p.start(n);var y=T.createOscillator();y.type="sine",y.frequency.value=d;var v=T.createGain();v.gain.value=6,y.connect(v),v.connect(m.frequency),v.connect(p.frequency),y.start(n);var f=T.createBiquadFilter();f.type="lowpass",f.frequency.value=t*s,f.Q.value=1;var g=T.createGain();g.gain.value=.5;var h=T.createGain();h.gain.value=.5,m.connect(g),p.connect(h),g.connect(f),h.connect(f);var E=T.createGain();f.connect(E),E.connect(C),E.gain.setValueAtTime(0,n),E.gain.linearRampToValueAtTime(.5,n+l),A[e]={osc1:m,osc2:p,lfo:y,masterGain:E,releaseTime:u}}catch(e){console.error("Error playing tuba note:",e)}},e.stopNote=function(e){var t=A[e];if(t&&!t.isStopping){t.isStopping=!0;try{var n=T.currentTime,a=t.releaseTime||.4;try{t.osc1&&t.osc1.stop(n+a),t.osc2&&t.osc2.stop(n+a),t.lfo&&t.lfo.stop(n+a)}catch(e){}t.masterGain&&(t.masterGain.gain.cancelScheduledValues(n),t.masterGain.gain.setValueAtTime(t.masterGain.gain.value,n),t.masterGain.gain.exponentialRampToValueAtTime(.001,n+a)),setTimeout(function(){A[e]&&A[e].isStopping&&(delete A[e],qe(e))},1e3*a)}catch(t){console.error("Error stopping tuba note:",t),delete A[e],qe(e)}}},e.render=function(e,t,n,a,o){var i=document.getElementById("tuba-attack"),r=document.getElementById("tuba-release"),l=document.getElementById("tuba-brilliance"),c=document.getElementById("tuba-vibrato"),u=i?parseFloat(i.value):.2,s=r?parseFloat(r.value):.4,d=l?parseFloat(l.value):2.5,m=c?parseFloat(c.value):4,p=t.freq,y=e.createOscillator();y.type="sawtooth",y.frequency.setValueAtTime(p,n);var v=e.createOscillator();v.type="sawtooth",v.frequency.setValueAtTime(1.005*p,n);var f=e.createOscillator();f.type="sine",f.frequency.value=m;var g=e.createGain();g.gain.value=6,f.connect(g),g.connect(y.frequency),g.connect(v.frequency),f.start(n),f.stop(n+a+s);var h=e.createBiquadFilter();h.type="lowpass",h.frequency.value=p*d,h.Q.value=1;var E=e.createGain();E.gain.value=.5;var b=e.createGain();b.gain.value=.5;var x=e.createGain();y.connect(E),v.connect(b),E.connect(h),b.connect(h),h.connect(x),x.connect(o),x.gain.setValueAtTime(0,n),x.gain.linearRampToValueAtTime(.5,n+u),x.gain.setValueAtTime(.5,n+a),x.gain.exponentialRampToValueAtTime(.001,n+a+s),y.start(n),v.start(n),y.stop(n+a+s),v.stop(n+a+s)},e.cleanup=function(){document.body.classList.remove("tuba-theme"),function(){var e=document.getElementById("tuba-controls");e&&e.parentNode.removeChild(e);document.querySelector(".wave-selector").style.display="inline-flex"}()},e}},_={create:function(){var e=U("Custom");return e.init=function(){document.body.classList.add("custom-theme"),function(){document.querySelector(".wave-selector").style.display="none";var e=document.querySelector(".control-bar"),t=document.createElement("div");t.id="custom-controls",t.style.display="inline-flex",t.style.marginLeft="10px",t.style.alignItems="center";var n=document.createElement("span");n.id="custom-status",n.textContent="No Sample",n.style.fontSize="0.8em",n.style.marginRight="10px",n.style.color="#aaa";var a=document.createElement("button");a.textContent="Load Audio",a.style.fontSize="0.8em",a.style.padding="5px 10px",a.style.cursor="pointer";var o=document.createElement("input");o.type="file",o.id="custom-sample-file",o.accept="audio/*",o.style.display="none",a.addEventListener("click",function(){if(!T)try{ge()}catch(e){return void console.error("Could not initialize AudioContext:",e)}o.click()}),o.addEventListener("change",function(e){var t=e.target.files[0];if(t){n.textContent="Loading...",n.style.color="yellow";var a=new FileReader;a.onload=function(e){T.decodeAudioData(e.target.result,function(e){window.customSampleBuffer=e,window.customSampleBaseFreq=261.626,n.textContent="Sample Loaded",n.style.color="#4CAF50"},function(e){console.error("Error decoding audio data",e),n.textContent="Error Decoding",n.style.color="red"})},a.readAsArrayBuffer(t)}}),t.appendChild(n),t.appendChild(a),t.appendChild(o),e.appendChild(t)}()},e.playNote=function(e,t){try{if(!window.customSampleBuffer)return;var n=T.currentTime;if(!C||C.context!==T){if(!T)return;(C=T.createGain()).gain.value=c?c.value:.5,C.connect(T.destination)}var a=T.createBufferSource();a.buffer=window.customSampleBuffer,a.loop=!0;var o=t/(window.customSampleBaseFreq||261.626);a.playbackRate.value=o;var i=T.createGain();a.connect(i),i.connect(C),a.start(n),i.gain.setValueAtTime(0,n),i.gain.linearRampToValueAtTime(.8,n+.05),i.gain.linearRampToValueAtTime(.7,n+.2),A[e]={source:a,gainNode:i}}catch(e){console.error("Error playing custom note:",e)}},e.stopNote=function(e){var t=A[e];if(t&&!t.isStopping){t.isStopping=!0;try{var n=T.currentTime;if(t.gainNode){t.gainNode.gain.cancelScheduledValues(n),t.gainNode.gain.setValueAtTime(t.gainNode.gain.value,n),t.gainNode.gain.exponentialRampToValueAtTime(.001,n+.2);try{t.source.stop(n+.2)}catch(e){}}setTimeout(function(){A[e]&&A[e].isStopping&&(delete A[e],qe(e))},200)}catch(t){console.error("Error stopping custom note:",t),delete A[e],qe(e)}}},e.render=function(e,t,n,a,o){if(window.customSampleBuffer){var i=t.freq,r=window.customSampleBaseFreq||261.626,l=e.createBufferSource();l.buffer=window.customSampleBuffer,l.loop=!0;var c=i/r;l.playbackRate.value=c;var u=e.createGain();l.connect(u),u.connect(o);u.gain.setValueAtTime(0,n),u.gain.linearRampToValueAtTime(.8,n+.05),u.gain.linearRampToValueAtTime(.7,n+.2),u.gain.setValueAtTime(.7,n+a),u.gain.exponentialRampToValueAtTime(.001,n+a+.2),l.start(n),l.stop(n+a+.2)}},e.cleanup=function(){document.body.classList.remove("custom-theme"),function(){var e=document.getElementById("custom-controls");e&&e.parentNode.removeChild(e);document.querySelector(".wave-selector").style.display="inline-flex",window.customSampleBuffer=null,window.customSampleBaseFreq=null}()},e}},Z=[{key:"",note:"C1",freq:32.703,type:"white"},{key:"",note:"C#1",freq:34.648,type:"black"},{key:"",note:"D1",freq:36.708,type:"white"},{key:"",note:"D#1",freq:38.891,type:"black"},{key:"",note:"E1",freq:41.203,type:"white"},{key:"",note:"F1",freq:43.654,type:"white"},{key:"",note:"F#1",freq:46.249,type:"black"},{key:"",note:"G1",freq:49,type:"white"},{key:"",note:"G#1",freq:51.913,type:"black"},{key:"",note:"A1",freq:55,type:"white"},{key:"",note:"A#1",freq:58.27,type:"black"},{key:"",note:"B1",freq:61.735,type:"white"},{key:"",note:"C2",freq:65.406,type:"white"},{key:"",note:"C#2",freq:69.296,type:"black"},{key:"",note:"D2",freq:73.416,type:"white"},{key:"",note:"D#2",freq:77.782,type:"black"},{key:"",note:"E2",freq:82.407,type:"white"},{key:"",note:"F2",freq:87.307,type:"white"},{key:"",note:"F#2",freq:92.499,type:"black"},{key:"",note:"G2",freq:98,type:"white"},{key:"",note:"G#2",freq:103.826,type:"black"},{key:"",note:"A2",freq:110,type:"white"},{key:"",note:"A#2",freq:116.541,type:"black"},{key:"",note:"B2",freq:123.471,type:"white"},{key:"z",note:"C3",freq:130.813,type:"white"},{key:"Z",note:"C#3",freq:138.591,type:"black"},{key:"x",note:"D3",freq:146.832,type:"white"},{key:"X",note:"D#3",freq:155.563,type:"black"},{key:"c",note:"E3",freq:164.814,type:"white"},{key:"v",note:"F3",freq:174.614,type:"white"},{key:"V",note:"F#3",freq:184.997,type:"black"},{key:"b",note:"G3",freq:196,type:"white"},{key:"B",note:"G#3",freq:207.652,type:"black"},{key:"n",note:"A3",freq:220,type:"white"},{key:"N",note:"A#3",freq:233.082,type:"black"},{key:"m",note:"B3",freq:246.942,type:"white"},{key:"a",note:"C4",freq:261.626,type:"white"},{key:"A",note:"C#4",freq:277.183,type:"black"},{key:"s",note:"D4",freq:293.665,type:"white"},{key:"S",note:"D#4",freq:311.127,type:"black"},{key:"d",note:"E4",freq:329.628,type:"white"},{key:"f",note:"F4",freq:349.228,type:"white"},{key:"F",note:"F#4",freq:369.994,type:"black"},{key:"g",note:"G4",freq:392,type:"white"},{key:"G",note:"G#4",freq:415.305,type:"black"},{key:"h",note:"A4",freq:440,type:"white"},{key:"H",note:"A#4",freq:466.164,type:"black"},{key:"j",note:"B4",freq:493.883,type:"white"},{key:"q",note:"C5",freq:523.251,type:"white"},{key:"Q",note:"C#5",freq:554.365,type:"black"},{key:"w",note:"D5",freq:587.33,type:"white"},{key:"W",note:"D#5",freq:622.254,type:"black"},{key:"e",note:"E5",freq:659.255,type:"white"},{key:"r",note:"F5",freq:698.456,type:"white"},{key:"R",note:"F#5",freq:739.989,type:"black"},{key:"t",note:"G5",freq:783.991,type:"white"},{key:"T",note:"G#5",freq:830.609,type:"black"},{key:"y",note:"A5",freq:880,type:"white"},{key:"Y",note:"A#5",freq:932.328,type:"black"},{key:"u",note:"B5",freq:987.767,type:"black"},{key:"1",note:"C6",freq:1046.502,type:"white"},{key:"",note:"C#6",freq:1108.731,type:"black"},{key:"2",note:"D6",freq:1174.659,type:"white"},{key:"",note:"D#6",freq:1244.508,type:"black"},{key:"3",note:"E6",freq:1318.51,type:"white"},{key:"4",note:"F6",freq:1396.913,type:"white"},{key:"",note:"F#6",freq:1479.978,type:"black"},{key:"5",note:"G6",freq:1567.982,type:"white"},{key:"",note:"G#6",freq:1661.219,type:"black"},{key:"6",note:"A6",freq:1760,type:"white"},{key:"",note:"A#6",freq:1864.655,type:"black"},{key:"7",note:"B6",freq:1975.533,type:"white"},{key:"",note:"C7",freq:2093.005,type:"white"},{key:"",note:"C#7",freq:2217.461,type:"black"},{key:"",note:"D7",freq:2349.318,type:"white"},{key:"",note:"D#7",freq:2489.016,type:"black"},{key:"",note:"E7",freq:2637.02,type:"white"},{key:"",note:"F7",freq:2793.826,type:"white"},{key:"",note:"F#7",freq:2959.955,type:"black"},{key:"",note:"G7",freq:3135.964,type:"white"},{key:"",note:"G#7",freq:3322.438,type:"black"},{key:"",note:"A7",freq:3520,type:"white"},{key:"",note:"A#7",freq:3729.31,type:"black"},{key:"",note:"B7",freq:3951.066,type:"white"}],ee=[Z.slice(24,30),Z.slice(30,36),Z.slice(36,42),Z.slice(42,48),Z.slice(48,54),Z.slice(54,60),Z.slice(60,66),Z.slice(66,72)],te=[Z.slice(0,12),Z.slice(12,24),Z.slice(24,36),Z.slice(36,48),Z.slice(48,60),Z.slice(60,72),Z.slice(72,84)],ne=window.innerHeight>window.innerWidth?ee:te,ae={},oe={};function ie(){S=[];for(var e=document.getElementById("gen-scale"),t=e?e.value:"major",a=document.getElementById("gen-octave"),o=a?parseInt(a.value):4,i=document.getElementById("gen-spread"),r=i?parseInt(i.value):2,l=document.getElementById("gen-tempo"),c=l?parseInt(l.value):120,u=document.getElementById("gen-complexity"),s=u?parseInt(u.value):30,d=document.getElementById("gen-bars"),m=d?parseInt(d.value):8,p=6e4/c,y=4*p,v=c>160?.6:.8,f=Math.floor(12*Math.random()),g=16.35*Math.pow(2,f/12),h={major:[0,2,4,5,7,9,11],minor:[0,2,3,5,7,8,10],penta:[0,2,4,7,9],chromatic:[0,1,2,3,4,5,6,7,8,9,10,11]},E=h[t]||h.major,b=[],x=0;x<r;x++)for(var q=0;q<E.length;q++){var T=12*(o+x)+E[q],C=g*Math.pow(2,T/12),w=Z.find(e=>Math.abs(e.freq-C)<1);w&&b.push(w)}for(var A=Math.floor(Math.random()*b.length),B=Array.from({length:4},()=>Math.floor(Math.random()*E.length)),k=0;k<m;k++){var G=k*y,R=Math.floor(k/4)%2==1,I=B[k%B.length],N=b[I%b.length];[0,2].forEach(e=>{100*Math.random()<s+10&&S.push({note:N.note,freq:N.freq,time:G+e*p,duration:.5*p})}),[0,2,4].forEach(e=>{var t=(I+e+Math.floor(b.length/3))%b.length,n=b[t];S.push({note:n.note,freq:n.freq,time:G,duration:y*v})});for(var L=c>170?4:8,F=0;F<L;F++){var D=R?s+15:s;if(100*Math.random()<D){var M=Math.max(1,Math.floor(b.length/4));(A+=Math.floor(Math.random()*(2*M+1))-M)<0&&(A=0),A>=b.length&&(A=b.length-1);var O=b[A];S.push({note:O.note,freq:O.freq,time:G+F*(y/L),duration:y/L*.8})}}}S.sort((e,t)=>e.time-t.time),n.classList.add("generating"),setTimeout(()=>n.classList.remove("generating"),500),Ge(),V?(Fe(),setTimeout(Ne,100)):Ne()}var re=document.getElementById("gen-settings-panel"),le=document.getElementById("gen-close-btn"),ce=document.getElementById("generate-melody-btn");le&&le.addEventListener("click",function(){re.classList.remove("active")}),re&&(re.addEventListener("mousedown",function(e){e.stopPropagation()}),re.addEventListener("touchstart",function(e){e.stopPropagation()})),ce&&ce.addEventListener("click",ie);var ue=document.getElementById("gen-tempo"),se=document.getElementById("gen-tempo-val");ue&&ue.addEventListener("input",function(){se.textContent=this.value});var de=document.getElementById("gen-complexity"),me=document.getElementById("gen-complexity-val");de&&de.addEventListener("input",function(){me.textContent=this.value+"%"});var pe=document.getElementById("gen-bars"),ye=document.getElementById("gen-bars-val");function ve(){if(t&&e){var n=t.querySelector(".piano-svg");if(n){var a=e.clientWidth,o=e.clientHeight,i=window.innerHeight>window.innerWidth,r=ne;if(ne=i?ee:te,JSON.stringify(r)!==JSON.stringify(ne)){for(;t.firstChild;)t.removeChild(t.firstChild);ae={},oe={},Ee(),n=t.querySelector(".piano-svg")}var l=n.getAttribute("viewBox").split(" "),c=parseFloat(l[2]),u=parseFloat(l[3]);if(0!==a&&0!==o){var s,d,m=1;if(i){var p=o/c,y=a/u;s=u*(m=Math.min(p,y)),d=c*m,t.style.transform="none"}else{p=a/c,y=o/u;s=c*(m=Math.min(p,y)),d=u*m,t.style.transform="none"}t.style.width=s+"px",t.style.height=d+"px",n.style.width="100%",n.style.height="100%",t.style.transformOrigin="center center"}}}}function fe(e){var t={default:P,gameboy:Q,guitar:j,snes:H,drums:W,bell:J,flute:K,violin:X,ukulele:Y,tuba:$,custom:_};z&&z.cleanup(),(z=t[e].InstClass?t[e].InstClass.create():t[e].create()).init();for(var n=l.querySelectorAll(".instrument-option"),a=0;a<n.length;a++)n[a].classList.remove("selected"),n[a].getAttribute("data-instrument")===e&&n[a].classList.add("selected");l.classList.remove("active")}function ge(){if(!w)return console.error("Web Audio API is not supported in this browser"),void(B=!1);if(k)DEBUG&&console.log("Audio context already initialized");else try{T||(T=new w),he(),"suspended"===T.state&&T.resume().then(function(){DEBUG&&(console.log("Audio context resumed successfully"),console.log("Audio context state after resume:",T.state))}).catch(function(e){console.error("Error resuming audio context:",e)})}catch(e){console.error("Error initializing audio context:",e),B=!1}}function he(){(C=T.createGain()).gain.value=c.value;var e=T.createDynamicsCompressor();e.threshold.value=-12,e.knee.value=0,e.ratio.value=20,e.attack.value=.001,e.release.value=.1,C.connect(e),e.connect(T.destination),k=!0,DEBUG&&(console.log("Audio context initialized successfully"),console.log("Audio context state:",T.state)),T.addEventListener("statechange",function(){DEBUG&&console.log("Audio context state changed to:",T.state),"suspended"===T.state&&T.resume().then(function(){DEBUG&&console.log("Audio context resumed after state change")}).catch(function(e){console.error("Error resuming audio context after state change:",e)})})}function Ee(){var e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("class","piano-svg");var n=50,a=.85*(Math.sqrt(3)*n),o=1/0,i=-1/0,r=1/0,l=-1/0;function c(e,t,n){for(var a=[],o=0;o<6;o++){var i=Math.PI/3*o-Math.PI/2,r=e+n*Math.cos(i),l=t+n*Math.sin(i);a.push(r+","+l)}return a.join(" ")}for(var u=0;u<ne.length;u++)for(var s=ne[u],d=u%2==1?43.75:0,m=u*a,p=0;p<s.length;p++){var y=s[p],v=d+n+87.5*p,f=m+n;v-n<o&&(o=v-n),v+n>i&&(i=v+n),f-n<r&&(r=f-n),f+n>l&&(l=f+n);var g=document.createElementNS("http://www.w3.org/2000/svg","g");g.setAttribute("class","hexagon-group");var h=document.createElementNS("http://www.w3.org/2000/svg","polygon");h.setAttribute("class","hexagon"),h.setAttribute("id",y.note),h.setAttribute("points",c(v,f,n)),h.setAttribute("data-key",y.key),h.setAttribute("data-note",y.note),h.setAttribute("data-freq",y.freq),h.setAttribute("data-note-name",y.note.replace(/[0-9]/,""));var E=document.createElementNS("http://www.w3.org/2000/svg","text");E.setAttribute("class","note-text"),E.setAttribute("x",v),E.setAttribute("y",f),E.textContent=y.note;var b=document.createElementNS("http://www.w3.org/2000/svg","text");b.setAttribute("class","note-key"),b.setAttribute("x",v),b.setAttribute("y",f+20),b.textContent="Shift"===y.key?"":y.key,g.appendChild(h),g.appendChild(E),g.appendChild(b),e.appendChild(g),ae[y.key]=y,oe[y.note]=oe[y.note]||[],oe[y.note].push(h)}var x=i-o+0,q=l-r+0;e.setAttribute("viewBox",o-0+" "+(r-0)+" "+x+" "+q),t.appendChild(e)}function be(e,t){C||(DEBUG&&console.log("Creating mainGainNode..."),(C=T.createGain()).gain.value=c.value,C.connect(T.destination)),DEBUG&&console.log("Audio context is running. Playing note:",e),A[e]&&xe(e),z&&z.playNote(e,t)}function xe(e){B&&T&&(A[e]?z&&z.stopNote(e):DEBUG&&console.log("Note is not playing:",e))}function qe(e){var t=oe[e];if(t)for(var n=0;n<t.length;n++)t[n].classList.remove("active")}function Te(e,t){if(e){var n=e.note,a=e.freq;if(function(e,t){B?(T||(DEBUG&&console.log("Creating new AudioContext..."),T=new(window.AudioContext||window.webkitAudioContext)),"suspended"===T.state?(DEBUG&&console.log("AudioContext is suspended. Resuming..."),T.resume().then(function(){DEBUG&&console.log("AudioContext resumed. Playing note:",e),be(e,t)}).catch(function(e){console.error("Error resuming audio context:",e)})):be(e,t)):console.warn("Audio is not supported in this browser")}(n,a),function(e){var t=oe[e];if(t)for(var n=0;n<t.length;n++)t[n].classList.add("active")}(n),void 0!==t&&(N[t]=e),G){var o=performance.now();null===L&&(L=o),I[n]={freq:a,startTime:o}}}}function Ce(e,t){if(e){var n=e.note;if(xe(n),qe(n),void 0!==t&&delete N[t],G&&I[n]){var a=I[n],o=performance.now()-a.startTime;o>20&&S.push({note:n,freq:a.freq,time:a.startTime-L,duration:o}),delete I[n]}}}function we(e){e.preventDefault(),M=setTimeout(function(){m.classList.add("active"),M=null,Ge(),O=!0},500)}function Ae(e){M&&(clearTimeout(M),M=null),O||function(){if(!B)return void alert("Audio playback is not supported in this browser");V?Fe():S.length>0&&Ne()}(),setTimeout(function(){O=!1},100)}function Be(e){M&&(clearTimeout(M),M=null)}function ke(){m.classList.remove("active")}function Ge(){if(y.innerHTML="",0===S.length){var e=document.createElement("div");return e.textContent="No melody recorded yet. Record a melody to see it here.",e.style.textAlign="center",e.style.padding="20px",void y.appendChild(e)}var t=document.createElement("div");t.className="note-list-header";var n=document.createElement("div");n.className="note-name",n.textContent="Note";var a=document.createElement("div");a.className="note-freq",a.textContent="Freq. (Hz)";var o=document.createElement("div");o.className="note-time",o.textContent="Time (ms)";var i=document.createElement("div");i.className="note-duration",i.textContent="Duration (ms)",t.appendChild(n),t.appendChild(a),t.appendChild(o),t.appendChild(i),y.appendChild(t);for(var r=0;r<S.length;r++){var l=S[r],c=document.createElement("div");c.className="note-item";var u=document.createElement("div");u.className="note-name",u.textContent=l.note;var s=document.createElement("div");s.className="note-freq",s.textContent=l.freq.toFixed(3);var d=document.createElement("div");d.className="note-time",d.textContent=l.time.toFixed(0);var m=document.createElement("div");m.className="note-duration",m.textContent=l.duration.toFixed(0),c.appendChild(u),c.appendChild(s),c.appendChild(d),c.appendChild(m),y.appendChild(c)}}function Ve(e){var t=e.target.files[0];if(t){var n=new FileReader;n.onload=function(e){try{var t=JSON.parse(e.target.result);if(!t.notes||!Array.isArray(t.notes))throw new Error("Invalid melody file format");S=t.notes,Ge(),alert("Melody imported successfully!")}catch(e){alert("Error importing melody: "+e.message)}},n.readAsText(t),e.target.value=""}}function Se(e){var t=e.target.files[0];if(t){k||ge(),E.classList.add("active"),x.textContent="Loading audio file...",b.style.width="10%";var n=new FileReader;n.onload=function(e){T.decodeAudioData(e.target.result).then(function(e){x.textContent="Analyzing frequencies...",b.style.width="30%";e.duration;(function(e){return new Promise(function(t,n){try{var a=e.sampleRate,o=(e.getChannelData(0),new w),i=o.createBufferSource();i.buffer=e;var r=o.createAnalyser();r.fftSize=4096,r.smoothingTimeConstant=.7,r.minDecibels=-70,r.maxDecibels=-20,i.connect(r);var l=[],c={},u={},s={},d=!1,m=100,p=25,y=a/r.fftSize,v=3,f=r.frequencyBinCount,g=new Uint8Array(f);function h(e,t){for(var n=[],a=2;a<e.length-2;a++)if(!(e[a]<t)&&e[a]>e[a-1]&&e[a]>e[a+1]&&e[a]>e[a-2]&&e[a]>e[a+2]&&e[a]>e[a-3]&&e[a]>e[a+3]){var o=a*y;o>=50&&o<=5e3&&n.push({index:a,frequency:o,amplitude:e[a]})}return n.sort(function(e,t){return t.amplitude-e.amplitude}),n.slice(0,6)}function E(){if(!d){r.getByteFrequencyData(g);for(var t=h(g,p),n=1e3*i.context.currentTime,a={},o=0;o<t.length;o++){var y=Re(t[o].frequency);y&&(a[y.note]=y)}for(var f in a)c[f]?s[f]=v:(s[f]=(s[f]||0)+1,s[f]>=v&&(c[f]=a[f],u[f]=n));for(var f in c)if(!a[f]&&(s[f]=(s[f]||v)-1,s[f]<=0)){var q=n-u[f];q>=m&&l.push({note:f,freq:c[f].freq,time:u[f],duration:q}),delete c[f],delete u[f],delete s[f]}var T=n/(1e3*e.duration)*100;b.style.width=Math.min(T,100)+"%",n<1e3*e.duration?requestAnimationFrame(E):x()}}function x(){if(!d){for(var n in d=!0,c){var a=1e3*e.duration-u[n];a>=m&&l.push({note:n,freq:c[n].freq,time:u[n],duration:a})}l.sort(function(e,t){return e.time-t.time}),i.stop(),o.close(),b.style.width="100%",t(l)}}i.start(),requestAnimationFrame(E),setTimeout(function(){d||x()},1e3*e.duration+1e3)}catch(q){n(q)}})})(e).then(function(e){x.textContent="Processing melody...",b.style.width="70%",S=e,Ge(),x.textContent="Complete!",b.style.width="100%",setTimeout(function(){E.classList.remove("active"),b.style.width="0%"},1e3)}).catch(function(e){console.error("Error analyzing audio:",e),x.textContent="Error: "+e.message,setTimeout(function(){E.classList.remove("active"),b.style.width="0%"},3e3)})}).catch(function(e){console.error("Error decoding audio data:",e),x.textContent="Error decoding audio: "+e.message,setTimeout(function(){E.classList.remove("active"),b.style.width="0%"},3e3)})},n.readAsArrayBuffer(t),e.target.value=""}}function Re(e){if(e<30||e>6e3)return null;for(var t=null,n=1/0,a=0;a<Z.length;a++){var o=Z[a],i=Math.abs(e-o.freq);i<n&&(n=i,t=o)}var r=1200*Math.log2(e/t.freq);return Math.abs(r)<50?t:null}function Ie(){if(B)if(G=!G)V&&Fe(),n.className="recording",S=[],I={},performance.now(),L=null;else{n.className="";var e=performance.now();for(var t in I)if(I.hasOwnProperty(t)){var a=I[t];S.push({note:t,freq:a.freq,time:a.startTime-L,duration:e-a.startTime})}I={},S.length>0&&Me()}else alert("Audio recording is not supported in this browser")}function Ne(){G&&Ie(),V=!0,o.style.display="none",i.style.display="block",DEBUG&&(console.log("Recorded Melody:"),console.log(S)),T||(T=new(window.AudioContext||window.webkitAudioContext)),"suspended"===T.state?(DEBUG&&console.log("Suspending playback to resume audio context..."),T.resume().then(function(){DEBUG&&console.log("Audio context resumed. Starting playback..."),Le()}).catch(function(e){console.error("Error resuming audio context:",e)})):Le()}function Le(){DEBUG&&console.log("Starting melody playback...");for(var e=0;e<S.length;e++){var t=S[e];(function(e,t,n){var a=setTimeout(function(){Te(e)},t),o=setTimeout(function(){Ce(e)},t+n);R.push(a,o)})({note:t.note,freq:t.freq},t.time,t.duration)}var n=S.length>0?Math.max.apply(Math,S.map(function(e){return e.time+e.duration})):0,a=setTimeout(Fe,n+500);R.push(a)}function Fe(){V=!1,o.style.display="block",i.style.display="none";for(var e=0;e<R.length;e++)clearTimeout(R[e]);for(var t in R=[],A)xe(t),qe(t)}function De(){document.fullscreenElement?document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen():document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.webkitRequestFullscreen?document.documentElement.webkitRequestFullscreen():document.documentElement.mozRequestFullScreen?document.documentElement.mozRequestFullScreen():document.documentElement.msRequestFullscreen&&document.documentElement.msRequestFullscreen()}function Me(){if(0===S.length||!B)return E.classList.remove("active"),void(b.style.width="0%");var e=Math.max.apply(Math,S.map(function(e){return e.time+e.duration})),t=e/1e3+.5;try{var n=new OfflineAudioContext(2,Math.ceil(44100*t),44100),a=n.createGain();a.gain.value=.7;var o=n.createDynamicsCompressor();o.threshold.value=-10,o.knee.value=0,o.ratio.value=20,o.attack.value=.001,o.release.value=.1,a.connect(o),o.connect(n.destination);for(var i=0;i<S.length;i++){var r=S[i],l=r.time/1e3,c=r.duration/1e3;c<=.01||z&&z.render(n,r,l,c,a)}x.textContent="Rendering audio file...",b.style.width="90%",n.startRendering().then(function(e){var t,n,a,o,i=function(e){var t,n,a=e.numberOfChannels,o=e.length*a*2+44,i=new ArrayBuffer(o),r=new DataView(i),l=[],c=0,u=0,s=function(e){r.setUint16(u,e,!0),u+=2},d=function(e){r.setUint32(u,e,!0),u+=4};for(d(1179011410),d(o-8),d(1163280727),d(544501094),d(16),s(1),s(a),d(e.sampleRate),d(2*e.sampleRate*a),s(2*a),s(16),d(1635017060),d(o-u-4),t=0;t<e.numberOfChannels;t++)l.push(e.getChannelData(t));for(;u<o;){for(t=0;t<a;t++)n=(n=Math.max(-1,Math.min(1,l[t][c])))<0?32768*n:32767*n,r.setInt16(u,n,!0),u+=2;c++}return new Blob([i],{type:"audio/wav"})}(e);t=i,n=`hexano_${(new Date).toISOString()}.wav`,a=URL.createObjectURL(t),(o=document.createElement("a")).style.display="none",o.href=a,o.download=n,document.body.appendChild(o),o.click(),URL.revokeObjectURL(a),o.parentNode.removeChild(o),E.classList.remove("active"),b.style.width="0%"}).catch(function(e){console.error("Failed to render WAV:",e),alert("Sorry, there was an error creating the audio file."),E.classList.remove("active"),b.style.width="0%"})}catch(e){console.error("Error generating WAV:",e),alert("Sorry, there was an error creating the audio file."),E.classList.remove("active"),b.style.width="0%"}}pe&&pe.addEventListener("input",function(){ye.textContent=this.value}),document.addEventListener("fullscreenchange",function(){var e=!!document.fullscreenElement;s.style.display=e?"none":"block",d.style.display=e?"block":"none"}),document.addEventListener("webkitfullscreenchange",function(){var e=!!document.webkitFullscreenElement;s.style.display=e?"none":"block",d.style.display=e?"block":"none"}),document.addEventListener("mozfullscreenchange",function(){var e=!!document.mozFullScreenElement;s.style.display=e?"none":"block",d.style.display=e?"block":"none"}),document.addEventListener("MSFullscreenChange",function(){var e=!!document.msFullscreenElement;s.style.display=e?"none":"block",d.style.display=e?"block":"none"}),Ee(),function(){t.addEventListener("mousedown",function(e){var t=e.target;if(t.classList.contains("hexagon")){e.preventDefault(),F=!0;var n={note:t.getAttribute("data-note"),freq:parseFloat(t.getAttribute("data-freq"))};D=n,Te(n)}}),document.addEventListener("mousemove",function(e){if(F){var t=document.elementFromPoint(e.clientX,e.clientY);if(t&&t.classList.contains("hexagon")){var n={note:t.getAttribute("data-note"),freq:parseFloat(t.getAttribute("data-freq"))};D&&D.note===n.note||(D&&Ce(D),Te(n),D=n)}}}),document.addEventListener("mouseup",function(e){if(F)for(var t in F=!1,D&&(Ce(D),D=null),A)xe(t),qe(t)}),t.addEventListener("touchstart",function(e){var t=e.target;if(t.classList.contains("hexagon")){e.preventDefault(),F=!0;var n=e.touches[0];Te({note:t.getAttribute("data-note"),freq:parseFloat(t.getAttribute("data-freq"))},n.identifier)}}),document.addEventListener("touchmove",function(e){if(F){var t=e.touches[0],n=document.elementFromPoint(t.clientX,t.clientY);if(n&&n.classList.contains("hexagon")){var a={note:n.getAttribute("data-note"),freq:parseFloat(n.getAttribute("data-freq"))},o=N[t.identifier];o&&o.note===a.note||(o&&Ce(o,t.identifier),Te(a,t.identifier))}}}),document.addEventListener("touchend",function(e){if(F){F=!1;for(var t=0;t<e.changedTouches.length;t++){var n=e.changedTouches[t],a=N[n.identifier];a&&Ce(a,n.identifier)}for(var o in A)xe(o),qe(o)}}),window.addEventListener("keydown",function(e){if(!(e.repeat||e.metaKey||e.ctrlKey)){var t=e.key,n=ae[t];n&&(e.preventDefault(),Te(n))}}),window.addEventListener("keyup",function(e){var t=e.key,n=ae[t];n&&(e.preventDefault(),Ce(n))}),n.addEventListener("mousedown",function(e){e.preventDefault(),q=setTimeout(function(){re&&re.classList.add("active"),q=null},800)}),n.addEventListener("touchstart",function(e){e.preventDefault(),q=setTimeout(function(){ie(),q=null},800)}),n.addEventListener("mouseup",function(e){q&&(clearTimeout(q),q=null,Ie())}),n.addEventListener("mouseleave",function(){q&&(clearTimeout(q),q=null)}),n.addEventListener("touchend",function(e){q&&(clearTimeout(q),q=null,Ie())}),p.addEventListener("click",ke),a.addEventListener("mousedown",we),a.addEventListener("mouseup",Ae),a.addEventListener("mouseleave",Be),a.addEventListener("touchstart",we),a.addEventListener("touchend",Ae),a.addEventListener("touchcancel",Be),r.addEventListener("click",function(e){e.stopPropagation(),l.classList.toggle("active")}),document.addEventListener("click",function(){l.classList.remove("active")});for(var e=document.querySelectorAll(".wave-option"),o=0;o<e.length;o++)e[o].addEventListener("click",function(){for(var t=0;t<e.length;t++)e[t].classList.remove("selected");this.classList.add("selected")});document.querySelector('.wave-option[data-wave-type="sine"]').classList.add("selected"),u.addEventListener("click",De),c.addEventListener("input",function(e){C&&(C.gain.value=e.target.value)}),v.addEventListener("click",function(){g.click()}),g.addEventListener("change",Ve),f.addEventListener("click",function(){h.click()}),h.addEventListener("change",Se)}(),function(){for(var e=[{id:"default",name:"Default",InstClass:P},{id:"gameboy",name:"Gameboy",InstClass:Q},{id:"guitar",name:"Guitar",InstClass:j},{id:"snes",name:"SNES",InstClass:H},{id:"drums",name:"Drums & Percussion",InstClass:W},{id:"bell",name:"Bell",InstClass:J},{id:"flute",name:"Flute",InstClass:K},{id:"violin",name:"Violin",InstClass:X},{id:"ukulele",name:"Ukulele",InstClass:Y},{id:"tuba",name:"Tuba",InstClass:$},{id:"custom",name:"Custom Sample",InstClass:_}],t=0;t<e.length;t++){var n=e[t],a=document.createElement("div");a.className="instrument-option",a.setAttribute("data-instrument",n.id),a.innerHTML=n.name,"default"===n.id&&a.classList.add("selected"),a.addEventListener("click",function(){fe(this.getAttribute("data-instrument"))}),l.appendChild(a)}z=P.create()}(),ve(),window.addEventListener("resize",ve),window.addEventListener("orientationchange",function(){setTimeout(ve,100)})})</script></head><body><div class="app-container"><div id="control-bar" class="control-bar"><button id="record-button" title="Record / Stop and Save WAV"><div id="record-indicator"></div></button> <button id="play-button" title="Play / Stop Melody"><svg id="play-icon" class="icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg> <svg id="stop-icon" class="icon" viewBox="0 0 24 24" style="display:none"><path d="M6 6h12v12H6z"/></svg></button><div class="instrument-selector"><button id="instrument-button" title="Select Instrument"><svg class="icon" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg></button><div id="instrument-dropdown" class="instrument-dropdown"></div></div><div class="wave-selector"><div class="wave-option" data-wave-type="sine" title="Sine Wave"><svg viewBox="0 0 60 30"><path d="M0,15 Q7.5,5 15,15 T30,15 T45,15 T60,15"/></svg></div><div class="wave-option" data-wave-type="square" title="Square Wave"><svg viewBox="0 0 60 30"><path d="M5,22 L15,22 L15,8 L45,8 L45,22 L55,22"/></svg></div><div class="wave-option" data-wave-type="sawtooth" title="Sawtooth Wave"><svg viewBox="0 0 60 30"><path d="M0,22 L30,8 L30,22 L60,8"/></svg></div><div class="wave-option" data-wave-type="triangle" title="Triangle Wave"><svg viewBox="0 0 60 30"><path d="M0,22 L15,8 L30,22 L45,8 L60,22"/></svg></div></div><input type="range" id="volume-slider" min="0" max="1" value="0.5" step="0.01" title="Volume"> <button id="fullscreen-button" title="Toggle Fullscreen"><svg id="fullscreen-enter-icon" class="icon" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg> <svg id="fullscreen-exit-icon" class="icon" viewBox="0 0 24 24" style="display:none"><path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/></svg></button></div><div class="hexboard-container"><div id="hexboard" class="hexboard"></div></div><div id="overlay-panel" class="overlay-panel"><button id="panel-close-btn" class="close-btn"></button><div class="panel-header"><h2>Recorded Melody</h2></div><div id="panel-content" class="panel-content"></div><div class="panel-buttons"><button id="import-json-btn" class="panel-button">Import JSON</button> <button id="import-audio-btn" class="panel-button">Import Audio</button> <button id="export-json-btn" class="panel-button">Export JSON</button> <button id="export-audio-btn" class="panel-button">Export Audio</button> <input type="file" id="file-input" accept=".json" style="display:none"> <input type="file" id="audio-file-input" accept="audio/*" style="display:none"></div></div><div id="gen-settings-panel" class="overlay-panel"><button id="gen-close-btn" class="close-btn"></button><div class="panel-header"><h2>Generator Config</h2></div><div class="panel-content" style="display:block"><div class="setting-row"><span class="setting-label">Length (Bars)</span><div class="setting-control" style="display:flex;align-items:center"><input type="range" id="gen-bars" min="1" max="100" value="4"> <span id="gen-bars-val" class="setting-value">4</span></div></div><div class="setting-row"><span class="setting-label">Scale</span><div class="setting-control"><select id="gen-scale"><option value="major">C Major</option><option value="minor">C Minor</option><option value="penta">C Pentatonic</option></select></div></div><div class="setting-row"><span class="setting-label">Base Octave</span><div class="setting-control"><select id="gen-octave"><option value="1">Octave 1</option><option value="2">Octave 2</option><option value="3">Octave 3</option><option value="4" selected="selected">Octave 4</option><option value="5">Octave 5</option><option value="6">Octave 6</option><option value="7">Octave 7</option></select></div></div><div class="setting-row"><span class="setting-label">Spread</span><div class="setting-control"><select id="gen-spread"><option value="1">1 Octave</option><option value="2" selected="selected">2 Octaves</option><option value="3">3 Octaves</option></select></div></div><div class="setting-row"><span class="setting-label">Tempo (BPM)</span><div class="setting-control" style="display:flex;align-items:center"><input type="range" id="gen-tempo" min="30" max="300" value="120"> <span id="gen-tempo-val" class="setting-value">120</span></div></div><div class="setting-row"><span class="setting-label">Complexity</span><div class="setting-control" style="display:flex;align-items:center"><input type="range" id="gen-complexity" min="0" max="100" value="30"> <span id="gen-complexity-val" class="setting-value">30%</span></div></div><div class="gen-btn-container"><button id="generate-melody-btn" class="gen-btn">Generate Melody & Play</button></div></div><div id="progress-container" class="progress-container"><div id="progress-text" class="progress-text">Processing...</div><div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div></div></div></div></body></html>
